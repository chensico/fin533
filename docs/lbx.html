<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>lbx – Buylowsellsmart</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ddd961a2510921635943dfbbd19534c4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Buylowsellsmart</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About Our Strategy</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
        
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<div id="738754f0a9afab4b" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="1ed9d21a8471467f" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2025-04-20T22:01:38.971808Z&quot;,&quot;start_time&quot;:&quot;2025-04-20T22:01:38.900348Z&quot;}">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a34c0a400bbc9b61" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cbfa04b1898077d1" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="337f0596d19d249" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2025-04-20T19:28:45.572753Z&quot;,&quot;start_time&quot;:&quot;2025-04-20T19:28:45.570773Z&quot;}">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="91f6ff06f5f80d7b" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c32f4aee2a45487a" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="96f00c192ef0fc6c" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2025-04-20T20:41:19.568158Z&quot;,&quot;start_time&quot;:&quot;2025-04-20T20:41:19.566325Z&quot;}">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="eb05c3e6f04736ce" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2025-04-20T22:55:48.970272Z&quot;,&quot;start_time&quot;:&quot;2025-04-20T22:55:04.203229Z&quot;}" data-execution_count="50">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -*- coding: utf-8 -*-</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">Buy Low / Sell High Strategy with:</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">1) Multi-parameter Tuning &amp; Advanced Visualization (From the Second Version)</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">2) Unified Exception Handling</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">3) analyze_trades Function (From the First Version, migrated and optimized)</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> functools</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ta</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shinybroker <span class="im">as</span> sb   <span class="co"># Replace with actual data interface if needed</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mpl_toolkits.mplot3d <span class="im">import</span> Axes3D</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure matplotlib settings</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>matplotlib.rcParams[<span class="st">'font.family'</span>] <span class="op">=</span> [<span class="st">'SimHei'</span>]  <span class="co"># Adjust if needed</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>matplotlib.rcParams[<span class="st">'axes.unicode_minus'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>current_date <span class="op">=</span> pd.Timestamp.now()</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Current date/time: </span><span class="sc">{</span>current_date<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 0. Unified Exception Handling Decorator</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> safe(func):</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Decorator for unified exception handling."""</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">@functools.wraps</span>(func)</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> wrapper(<span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> func(<span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error in </span><span class="sc">{</span>func<span class="sc">.</span><span class="va">__name__</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 使用更简洁的方式返回空值</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'backtest'</span> <span class="kw">in</span> func.<span class="va">__name__</span>:</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> pd.DataFrame(), []</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> pd.DataFrame() <span class="cf">if</span> <span class="st">'data'</span> <span class="kw">in</span> func.<span class="va">__name__</span> <span class="kw">or</span> <span class="st">'indicators'</span> <span class="kw">in</span> func.<span class="va">__name__</span> <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> wrapper</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Data Fetching</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a><span class="at">@safe</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fetch_asset_data(symbol, duration<span class="op">=</span><span class="st">"12 M"</span>, bar_size<span class="op">=</span><span class="st">"1 day"</span>):</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a><span class="co">    Fetch historical data for the specified symbol from shinybroker (or other data source).</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns a DataFrame with columns: [Date, Open, High, Low, Close, Volume].</span></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Fetching data for </span><span class="sc">{</span>symbol<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    asset <span class="op">=</span> sb.Contract({</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">'symbol'</span>: symbol,</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">'secType'</span>: <span class="st">"STK"</span>,</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">'exchange'</span>: <span class="st">"SMART"</span>,</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>        <span class="st">'currency'</span>: <span class="st">"USD"</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> sb.fetch_historical_data(contract<span class="op">=</span>asset, barSizeSetting<span class="op">=</span>bar_size, durationStr<span class="op">=</span>duration)[<span class="st">'hst_dta'</span>]</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>    data.reset_index(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>    data[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(data[<span class="st">'timestamp'</span>]).dt.tz_localize(<span class="va">None</span>)</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> data[data[<span class="st">'Date'</span>] <span class="op">&lt;=</span> current_date]</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> data.rename(columns<span class="op">=</span>{<span class="st">'open'</span>: <span class="st">'Open'</span>, <span class="st">'high'</span>: <span class="st">'High'</span>, <span class="st">'low'</span>: <span class="st">'Low'</span>, <span class="st">'close'</span>: <span class="st">'Close'</span>, <span class="st">'volume'</span>: <span class="st">'Volume'</span>})</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a><span class="at">@safe</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fetch_benchmark_data(benchmark<span class="op">=</span><span class="st">"SPY"</span>, duration<span class="op">=</span><span class="st">"12 M"</span>, bar_size<span class="op">=</span><span class="st">"1 day"</span>):</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a><span class="co">    Fetch benchmark data (typically SPY) for performance comparison.</span></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns a Series of daily returns indexed by date.</span></span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Fetching benchmark data for </span><span class="sc">{</span>benchmark<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use same data fetching as assets</span></span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>        benchmark_data <span class="op">=</span> fetch_asset_data(benchmark, duration, bar_size)</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> benchmark_data.empty:</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"No benchmark data available."</span>)</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> pd.Series()</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate daily returns</span></span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>        benchmark_data[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(benchmark_data[<span class="st">'Date'</span>])</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>        benchmark_data.set_index(<span class="st">'Date'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>        benchmark_returns <span class="op">=</span> benchmark_data[<span class="st">'Close'</span>].pct_change().dropna()</span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> benchmark_returns</span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error fetching benchmark data: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series()</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Technical Indicators</span></span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a><span class="at">@safe</span></span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_indicators(df):</span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a><span class="co">    Add various technical indicators (SMA, MACD, RSI, Bollinger Bands, ATR, OBV) to the DataFrame.</span></span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Adding technical indicators..."</span>)</span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'SMA20'</span>] <span class="op">=</span> ta.trend.sma_indicator(df[<span class="st">"Close"</span>], window<span class="op">=</span><span class="dv">20</span>, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'SMA50'</span>] <span class="op">=</span> ta.trend.sma_indicator(df[<span class="st">"Close"</span>], window<span class="op">=</span><span class="dv">50</span>, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'SMA200'</span>] <span class="op">=</span> ta.trend.sma_indicator(df[<span class="st">"Close"</span>], window<span class="op">=</span><span class="dv">200</span>, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'MACD'</span>] <span class="op">=</span> ta.trend.macd_diff(df[<span class="st">"Close"</span>], window_slow<span class="op">=</span><span class="dv">26</span>, window_fast<span class="op">=</span><span class="dv">12</span>, window_sign<span class="op">=</span><span class="dv">9</span>, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'RSI'</span>] <span class="op">=</span> ta.momentum.rsi(df[<span class="st">"Close"</span>], window<span class="op">=</span><span class="dv">14</span>, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>    bb <span class="op">=</span> ta.volatility.BollingerBands(df[<span class="st">"Close"</span>], window<span class="op">=</span><span class="dv">20</span>, window_dev<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'BB_Upper'</span>] <span class="op">=</span> bb.bollinger_hband()</span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'BB_Lower'</span>] <span class="op">=</span> bb.bollinger_lband()</span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'BB_Middle'</span>] <span class="op">=</span> bb.bollinger_mavg()</span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'ATR'</span>] <span class="op">=</span> ta.volatility.average_true_range(df[<span class="st">"High"</span>], df[<span class="st">"Low"</span>], df[<span class="st">"Close"</span>], window<span class="op">=</span><span class="dv">14</span>, fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'OBV'</span>] <span class="op">=</span> ta.volume.on_balance_volume(df[<span class="st">"Close"</span>], df[<span class="st">"Volume"</span>], fillna<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Generate Trading Signals</span></span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a><span class="at">@safe</span></span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_signals(df,</span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a>                     rsi_threshold<span class="op">=</span><span class="dv">70</span>,</span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a>                     atr_stop_multiplier<span class="op">=</span><span class="fl">1.5</span>,</span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a>                     atr_take_multiplier<span class="op">=</span><span class="fl">3.5</span>,</span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a>                     risk_per_trade<span class="op">=</span><span class="fl">0.012</span>,</span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a>                     min_size<span class="op">=</span><span class="fl">0.10</span>,</span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a>                     max_size<span class="op">=</span><span class="fl">0.25</span>):</span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a><span class="co">    Strategy C+: Dynamic position sizing leaning towards Strategy B</span></span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a><span class="co">      - Position = clamp(dynamic risk position, 10%, 25%)</span></span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a><span class="co">      - Other logic same as Strategy C (Breakeven, Trailing, Entry conditions)</span></span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a>    df_signals <span class="op">=</span> df.copy()</span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize</span></span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a>    df_signals[<span class="st">'Signal'</span>]        <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a>    df_signals[<span class="st">'Entry_Price'</span>]   <span class="op">=</span> np.nan</span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a>    df_signals[<span class="st">'Stop_Loss'</span>]     <span class="op">=</span> np.nan</span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a>    df_signals[<span class="st">'Take_Profit'</span>]   <span class="op">=</span> np.nan</span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a>    df_signals[<span class="st">'Position_Size'</span>] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a>    bb_th <span class="op">=</span> <span class="fl">0.05</span></span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(df_signals)</span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n <span class="op">-</span> <span class="dv">1</span>):</span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a>        <span class="co"># —— Position Management ——</span></span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> df_signals.iloc[i<span class="op">-</span><span class="dv">1</span>][<span class="st">'Signal'</span>] <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a>            entry <span class="op">=</span> df_signals.iloc[i<span class="op">-</span><span class="dv">1</span>][<span class="st">'Entry_Price'</span>]</span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a>            atr   <span class="op">=</span> df_signals.iloc[i<span class="op">-</span><span class="dv">1</span>][<span class="st">'ATR'</span>]</span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a>            stop  <span class="op">=</span> df_signals.iloc[i<span class="op">-</span><span class="dv">1</span>][<span class="st">'Stop_Loss'</span>]</span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a>            take  <span class="op">=</span> df_signals.iloc[i<span class="op">-</span><span class="dv">1</span>][<span class="st">'Take_Profit'</span>]</span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Breakeven</span></span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> df_signals.iloc[i][<span class="st">'High'</span>] <span class="op">&gt;=</span> entry:</span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true" tabindex="-1"></a>                stop <span class="op">=</span> <span class="bu">max</span>(stop, entry)</span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Trailing</span></span>
<span id="cb9-162"><a href="#cb9-162" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> df_signals.iloc[i][<span class="st">'High'</span>] <span class="op">&gt;=</span> entry <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> atr:</span>
<span id="cb9-163"><a href="#cb9-163" aria-hidden="true" tabindex="-1"></a>                stop <span class="op">=</span> <span class="bu">max</span>(stop, entry <span class="op">+</span> atr)</span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true" tabindex="-1"></a>            df_signals.iat[i, df_signals.columns.get_loc(<span class="st">'Stop_Loss'</span>)] <span class="op">=</span> stop</span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Static SL/TP</span></span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> df_signals.iloc[i][<span class="st">'Low'</span>] <span class="op">&lt;=</span> stop <span class="kw">or</span> df_signals.iloc[i][<span class="st">'High'</span>] <span class="op">&gt;=</span> take:</span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true" tabindex="-1"></a>                df_signals.iat[i, df_signals.columns.get_loc(<span class="st">'Signal'</span>)] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true" tabindex="-1"></a>        <span class="co"># —— Carry Forward Position ——</span></span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> df_signals.iloc[i<span class="op">-</span><span class="dv">1</span>][<span class="st">'Signal'</span>] <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'Signal'</span>, <span class="st">'Entry_Price'</span>, <span class="st">'Stop_Loss'</span>, <span class="st">'Take_Profit'</span>, <span class="st">'Position_Size'</span>]:</span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true" tabindex="-1"></a>                df_signals.iat[i, df_signals.columns.get_loc(col)] <span class="op">=</span> df_signals.iloc[i<span class="op">-</span><span class="dv">1</span>][col]</span>
<span id="cb9-175"><a href="#cb9-175" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true" tabindex="-1"></a>        <span class="co"># —— New Entry Logic ——</span></span>
<span id="cb9-178"><a href="#cb9-178" aria-hidden="true" tabindex="-1"></a>        close  <span class="op">=</span> df_signals.iloc[i][<span class="st">'Close'</span>]</span>
<span id="cb9-179"><a href="#cb9-179" aria-hidden="true" tabindex="-1"></a>        rsi    <span class="op">=</span> df_signals.iloc[i][<span class="st">'RSI'</span>]</span>
<span id="cb9-180"><a href="#cb9-180" aria-hidden="true" tabindex="-1"></a>        bb_lo  <span class="op">=</span> df_signals.iloc[i][<span class="st">'BB_Lower'</span>]</span>
<span id="cb9-181"><a href="#cb9-181" aria-hidden="true" tabindex="-1"></a>        bb_md  <span class="op">=</span> df_signals.iloc[i][<span class="st">'BB_Middle'</span>]</span>
<span id="cb9-182"><a href="#cb9-182" aria-hidden="true" tabindex="-1"></a>        sma20  <span class="op">=</span> df_signals.iloc[i][<span class="st">'SMA20'</span>]</span>
<span id="cb9-183"><a href="#cb9-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-184"><a href="#cb9-184" aria-hidden="true" tabindex="-1"></a>        cond_main     <span class="op">=</span> (rsi <span class="op">&lt;</span> rsi_threshold <span class="kw">and</span> close <span class="op">&lt;=</span> bb_lo <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> bb_th))</span>
<span id="cb9-185"><a href="#cb9-185" aria-hidden="true" tabindex="-1"></a>        cond_mid      <span class="op">=</span> (close <span class="op">&lt;=</span> bb_md <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> bb_th))</span>
<span id="cb9-186"><a href="#cb9-186" aria-hidden="true" tabindex="-1"></a>        cond_oversold <span class="op">=</span> (rsi <span class="op">&lt;</span> <span class="dv">30</span>)</span>
<span id="cb9-187"><a href="#cb9-187" aria-hidden="true" tabindex="-1"></a>        cond_sma20    <span class="op">=</span> (close <span class="op">&lt;=</span> sma20 <span class="op">*</span> <span class="fl">0.98</span>)</span>
<span id="cb9-188"><a href="#cb9-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-189"><a href="#cb9-189" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cond_main <span class="kw">or</span> cond_mid <span class="kw">or</span> cond_oversold <span class="kw">or</span> cond_sma20:</span>
<span id="cb9-190"><a href="#cb9-190" aria-hidden="true" tabindex="-1"></a>            entry_price <span class="op">=</span> df_signals.iloc[i<span class="op">+</span><span class="dv">1</span>][<span class="st">'Open'</span>]</span>
<span id="cb9-191"><a href="#cb9-191" aria-hidden="true" tabindex="-1"></a>            atr_value   <span class="op">=</span> df_signals.iloc[i][<span class="st">'ATR'</span>]</span>
<span id="cb9-192"><a href="#cb9-192" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> atr_value <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb9-193"><a href="#cb9-193" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb9-194"><a href="#cb9-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-195"><a href="#cb9-195" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Dynamic risk position sizing</span></span>
<span id="cb9-196"><a href="#cb9-196" aria-hidden="true" tabindex="-1"></a>            port_val <span class="op">=</span> df_signals.iloc[i<span class="op">-</span><span class="dv">1</span>].get(<span class="st">'Portfolio_Value'</span>, <span class="dv">100000</span>)</span>
<span id="cb9-197"><a href="#cb9-197" aria-hidden="true" tabindex="-1"></a>            risk_amt <span class="op">=</span> risk_per_trade <span class="op">*</span> port_val</span>
<span id="cb9-198"><a href="#cb9-198" aria-hidden="true" tabindex="-1"></a>            dyn_pct  <span class="op">=</span> risk_amt <span class="op">/</span> (atr_stop_multiplier <span class="op">*</span> atr_value <span class="op">*</span> entry_price)</span>
<span id="cb9-199"><a href="#cb9-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-200"><a href="#cb9-200" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Clamp to [min_size, max_size]</span></span>
<span id="cb9-201"><a href="#cb9-201" aria-hidden="true" tabindex="-1"></a>            pos_pct <span class="op">=</span> <span class="bu">max</span>(min_size, <span class="bu">min</span>(dyn_pct, max_size))</span>
<span id="cb9-202"><a href="#cb9-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-203"><a href="#cb9-203" aria-hidden="true" tabindex="-1"></a>            df_signals.iat[i, df_signals.columns.get_loc(<span class="st">'Signal'</span>)]        <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb9-204"><a href="#cb9-204" aria-hidden="true" tabindex="-1"></a>            df_signals.iat[i, df_signals.columns.get_loc(<span class="st">'Entry_Price'</span>)]   <span class="op">=</span> entry_price</span>
<span id="cb9-205"><a href="#cb9-205" aria-hidden="true" tabindex="-1"></a>            df_signals.iat[i, df_signals.columns.get_loc(<span class="st">'Stop_Loss'</span>)]     <span class="op">=</span> entry_price <span class="op">-</span> atr_stop_multiplier <span class="op">*</span> atr_value</span>
<span id="cb9-206"><a href="#cb9-206" aria-hidden="true" tabindex="-1"></a>            df_signals.iat[i, df_signals.columns.get_loc(<span class="st">'Take_Profit'</span>)]   <span class="op">=</span> entry_price <span class="op">+</span> atr_take_multiplier <span class="op">*</span> atr_value</span>
<span id="cb9-207"><a href="#cb9-207" aria-hidden="true" tabindex="-1"></a>            df_signals.iat[i, df_signals.columns.get_loc(<span class="st">'Position_Size'</span>)] <span class="op">=</span> pos_pct</span>
<span id="cb9-208"><a href="#cb9-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-209"><a href="#cb9-209" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_signals</span>
<span id="cb9-210"><a href="#cb9-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-211"><a href="#cb9-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-212"><a href="#cb9-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-213"><a href="#cb9-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-214"><a href="#cb9-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-215"><a href="#cb9-215" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-216"><a href="#cb9-216" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Backtesting</span></span>
<span id="cb9-217"><a href="#cb9-217" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-218"><a href="#cb9-218" aria-hidden="true" tabindex="-1"></a><span class="at">@safe</span></span>
<span id="cb9-219"><a href="#cb9-219" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> backtest_strategy(df_signals, verbose<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb9-220"><a href="#cb9-220" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-221"><a href="#cb9-221" aria-hidden="true" tabindex="-1"></a><span class="co">    Backtest the generated signals and compute portfolio values, returns, drawdown, etc.</span></span>
<span id="cb9-222"><a href="#cb9-222" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-223"><a href="#cb9-223" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> verbose:</span>
<span id="cb9-224"><a href="#cb9-224" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Backtesting strategy..."</span>)</span>
<span id="cb9-225"><a href="#cb9-225" aria-hidden="true" tabindex="-1"></a>    df_backtest <span class="op">=</span> df_signals.copy()</span>
<span id="cb9-226"><a href="#cb9-226" aria-hidden="true" tabindex="-1"></a>    df_backtest[<span class="st">'Portfolio_Value'</span>] <span class="op">=</span> <span class="fl">100000.0</span></span>
<span id="cb9-227"><a href="#cb9-227" aria-hidden="true" tabindex="-1"></a>    df_backtest[<span class="st">'Shares'</span>] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb9-228"><a href="#cb9-228" aria-hidden="true" tabindex="-1"></a>    df_backtest[<span class="st">'Trade_Profit'</span>] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb9-229"><a href="#cb9-229" aria-hidden="true" tabindex="-1"></a>    df_backtest[<span class="st">'Trade_Return'</span>] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb9-230"><a href="#cb9-230" aria-hidden="true" tabindex="-1"></a>    df_backtest[<span class="st">'Cash'</span>] <span class="op">=</span> <span class="fl">100000.0</span>  <span class="co"># Initialize cash to initial capital</span></span>
<span id="cb9-231"><a href="#cb9-231" aria-hidden="true" tabindex="-1"></a>    df_backtest[<span class="st">'Equity'</span>] <span class="op">=</span> <span class="fl">0.0</span>     <span class="co"># Initialize stock value to 0</span></span>
<span id="cb9-232"><a href="#cb9-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-233"><a href="#cb9-233" aria-hidden="true" tabindex="-1"></a>    current_position, entry_price, shares_held <span class="op">=</span> <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span></span>
<span id="cb9-234"><a href="#cb9-234" aria-hidden="true" tabindex="-1"></a>    trades <span class="op">=</span> []</span>
<span id="cb9-235"><a href="#cb9-235" aria-hidden="true" tabindex="-1"></a>    winning_trades <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-236"><a href="#cb9-236" aria-hidden="true" tabindex="-1"></a>    total_trades <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-237"><a href="#cb9-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-238"><a href="#cb9-238" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(df_backtest)):</span>
<span id="cb9-239"><a href="#cb9-239" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Copy forward portfolio value</span></span>
<span id="cb9-240"><a href="#cb9-240" aria-hidden="true" tabindex="-1"></a>        df_backtest.iloc[i, df_backtest.columns.get_loc(<span class="st">'Portfolio_Value'</span>)] <span class="op">=</span> df_backtest.iloc[i<span class="op">-</span><span class="dv">1</span>][<span class="st">'Portfolio_Value'</span>]</span>
<span id="cb9-241"><a href="#cb9-241" aria-hidden="true" tabindex="-1"></a>        df_backtest.iloc[i, df_backtest.columns.get_loc(<span class="st">'Cash'</span>)] <span class="op">=</span> df_backtest.iloc[i<span class="op">-</span><span class="dv">1</span>][<span class="st">'Cash'</span>]</span>
<span id="cb9-242"><a href="#cb9-242" aria-hidden="true" tabindex="-1"></a>        df_backtest.iloc[i, df_backtest.columns.get_loc(<span class="st">'Equity'</span>)] <span class="op">=</span> df_backtest.iloc[i<span class="op">-</span><span class="dv">1</span>][<span class="st">'Equity'</span>]</span>
<span id="cb9-243"><a href="#cb9-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-244"><a href="#cb9-244" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Enter position</span></span>
<span id="cb9-245"><a href="#cb9-245" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> df_backtest.iloc[i][<span class="st">'Signal'</span>] <span class="op">!=</span> <span class="dv">0</span> <span class="kw">and</span> current_position <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb9-246"><a href="#cb9-246" aria-hidden="true" tabindex="-1"></a>            current_position <span class="op">=</span> df_backtest.iloc[i][<span class="st">'Signal'</span>]</span>
<span id="cb9-247"><a href="#cb9-247" aria-hidden="true" tabindex="-1"></a>            entry_price <span class="op">=</span> df_backtest.iloc[i][<span class="st">'Entry_Price'</span>]</span>
<span id="cb9-248"><a href="#cb9-248" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb9-249"><a href="#cb9-249" aria-hidden="true" tabindex="-1"></a>                position_value <span class="op">=</span> df_backtest.iloc[i<span class="op">-</span><span class="dv">1</span>][<span class="st">'Portfolio_Value'</span>] <span class="op">*</span> df_backtest.iloc[i][<span class="st">'Position_Size'</span>]</span>
<span id="cb9-250"><a href="#cb9-250" aria-hidden="true" tabindex="-1"></a>                shares_held <span class="op">=</span> position_value <span class="op">/</span> entry_price</span>
<span id="cb9-251"><a href="#cb9-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-252"><a href="#cb9-252" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Update cash and equity values</span></span>
<span id="cb9-253"><a href="#cb9-253" aria-hidden="true" tabindex="-1"></a>                df_backtest.iloc[i, df_backtest.columns.get_loc(<span class="st">'Cash'</span>)] <span class="op">=</span> df_backtest.iloc[i][<span class="st">'Cash'</span>] <span class="op">-</span> position_value</span>
<span id="cb9-254"><a href="#cb9-254" aria-hidden="true" tabindex="-1"></a>                df_backtest.iloc[i, df_backtest.columns.get_loc(<span class="st">'Equity'</span>)] <span class="op">=</span> shares_held <span class="op">*</span> entry_price</span>
<span id="cb9-255"><a href="#cb9-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-256"><a href="#cb9-256" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb9-257"><a href="#cb9-257" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> verbose:</span>
<span id="cb9-258"><a href="#cb9-258" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"Error calculating shares at index </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-259"><a href="#cb9-259" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb9-260"><a href="#cb9-260" aria-hidden="true" tabindex="-1"></a>            df_backtest.iloc[i, df_backtest.columns.get_loc(<span class="st">'Shares'</span>)] <span class="op">=</span> shares_held</span>
<span id="cb9-261"><a href="#cb9-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-262"><a href="#cb9-262" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Exit position</span></span>
<span id="cb9-263"><a href="#cb9-263" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> df_backtest.iloc[i][<span class="st">'Signal'</span>] <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> current_position <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb9-264"><a href="#cb9-264" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check if stop loss or take profit is triggered, use actual trigger price</span></span>
<span id="cb9-265"><a href="#cb9-265" aria-hidden="true" tabindex="-1"></a>            exit_price <span class="op">=</span> df_backtest.iloc[i][<span class="st">'Close'</span>]  <span class="co"># Default to using closing price</span></span>
<span id="cb9-266"><a href="#cb9-266" aria-hidden="true" tabindex="-1"></a>            exit_reason <span class="op">=</span> <span class="st">"Unknown"</span></span>
<span id="cb9-267"><a href="#cb9-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-268"><a href="#cb9-268" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Stop loss check - if daily low touches or falls below stop loss price, use stop loss price to exit</span></span>
<span id="cb9-269"><a href="#cb9-269" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> df_backtest.iloc[i][<span class="st">'Low'</span>] <span class="op">&lt;=</span> df_backtest.iloc[i<span class="op">-</span><span class="dv">1</span>][<span class="st">'Stop_Loss'</span>]:</span>
<span id="cb9-270"><a href="#cb9-270" aria-hidden="true" tabindex="-1"></a>                exit_price <span class="op">=</span> df_backtest.iloc[i<span class="op">-</span><span class="dv">1</span>][<span class="st">'Stop_Loss'</span>]</span>
<span id="cb9-271"><a href="#cb9-271" aria-hidden="true" tabindex="-1"></a>                exit_reason <span class="op">=</span> <span class="st">"Stop_Loss"</span></span>
<span id="cb9-272"><a href="#cb9-272" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> verbose <span class="kw">and</span> i <span class="op">%</span> <span class="dv">20</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb9-273"><a href="#cb9-273" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"Stop loss triggered: exit at $</span><span class="sc">{</span>exit_price<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-274"><a href="#cb9-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-275"><a href="#cb9-275" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Take profit check - if daily high touches or exceeds take profit price, use take profit price to exit</span></span>
<span id="cb9-276"><a href="#cb9-276" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> df_backtest.iloc[i][<span class="st">'High'</span>] <span class="op">&gt;=</span> df_backtest.iloc[i<span class="op">-</span><span class="dv">1</span>][<span class="st">'Take_Profit'</span>]:</span>
<span id="cb9-277"><a href="#cb9-277" aria-hidden="true" tabindex="-1"></a>                exit_price <span class="op">=</span> df_backtest.iloc[i<span class="op">-</span><span class="dv">1</span>][<span class="st">'Take_Profit'</span>]</span>
<span id="cb9-278"><a href="#cb9-278" aria-hidden="true" tabindex="-1"></a>                exit_reason <span class="op">=</span> <span class="st">"Take_Profit"</span></span>
<span id="cb9-279"><a href="#cb9-279" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> verbose <span class="kw">and</span> i <span class="op">%</span> <span class="dv">20</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb9-280"><a href="#cb9-280" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"Take profit triggered: exit at $</span><span class="sc">{</span>exit_price<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-281"><a href="#cb9-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-282"><a href="#cb9-282" aria-hidden="true" tabindex="-1"></a>            <span class="co"># RSI check</span></span>
<span id="cb9-283"><a href="#cb9-283" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> <span class="st">'RSI'</span> <span class="kw">in</span> df_backtest.columns <span class="kw">and</span> df_backtest.iloc[i][<span class="st">'RSI'</span>] <span class="op">&gt;</span> <span class="dv">70</span>:</span>
<span id="cb9-284"><a href="#cb9-284" aria-hidden="true" tabindex="-1"></a>                exit_reason <span class="op">=</span> <span class="st">"RSI_Overbought"</span></span>
<span id="cb9-285"><a href="#cb9-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-286"><a href="#cb9-286" aria-hidden="true" tabindex="-1"></a>            <span class="co"># SMA breakout check</span></span>
<span id="cb9-287"><a href="#cb9-287" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> <span class="st">'SMA50'</span> <span class="kw">in</span> df_backtest.columns <span class="kw">and</span> df_backtest.iloc[i][<span class="st">'Close'</span>] <span class="op">&lt;</span> df_backtest.iloc[i][<span class="st">'SMA50'</span>]:</span>
<span id="cb9-288"><a href="#cb9-288" aria-hidden="true" tabindex="-1"></a>                exit_reason <span class="op">=</span> <span class="st">"SMA_Breakdown"</span></span>
<span id="cb9-289"><a href="#cb9-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-290"><a href="#cb9-290" aria-hidden="true" tabindex="-1"></a>            trade_profit <span class="op">=</span> (exit_price <span class="op">-</span> entry_price) <span class="op">*</span> shares_held <span class="cf">if</span> current_position <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-291"><a href="#cb9-291" aria-hidden="true" tabindex="-1"></a>            new_value <span class="op">=</span> df_backtest.iloc[i<span class="op">-</span><span class="dv">1</span>][<span class="st">'Portfolio_Value'</span>] <span class="op">+</span> trade_profit</span>
<span id="cb9-292"><a href="#cb9-292" aria-hidden="true" tabindex="-1"></a>            df_backtest.iloc[i, df_backtest.columns.get_loc(<span class="st">'Portfolio_Value'</span>)] <span class="op">=</span> <span class="bu">float</span>(new_value)</span>
<span id="cb9-293"><a href="#cb9-293" aria-hidden="true" tabindex="-1"></a>            df_backtest.iloc[i, df_backtest.columns.get_loc(<span class="st">'Trade_Profit'</span>)] <span class="op">=</span> <span class="bu">float</span>(trade_profit)</span>
<span id="cb9-294"><a href="#cb9-294" aria-hidden="true" tabindex="-1"></a>            trade_return <span class="op">=</span> trade_profit <span class="op">/</span> (entry_price <span class="op">*</span> shares_held) <span class="cf">if</span> shares_held <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-295"><a href="#cb9-295" aria-hidden="true" tabindex="-1"></a>            df_backtest.iloc[i, df_backtest.columns.get_loc(<span class="st">'Trade_Return'</span>)] <span class="op">=</span> <span class="bu">float</span>(trade_return)</span>
<span id="cb9-296"><a href="#cb9-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-297"><a href="#cb9-297" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update cash and equity values</span></span>
<span id="cb9-298"><a href="#cb9-298" aria-hidden="true" tabindex="-1"></a>            cash_after_exit <span class="op">=</span> df_backtest.iloc[i][<span class="st">'Cash'</span>] <span class="op">+</span> (exit_price <span class="op">*</span> shares_held)</span>
<span id="cb9-299"><a href="#cb9-299" aria-hidden="true" tabindex="-1"></a>            df_backtest.iloc[i, df_backtest.columns.get_loc(<span class="st">'Cash'</span>)] <span class="op">=</span> cash_after_exit</span>
<span id="cb9-300"><a href="#cb9-300" aria-hidden="true" tabindex="-1"></a>            df_backtest.iloc[i, df_backtest.columns.get_loc(<span class="st">'Equity'</span>)] <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Equity is 0 after position is closed</span></span>
<span id="cb9-301"><a href="#cb9-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-302"><a href="#cb9-302" aria-hidden="true" tabindex="-1"></a>            trades.append({</span>
<span id="cb9-303"><a href="#cb9-303" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Entry_Date'</span>: df_backtest.iloc[i<span class="op">-</span><span class="dv">1</span>][<span class="st">'Date'</span>],</span>
<span id="cb9-304"><a href="#cb9-304" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Exit_Date'</span>: df_backtest.iloc[i][<span class="st">'Date'</span>],</span>
<span id="cb9-305"><a href="#cb9-305" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Entry_Price'</span>: entry_price,</span>
<span id="cb9-306"><a href="#cb9-306" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Exit_Price'</span>: exit_price,</span>
<span id="cb9-307"><a href="#cb9-307" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Shares'</span>: shares_held,</span>
<span id="cb9-308"><a href="#cb9-308" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Profit'</span>: trade_profit,</span>
<span id="cb9-309"><a href="#cb9-309" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Return'</span>: trade_return,</span>
<span id="cb9-310"><a href="#cb9-310" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Duration'</span>: (df_backtest.iloc[i][<span class="st">'Date'</span>] <span class="op">-</span> df_backtest.iloc[i<span class="op">-</span><span class="dv">1</span>][<span class="st">'Date'</span>]).days,</span>
<span id="cb9-311"><a href="#cb9-311" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Exit_Reason'</span>: exit_reason</span>
<span id="cb9-312"><a href="#cb9-312" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb9-313"><a href="#cb9-313" aria-hidden="true" tabindex="-1"></a>            total_trades <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb9-314"><a href="#cb9-314" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> trade_profit <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-315"><a href="#cb9-315" aria-hidden="true" tabindex="-1"></a>                winning_trades <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb9-316"><a href="#cb9-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-317"><a href="#cb9-317" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Reset position</span></span>
<span id="cb9-318"><a href="#cb9-318" aria-hidden="true" tabindex="-1"></a>            current_position, entry_price, shares_held <span class="op">=</span> <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span></span>
<span id="cb9-319"><a href="#cb9-319" aria-hidden="true" tabindex="-1"></a>            df_backtest.iloc[i, df_backtest.columns.get_loc(<span class="st">'Shares'</span>)] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb9-320"><a href="#cb9-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-321"><a href="#cb9-321" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If continuing the same position</span></span>
<span id="cb9-322"><a href="#cb9-322" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> df_backtest.iloc[i][<span class="st">'Signal'</span>] <span class="op">!=</span> <span class="dv">0</span> <span class="kw">and</span> current_position <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb9-323"><a href="#cb9-323" aria-hidden="true" tabindex="-1"></a>            df_backtest.iloc[i, df_backtest.columns.get_loc(<span class="st">'Shares'</span>)] <span class="op">=</span> shares_held</span>
<span id="cb9-324"><a href="#cb9-324" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update equity based on latest price</span></span>
<span id="cb9-325"><a href="#cb9-325" aria-hidden="true" tabindex="-1"></a>            current_equity <span class="op">=</span> shares_held <span class="op">*</span> df_backtest.iloc[i][<span class="st">'Close'</span>]</span>
<span id="cb9-326"><a href="#cb9-326" aria-hidden="true" tabindex="-1"></a>            df_backtest.iloc[i, df_backtest.columns.get_loc(<span class="st">'Equity'</span>)] <span class="op">=</span> current_equity</span>
<span id="cb9-327"><a href="#cb9-327" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update portfolio value</span></span>
<span id="cb9-328"><a href="#cb9-328" aria-hidden="true" tabindex="-1"></a>            df_backtest.iloc[i, df_backtest.columns.get_loc(<span class="st">'Portfolio_Value'</span>)] <span class="op">=</span> df_backtest.iloc[i][<span class="st">'Cash'</span>] <span class="op">+</span> current_equity</span>
<span id="cb9-329"><a href="#cb9-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-330"><a href="#cb9-330" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add required columns for print_ledger function</span></span>
<span id="cb9-331"><a href="#cb9-331" aria-hidden="true" tabindex="-1"></a>    df_backtest[<span class="st">'Account_Value'</span>] <span class="op">=</span> df_backtest[<span class="st">'Portfolio_Value'</span>]</span>
<span id="cb9-332"><a href="#cb9-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-333"><a href="#cb9-333" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simple summary without detailed calculations</span></span>
<span id="cb9-334"><a href="#cb9-334" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> verbose:</span>
<span id="cb9-335"><a href="#cb9-335" aria-hidden="true" tabindex="-1"></a>        win_rate <span class="op">=</span> winning_trades <span class="op">/</span> total_trades <span class="cf">if</span> total_trades <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-336"><a href="#cb9-336" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Backtest Summary: </span><span class="sc">{</span>total_trades<span class="sc">}</span><span class="ss"> trades completed with </span><span class="sc">{</span>win_rate<span class="sc">:.2%}</span><span class="ss"> win rate"</span>)</span>
<span id="cb9-337"><a href="#cb9-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-338"><a href="#cb9-338" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_backtest, trades</span>
<span id="cb9-339"><a href="#cb9-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-340"><a href="#cb9-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-341"><a href="#cb9-341" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-342"><a href="#cb9-342" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. analyze_trades (migrated &amp; optimized from the First Version)</span></span>
<span id="cb9-343"><a href="#cb9-343" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-344"><a href="#cb9-344" aria-hidden="true" tabindex="-1"></a><span class="at">@safe</span></span>
<span id="cb9-345"><a href="#cb9-345" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_trades(trades, verbose<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb9-346"><a href="#cb9-346" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-347"><a href="#cb9-347" aria-hidden="true" tabindex="-1"></a><span class="co">    Detailed analysis of all completed trades:</span></span>
<span id="cb9-348"><a href="#cb9-348" aria-hidden="true" tabindex="-1"></a><span class="co">    - Number of trades, Win rate</span></span>
<span id="cb9-349"><a href="#cb9-349" aria-hidden="true" tabindex="-1"></a><span class="co">    - Average profit, average win, average loss</span></span>
<span id="cb9-350"><a href="#cb9-350" aria-hidden="true" tabindex="-1"></a><span class="co">    - Profit factor</span></span>
<span id="cb9-351"><a href="#cb9-351" aria-hidden="true" tabindex="-1"></a><span class="co">    - Consecutive wins/losses</span></span>
<span id="cb9-352"><a href="#cb9-352" aria-hidden="true" tabindex="-1"></a><span class="co">    - Holding duration stats</span></span>
<span id="cb9-353"><a href="#cb9-353" aria-hidden="true" tabindex="-1"></a><span class="co">    - Recent trades summary</span></span>
<span id="cb9-354"><a href="#cb9-354" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-355"><a href="#cb9-355" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> trades:</span>
<span id="cb9-356"><a href="#cb9-356" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> verbose:</span>
<span id="cb9-357"><a href="#cb9-357" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"No trade records to analyze."</span>)</span>
<span id="cb9-358"><a href="#cb9-358" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb9-359"><a href="#cb9-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-360"><a href="#cb9-360" aria-hidden="true" tabindex="-1"></a>    trades_df <span class="op">=</span> pd.DataFrame(trades)</span>
<span id="cb9-361"><a href="#cb9-361" aria-hidden="true" tabindex="-1"></a>    total_trades <span class="op">=</span> <span class="bu">len</span>(trades_df)</span>
<span id="cb9-362"><a href="#cb9-362" aria-hidden="true" tabindex="-1"></a>    win_count <span class="op">=</span> <span class="bu">len</span>(trades_df[trades_df[<span class="st">'Profit'</span>] <span class="op">&gt;</span> <span class="dv">0</span>])</span>
<span id="cb9-363"><a href="#cb9-363" aria-hidden="true" tabindex="-1"></a>    loss_count <span class="op">=</span> <span class="bu">len</span>(trades_df[trades_df[<span class="st">'Profit'</span>] <span class="op">&lt;=</span> <span class="dv">0</span>])</span>
<span id="cb9-364"><a href="#cb9-364" aria-hidden="true" tabindex="-1"></a>    win_rate <span class="op">=</span> win_count <span class="op">/</span> total_trades <span class="cf">if</span> total_trades <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-365"><a href="#cb9-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-366"><a href="#cb9-366" aria-hidden="true" tabindex="-1"></a>    avg_profit <span class="op">=</span> trades_df[<span class="st">'Profit'</span>].mean()</span>
<span id="cb9-367"><a href="#cb9-367" aria-hidden="true" tabindex="-1"></a>    avg_win <span class="op">=</span> trades_df.loc[trades_df[<span class="st">'Profit'</span>] <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">'Profit'</span>].mean() <span class="cf">if</span> win_count <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-368"><a href="#cb9-368" aria-hidden="true" tabindex="-1"></a>    avg_loss <span class="op">=</span> trades_df.loc[trades_df[<span class="st">'Profit'</span>] <span class="op">&lt;=</span> <span class="dv">0</span>, <span class="st">'Profit'</span>].mean() <span class="cf">if</span> loss_count <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-369"><a href="#cb9-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-370"><a href="#cb9-370" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Profit factor = sum of all wins / sum of all losses (absolute value)</span></span>
<span id="cb9-371"><a href="#cb9-371" aria-hidden="true" tabindex="-1"></a>    total_win_amount <span class="op">=</span> trades_df.loc[trades_df[<span class="st">'Profit'</span>] <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">'Profit'</span>].<span class="bu">sum</span>()</span>
<span id="cb9-372"><a href="#cb9-372" aria-hidden="true" tabindex="-1"></a>    total_loss_amount <span class="op">=</span> trades_df.loc[trades_df[<span class="st">'Profit'</span>] <span class="op">&lt;</span> <span class="dv">0</span>, <span class="st">'Profit'</span>].<span class="bu">sum</span>()</span>
<span id="cb9-373"><a href="#cb9-373" aria-hidden="true" tabindex="-1"></a>    profit_factor <span class="op">=</span> <span class="bu">abs</span>(total_win_amount <span class="op">/</span> total_loss_amount) <span class="cf">if</span> total_loss_amount <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> <span class="bu">float</span>(<span class="st">'inf'</span>)</span>
<span id="cb9-374"><a href="#cb9-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-375"><a href="#cb9-375" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Duration</span></span>
<span id="cb9-376"><a href="#cb9-376" aria-hidden="true" tabindex="-1"></a>    trades_df[<span class="st">'Duration'</span>] <span class="op">=</span> (trades_df[<span class="st">'Exit_Date'</span>] <span class="op">-</span> trades_df[<span class="st">'Entry_Date'</span>]).dt.days</span>
<span id="cb9-377"><a href="#cb9-377" aria-hidden="true" tabindex="-1"></a>    avg_duration <span class="op">=</span> trades_df[<span class="st">'Duration'</span>].mean()</span>
<span id="cb9-378"><a href="#cb9-378" aria-hidden="true" tabindex="-1"></a>    max_duration <span class="op">=</span> trades_df[<span class="st">'Duration'</span>].<span class="bu">max</span>()</span>
<span id="cb9-379"><a href="#cb9-379" aria-hidden="true" tabindex="-1"></a>    min_duration <span class="op">=</span> trades_df[<span class="st">'Duration'</span>].<span class="bu">min</span>()</span>
<span id="cb9-380"><a href="#cb9-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-381"><a href="#cb9-381" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Analyze consecutive wins/losses</span></span>
<span id="cb9-382"><a href="#cb9-382" aria-hidden="true" tabindex="-1"></a>    trade_results <span class="op">=</span> [<span class="dv">1</span> <span class="cf">if</span> p <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span> <span class="cf">for</span> p <span class="kw">in</span> trades_df[<span class="st">'Profit'</span>]]</span>
<span id="cb9-383"><a href="#cb9-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-384"><a href="#cb9-384" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate max consecutive wins (inline function)</span></span>
<span id="cb9-385"><a href="#cb9-385" aria-hidden="true" tabindex="-1"></a>    max_consecutive_wins <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-386"><a href="#cb9-386" aria-hidden="true" tabindex="-1"></a>    current_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-387"><a href="#cb9-387" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> v <span class="kw">in</span> trade_results:</span>
<span id="cb9-388"><a href="#cb9-388" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> v <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb9-389"><a href="#cb9-389" aria-hidden="true" tabindex="-1"></a>            current_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb9-390"><a href="#cb9-390" aria-hidden="true" tabindex="-1"></a>            max_consecutive_wins <span class="op">=</span> <span class="bu">max</span>(max_consecutive_wins, current_count)</span>
<span id="cb9-391"><a href="#cb9-391" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb9-392"><a href="#cb9-392" aria-hidden="true" tabindex="-1"></a>            current_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-393"><a href="#cb9-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-394"><a href="#cb9-394" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate max consecutive losses (inline function)</span></span>
<span id="cb9-395"><a href="#cb9-395" aria-hidden="true" tabindex="-1"></a>    max_consecutive_losses <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-396"><a href="#cb9-396" aria-hidden="true" tabindex="-1"></a>    current_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-397"><a href="#cb9-397" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> v <span class="kw">in</span> trade_results:</span>
<span id="cb9-398"><a href="#cb9-398" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> v <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb9-399"><a href="#cb9-399" aria-hidden="true" tabindex="-1"></a>            current_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb9-400"><a href="#cb9-400" aria-hidden="true" tabindex="-1"></a>            max_consecutive_losses <span class="op">=</span> <span class="bu">max</span>(max_consecutive_losses, current_count)</span>
<span id="cb9-401"><a href="#cb9-401" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb9-402"><a href="#cb9-402" aria-hidden="true" tabindex="-1"></a>            current_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-403"><a href="#cb9-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-404"><a href="#cb9-404" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> verbose:</span>
<span id="cb9-405"><a href="#cb9-405" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Detailed Trade Analysis ==="</span>)</span>
<span id="cb9-406"><a href="#cb9-406" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Total Trades: </span><span class="sc">{</span>total_trades<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-407"><a href="#cb9-407" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Win Rate: </span><span class="sc">{</span>win_rate<span class="sc">:.2%}</span><span class="ss">  (Wins=</span><span class="sc">{</span>win_count<span class="sc">}</span><span class="ss">, Losses=</span><span class="sc">{</span>loss_count<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb9-408"><a href="#cb9-408" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Avg Trade Profit: </span><span class="sc">{</span>avg_profit<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-409"><a href="#cb9-409" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Avg Win: </span><span class="sc">{</span>avg_win<span class="sc">:.2f}</span><span class="ss">,  Avg Loss: </span><span class="sc">{</span>avg_loss<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-410"><a href="#cb9-410" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Profit Factor: </span><span class="sc">{</span>profit_factor<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-411"><a href="#cb9-411" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Avg Holding Duration: </span><span class="sc">{</span>avg_duration<span class="sc">:.1f}</span><span class="ss"> days  (Max=</span><span class="sc">{</span>max_duration<span class="sc">}</span><span class="ss">d, Min=</span><span class="sc">{</span>min_duration<span class="sc">}</span><span class="ss">d)"</span>)</span>
<span id="cb9-412"><a href="#cb9-412" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Max Consecutive Wins: </span><span class="sc">{</span>max_consecutive_wins<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-413"><a href="#cb9-413" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Max Consecutive Losses: </span><span class="sc">{</span>max_consecutive_losses<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-414"><a href="#cb9-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-415"><a href="#cb9-415" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Recent trades</span></span>
<span id="cb9-416"><a href="#cb9-416" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Recent 10 Trades (most recent first):"</span>)</span>
<span id="cb9-417"><a href="#cb9-417" aria-hidden="true" tabindex="-1"></a>        recent_trades <span class="op">=</span> trades_df.tail(<span class="dv">10</span>).sort_values(<span class="st">'Entry_Date'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb9-418"><a href="#cb9-418" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, trade <span class="kw">in</span> recent_trades.iterrows():</span>
<span id="cb9-419"><a href="#cb9-419" aria-hidden="true" tabindex="-1"></a>            result_str <span class="op">=</span> <span class="st">"Profit"</span> <span class="cf">if</span> trade[<span class="st">'Profit'</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"Loss"</span></span>
<span id="cb9-420"><a href="#cb9-420" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>trade[<span class="st">'Entry_Date'</span>]<span class="sc">.</span>date()<span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span>trade[<span class="st">'Exit_Date'</span>]<span class="sc">.</span>date()<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>trade[<span class="st">'Duration'</span>]<span class="sc">}</span><span class="ss"> days): "</span></span>
<span id="cb9-421"><a href="#cb9-421" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"$</span><span class="sc">{</span>trade[<span class="st">'Entry_Price'</span>]<span class="sc">:.2f}</span><span class="ss"> -&gt; $</span><span class="sc">{</span>trade[<span class="st">'Exit_Price'</span>]<span class="sc">:.2f}</span><span class="ss">, </span><span class="sc">{</span>result_str<span class="sc">}</span><span class="ss"> $</span><span class="sc">{</span><span class="bu">abs</span>(trade[<span class="st">'Profit'</span>])<span class="sc">:.2f}</span><span class="ss">, "</span></span>
<span id="cb9-422"><a href="#cb9-422" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Return=</span><span class="sc">{</span>trade[<span class="st">'Return'</span>]<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb9-423"><a href="#cb9-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-424"><a href="#cb9-424" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> trades_df</span>
<span id="cb9-425"><a href="#cb9-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-426"><a href="#cb9-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-427"><a href="#cb9-427" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-428"><a href="#cb9-428" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Parameter Optimization &amp; Visualization</span></span>
<span id="cb9-429"><a href="#cb9-429" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-430"><a href="#cb9-430" aria-hidden="true" tabindex="-1"></a><span class="at">@safe</span></span>
<span id="cb9-431"><a href="#cb9-431" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> optimize_strategy(df, param_grid<span class="op">=</span><span class="va">None</span>, min_trades<span class="op">=</span><span class="dv">10</span>, drawdown_penalty<span class="op">=</span><span class="fl">0.5</span>):</span>
<span id="cb9-432"><a href="#cb9-432" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-433"><a href="#cb9-433" aria-hidden="true" tabindex="-1"></a><span class="co">    Grid-search parameter optimization with:</span></span>
<span id="cb9-434"><a href="#cb9-434" aria-hidden="true" tabindex="-1"></a><span class="co">      - Extended parameter range</span></span>
<span id="cb9-435"><a href="#cb9-435" aria-hidden="true" tabindex="-1"></a><span class="co">      - Skip combinations with &lt; min_trades trades</span></span>
<span id="cb9-436"><a href="#cb9-436" aria-hidden="true" tabindex="-1"></a><span class="co">      - Custom scoring: Sharpe - drawdown_penalty * abs(max_drawdown)</span></span>
<span id="cb9-437"><a href="#cb9-437" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-438"><a href="#cb9-438" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Starting enhanced parameter optimization..."</span>)</span>
<span id="cb9-439"><a href="#cb9-439" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1) Default richer parameter grid</span></span>
<span id="cb9-440"><a href="#cb9-440" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> param_grid <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb9-441"><a href="#cb9-441" aria-hidden="true" tabindex="-1"></a>        param_grid <span class="op">=</span> {</span>
<span id="cb9-442"><a href="#cb9-442" aria-hidden="true" tabindex="-1"></a>            <span class="st">'rsi_threshold'</span>: [<span class="dv">30</span>, <span class="dv">35</span>, <span class="dv">40</span>, <span class="dv">45</span>, <span class="dv">50</span>, <span class="dv">55</span>],</span>
<span id="cb9-443"><a href="#cb9-443" aria-hidden="true" tabindex="-1"></a>            <span class="st">'atr_stop_multiplier'</span>: [<span class="fl">1.0</span>, <span class="fl">1.5</span>, <span class="fl">2.0</span>, <span class="fl">2.5</span>, <span class="fl">3.0</span>],</span>
<span id="cb9-444"><a href="#cb9-444" aria-hidden="true" tabindex="-1"></a>            <span class="st">'atr_take_multiplier'</span>: [<span class="fl">2.0</span>, <span class="fl">3.0</span>, <span class="fl">4.0</span>, <span class="fl">5.0</span>, <span class="fl">6.0</span>]</span>
<span id="cb9-445"><a href="#cb9-445" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-446"><a href="#cb9-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-447"><a href="#cb9-447" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) Scoring function: Sharpe minus drawdown penalty</span></span>
<span id="cb9-448"><a href="#cb9-448" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> score_fn(res):</span>
<span id="cb9-449"><a href="#cb9-449" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> res[<span class="st">'sharpe_ratio'</span>] <span class="op">-</span> drawdown_penalty <span class="op">*</span> <span class="bu">abs</span>(res[<span class="st">'max_drawdown'</span>] <span class="op">/</span> <span class="dv">100</span>)</span>
<span id="cb9-450"><a href="#cb9-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-451"><a href="#cb9-451" aria-hidden="true" tabindex="-1"></a>    best_score <span class="op">=</span> <span class="op">-</span><span class="bu">float</span>(<span class="st">'inf'</span>)</span>
<span id="cb9-452"><a href="#cb9-452" aria-hidden="true" tabindex="-1"></a>    best_params <span class="op">=</span> <span class="va">None</span></span>
<span id="cb9-453"><a href="#cb9-453" aria-hidden="true" tabindex="-1"></a>    all_results <span class="op">=</span> []</span>
<span id="cb9-454"><a href="#cb9-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-455"><a href="#cb9-455" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Full traversal</span></span>
<span id="cb9-456"><a href="#cb9-456" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> rsi_thresh <span class="kw">in</span> param_grid[<span class="st">'rsi_threshold'</span>]:</span>
<span id="cb9-457"><a href="#cb9-457" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> atr_stop <span class="kw">in</span> param_grid[<span class="st">'atr_stop_multiplier'</span>]:</span>
<span id="cb9-458"><a href="#cb9-458" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> atr_take <span class="kw">in</span> param_grid[<span class="st">'atr_take_multiplier'</span>]:</span>
<span id="cb9-459"><a href="#cb9-459" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Ensure take profit &gt; stop loss</span></span>
<span id="cb9-460"><a href="#cb9-460" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> atr_take <span class="op">&lt;=</span> atr_stop:</span>
<span id="cb9-461"><a href="#cb9-461" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb9-462"><a href="#cb9-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-463"><a href="#cb9-463" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Generate signals and backtest</span></span>
<span id="cb9-464"><a href="#cb9-464" aria-hidden="true" tabindex="-1"></a>                signals <span class="op">=</span> generate_signals(df, rsi_thresh, atr_stop, atr_take)</span>
<span id="cb9-465"><a href="#cb9-465" aria-hidden="true" tabindex="-1"></a>                backtested, trades <span class="op">=</span> backtest_strategy(signals, verbose<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb9-466"><a href="#cb9-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-467"><a href="#cb9-467" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Filter out trades with too few trades</span></span>
<span id="cb9-468"><a href="#cb9-468" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">len</span>(trades) <span class="op">&lt;</span> min_trades:</span>
<span id="cb9-469"><a href="#cb9-469" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb9-470"><a href="#cb9-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-471"><a href="#cb9-471" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Calculate metrics</span></span>
<span id="cb9-472"><a href="#cb9-472" aria-hidden="true" tabindex="-1"></a>                initial <span class="op">=</span> backtested[<span class="st">'Portfolio_Value'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb9-473"><a href="#cb9-473" aria-hidden="true" tabindex="-1"></a>                final   <span class="op">=</span> backtested[<span class="st">'Portfolio_Value'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb9-474"><a href="#cb9-474" aria-hidden="true" tabindex="-1"></a>                total_ret <span class="op">=</span> (final <span class="op">/</span> initial <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb9-475"><a href="#cb9-475" aria-hidden="true" tabindex="-1"></a>                days <span class="op">=</span> (backtested[<span class="st">'Date'</span>].iloc[<span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> backtested[<span class="st">'Date'</span>].iloc[<span class="dv">0</span>]).days</span>
<span id="cb9-476"><a href="#cb9-476" aria-hidden="true" tabindex="-1"></a>                years <span class="op">=</span> days <span class="op">/</span> <span class="dv">365</span> <span class="cf">if</span> days<span class="op">&gt;</span><span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-477"><a href="#cb9-477" aria-hidden="true" tabindex="-1"></a>                ann_ret <span class="op">=</span> ((<span class="dv">1</span> <span class="op">+</span> total_ret<span class="op">/</span><span class="dv">100</span>) <span class="op">**</span> (<span class="dv">1</span><span class="op">/</span>years) <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">100</span> <span class="cf">if</span> years<span class="op">&gt;</span><span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-478"><a href="#cb9-478" aria-hidden="true" tabindex="-1"></a>                backtested[<span class="st">'Peak'</span>] <span class="op">=</span> backtested[<span class="st">'Portfolio_Value'</span>].cummax()</span>
<span id="cb9-479"><a href="#cb9-479" aria-hidden="true" tabindex="-1"></a>                backtested[<span class="st">'Drawdown'</span>] <span class="op">=</span> (backtested[<span class="st">'Portfolio_Value'</span>] <span class="op">/</span> backtested[<span class="st">'Peak'</span>] <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb9-480"><a href="#cb9-480" aria-hidden="true" tabindex="-1"></a>                max_dd <span class="op">=</span> backtested[<span class="st">'Drawdown'</span>].<span class="bu">min</span>()</span>
<span id="cb9-481"><a href="#cb9-481" aria-hidden="true" tabindex="-1"></a>                returns <span class="op">=</span> backtested[<span class="st">'Portfolio_Value'</span>].pct_change().dropna()</span>
<span id="cb9-482"><a href="#cb9-482" aria-hidden="true" tabindex="-1"></a>                sharpe <span class="op">=</span> (ann_ret<span class="op">/</span><span class="dv">100</span>) <span class="op">/</span> (returns.std() <span class="op">*</span> np.sqrt(<span class="dv">252</span>)) <span class="cf">if</span> returns.std()<span class="op">&gt;</span><span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-483"><a href="#cb9-483" aria-hidden="true" tabindex="-1"></a>                win_rate <span class="op">=</span> <span class="bu">len</span>([t <span class="cf">for</span> t <span class="kw">in</span> trades <span class="cf">if</span> t[<span class="st">'Profit'</span>]<span class="op">&gt;</span><span class="dv">0</span>]) <span class="op">/</span> <span class="bu">len</span>(trades)</span>
<span id="cb9-484"><a href="#cb9-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-485"><a href="#cb9-485" aria-hidden="true" tabindex="-1"></a>                res <span class="op">=</span> {</span>
<span id="cb9-486"><a href="#cb9-486" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'rsi_threshold'</span>: rsi_thresh,</span>
<span id="cb9-487"><a href="#cb9-487" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'atr_stop_multiplier'</span>: atr_stop,</span>
<span id="cb9-488"><a href="#cb9-488" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'atr_take_multiplier'</span>: atr_take,</span>
<span id="cb9-489"><a href="#cb9-489" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'total_trades'</span>: <span class="bu">len</span>(trades),</span>
<span id="cb9-490"><a href="#cb9-490" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'win_rate'</span>: win_rate,</span>
<span id="cb9-491"><a href="#cb9-491" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'total_return'</span>: total_ret,</span>
<span id="cb9-492"><a href="#cb9-492" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'annualized_return'</span>: ann_ret,</span>
<span id="cb9-493"><a href="#cb9-493" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'max_drawdown'</span>: max_dd,</span>
<span id="cb9-494"><a href="#cb9-494" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'sharpe_ratio'</span>: sharpe</span>
<span id="cb9-495"><a href="#cb9-495" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb9-496"><a href="#cb9-496" aria-hidden="true" tabindex="-1"></a>                all_results.append(res)</span>
<span id="cb9-497"><a href="#cb9-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-498"><a href="#cb9-498" aria-hidden="true" tabindex="-1"></a>                <span class="co"># 3) Use custom score to select best</span></span>
<span id="cb9-499"><a href="#cb9-499" aria-hidden="true" tabindex="-1"></a>                s <span class="op">=</span> score_fn(res)</span>
<span id="cb9-500"><a href="#cb9-500" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> s <span class="op">&gt;</span> best_score:</span>
<span id="cb9-501"><a href="#cb9-501" aria-hidden="true" tabindex="-1"></a>                    best_score <span class="op">=</span> s</span>
<span id="cb9-502"><a href="#cb9-502" aria-hidden="true" tabindex="-1"></a>                    best_params <span class="op">=</span> (rsi_thresh, atr_stop, atr_take)</span>
<span id="cb9-503"><a href="#cb9-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-504"><a href="#cb9-504" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Output results</span></span>
<span id="cb9-505"><a href="#cb9-505" aria-hidden="true" tabindex="-1"></a>    results_df <span class="op">=</span> pd.DataFrame(all_results)</span>
<span id="cb9-506"><a href="#cb9-506" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_params:</span>
<span id="cb9-507"><a href="#cb9-507" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Enhanced Best Parameters: RSI=</span><span class="sc">{</span>best_params[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">, "</span></span>
<span id="cb9-508"><a href="#cb9-508" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"ATR Stop=</span><span class="sc">{</span>best_params[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">, ATR Take=</span><span class="sc">{</span>best_params[<span class="dv">2</span>]<span class="sc">}</span><span class="ss">, Score=</span><span class="sc">{</span>best_score<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-509"><a href="#cb9-509" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb9-510"><a href="#cb9-510" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"No valid parameter combination found under constraints."</span>)</span>
<span id="cb9-511"><a href="#cb9-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-512"><a href="#cb9-512" aria-hidden="true" tabindex="-1"></a>    visualize_optimization_results(results_df)</span>
<span id="cb9-513"><a href="#cb9-513" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> best_params, results_df</span>
<span id="cb9-514"><a href="#cb9-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-515"><a href="#cb9-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-516"><a href="#cb9-516" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_optimization_results(results_df):</span>
<span id="cb9-517"><a href="#cb9-517" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-518"><a href="#cb9-518" aria-hidden="true" tabindex="-1"></a><span class="co">    Visualization of optimization results:</span></span>
<span id="cb9-519"><a href="#cb9-519" aria-hidden="true" tabindex="-1"></a><span class="co">      1) Heatmap of Sharpe Ratio by RSI vs. ATR Stop</span></span>
<span id="cb9-520"><a href="#cb9-520" aria-hidden="true" tabindex="-1"></a><span class="co">      2) Scatter of RSI vs. ATR Take (color=annualized return, size=win rate)</span></span>
<span id="cb9-521"><a href="#cb9-521" aria-hidden="true" tabindex="-1"></a><span class="co">      3) Correlation Heatmap</span></span>
<span id="cb9-522"><a href="#cb9-522" aria-hidden="true" tabindex="-1"></a><span class="co">      4) Risk-Return Scatter (max drawdown vs. total return), highlighting best Sharpe</span></span>
<span id="cb9-523"><a href="#cb9-523" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-524"><a href="#cb9-524" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> results_df <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> results_df.empty <span class="kw">or</span> <span class="bu">len</span>(results_df) <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb9-525"><a href="#cb9-525" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Not enough optimization results for visualization."</span>)</span>
<span id="cb9-526"><a href="#cb9-526" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb9-527"><a href="#cb9-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-528"><a href="#cb9-528" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Parameter optimization results available but visualization disabled."</span>)</span>
<span id="cb9-529"><a href="#cb9-529" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Best parameters from optimization process (Note: optimization Sharpe differs from final backtest): "</span>, end<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb9-530"><a href="#cb9-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-531"><a href="#cb9-531" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'sharpe_ratio'</span> <span class="kw">in</span> results_df.columns <span class="kw">and</span> <span class="kw">not</span> results_df.empty:</span>
<span id="cb9-532"><a href="#cb9-532" aria-hidden="true" tabindex="-1"></a>        best_idx <span class="op">=</span> results_df[<span class="st">'sharpe_ratio'</span>].idxmax()</span>
<span id="cb9-533"><a href="#cb9-533" aria-hidden="true" tabindex="-1"></a>        best_row <span class="op">=</span> results_df.loc[best_idx]</span>
<span id="cb9-534"><a href="#cb9-534" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"RSI=</span><span class="sc">{</span>best_row[<span class="st">'rsi_threshold'</span>]<span class="sc">}</span><span class="ss">, "</span></span>
<span id="cb9-535"><a href="#cb9-535" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"ATR Stop=</span><span class="sc">{</span>best_row[<span class="st">'atr_stop_multiplier'</span>]<span class="sc">}</span><span class="ss">, "</span></span>
<span id="cb9-536"><a href="#cb9-536" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"ATR Take=</span><span class="sc">{</span>best_row[<span class="st">'atr_take_multiplier'</span>]<span class="sc">}</span><span class="ss">, "</span></span>
<span id="cb9-537"><a href="#cb9-537" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"Optimization Sharpe=</span><span class="sc">{</span>best_row[<span class="st">'sharpe_ratio'</span>]<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-538"><a href="#cb9-538" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb9-539"><a href="#cb9-539" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"No valid Sharpe ratio data found."</span>)</span>
<span id="cb9-540"><a href="#cb9-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-541"><a href="#cb9-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-542"><a href="#cb9-542" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-543"><a href="#cb9-543" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Comprehensive Visualization</span></span>
<span id="cb9-544"><a href="#cb9-544" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-545"><a href="#cb9-545" aria-hidden="true" tabindex="-1"></a><span class="at">@safe</span></span>
<span id="cb9-546"><a href="#cb9-546" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_results(df, df_backtest, trades, symbol):</span>
<span id="cb9-547"><a href="#cb9-547" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-548"><a href="#cb9-548" aria-hidden="true" tabindex="-1"></a><span class="co">    Plot:</span></span>
<span id="cb9-549"><a href="#cb9-549" aria-hidden="true" tabindex="-1"></a><span class="co">      - Price/MAs/Bollinger + signals + RSI</span></span>
<span id="cb9-550"><a href="#cb9-550" aria-hidden="true" tabindex="-1"></a><span class="co">      - Portfolio Value &amp; Drawdown</span></span>
<span id="cb9-551"><a href="#cb9-551" aria-hidden="true" tabindex="-1"></a><span class="co">      - Monthly returns heatmap</span></span>
<span id="cb9-552"><a href="#cb9-552" aria-hidden="true" tabindex="-1"></a><span class="co">      - Trade distribution charts (profit, return, duration, etc.)</span></span>
<span id="cb9-553"><a href="#cb9-553" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-554"><a href="#cb9-554" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Generating comprehensive strategy visualizations..."</span>)</span>
<span id="cb9-555"><a href="#cb9-555" aria-hidden="true" tabindex="-1"></a>    trades_df <span class="op">=</span> pd.DataFrame(trades) <span class="cf">if</span> trades <span class="cf">else</span> pd.DataFrame()</span>
<span id="cb9-556"><a href="#cb9-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-557"><a href="#cb9-557" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb9-558"><a href="#cb9-558" aria-hidden="true" tabindex="-1"></a>        <span class="co"># --- Chart 1: Price, MAs, Bollinger, RSI, signals</span></span>
<span id="cb9-559"><a href="#cb9-559" aria-hidden="true" tabindex="-1"></a>        plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">7</span>))</span>
<span id="cb9-560"><a href="#cb9-560" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1A) Price + signals</span></span>
<span id="cb9-561"><a href="#cb9-561" aria-hidden="true" tabindex="-1"></a>        plt.subplot(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb9-562"><a href="#cb9-562" aria-hidden="true" tabindex="-1"></a>        plt.plot(df_backtest[<span class="st">'Date'</span>], df_backtest[<span class="st">'Close'</span>], label<span class="op">=</span><span class="st">'Close'</span>)</span>
<span id="cb9-563"><a href="#cb9-563" aria-hidden="true" tabindex="-1"></a>        plt.plot(df_backtest[<span class="st">'Date'</span>], df_backtest[<span class="st">'SMA20'</span>], <span class="st">'g--'</span>, label<span class="op">=</span><span class="st">'SMA20'</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb9-564"><a href="#cb9-564" aria-hidden="true" tabindex="-1"></a>        plt.plot(df_backtest[<span class="st">'Date'</span>], df_backtest[<span class="st">'SMA50'</span>], <span class="st">'r--'</span>, label<span class="op">=</span><span class="st">'SMA50'</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb9-565"><a href="#cb9-565" aria-hidden="true" tabindex="-1"></a>        plt.plot(df_backtest[<span class="st">'Date'</span>], df_backtest[<span class="st">'SMA200'</span>], <span class="st">'b--'</span>, label<span class="op">=</span><span class="st">'SMA200'</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb9-566"><a href="#cb9-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-567"><a href="#cb9-567" aria-hidden="true" tabindex="-1"></a>        plt.plot(df_backtest[<span class="st">'Date'</span>], df_backtest[<span class="st">'BB_Upper'</span>], <span class="st">'g-'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb9-568"><a href="#cb9-568" aria-hidden="true" tabindex="-1"></a>        plt.plot(df_backtest[<span class="st">'Date'</span>], df_backtest[<span class="st">'BB_Lower'</span>], <span class="st">'g-'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb9-569"><a href="#cb9-569" aria-hidden="true" tabindex="-1"></a>        plt.fill_between(df_backtest[<span class="st">'Date'</span>], df_backtest[<span class="st">'BB_Upper'</span>],</span>
<span id="cb9-570"><a href="#cb9-570" aria-hidden="true" tabindex="-1"></a>                        df_backtest[<span class="st">'BB_Lower'</span>], color<span class="op">=</span><span class="st">'g'</span>, alpha<span class="op">=</span><span class="fl">0.1</span>, label<span class="op">=</span><span class="st">'Bollinger Bands'</span>)</span>
<span id="cb9-571"><a href="#cb9-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-572"><a href="#cb9-572" aria-hidden="true" tabindex="-1"></a>        buy_signals <span class="op">=</span> df_backtest[df_backtest[<span class="st">'Signal'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb9-573"><a href="#cb9-573" aria-hidden="true" tabindex="-1"></a>        plt.scatter(buy_signals[<span class="st">'Date'</span>], buy_signals[<span class="st">'Close'</span>], marker<span class="op">=</span><span class="st">'^'</span>, color<span class="op">=</span><span class="st">'g'</span>, s<span class="op">=</span><span class="dv">100</span>, label<span class="op">=</span><span class="st">'Buy Signal'</span>)</span>
<span id="cb9-574"><a href="#cb9-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-575"><a href="#cb9-575" aria-hidden="true" tabindex="-1"></a>        exit_signals <span class="op">=</span> df_backtest[(df_backtest[<span class="st">'Signal'</span>] <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (df_backtest[<span class="st">'Trade_Profit'</span>] <span class="op">!=</span> <span class="dv">0</span>)]</span>
<span id="cb9-576"><a href="#cb9-576" aria-hidden="true" tabindex="-1"></a>        plt.scatter(exit_signals[<span class="st">'Date'</span>], exit_signals[<span class="st">'Close'</span>], marker<span class="op">=</span><span class="st">'v'</span>, color<span class="op">=</span><span class="st">'r'</span>, s<span class="op">=</span><span class="dv">100</span>, label<span class="op">=</span><span class="st">'Sell Signal'</span>)</span>
<span id="cb9-577"><a href="#cb9-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-578"><a href="#cb9-578" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="ss">f'</span><span class="sc">{</span>symbol<span class="sc">}</span><span class="ss"> - Trading Signals'</span>)</span>
<span id="cb9-579"><a href="#cb9-579" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'Price ($)'</span>)</span>
<span id="cb9-580"><a href="#cb9-580" aria-hidden="true" tabindex="-1"></a>        plt.legend(loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb9-581"><a href="#cb9-581" aria-hidden="true" tabindex="-1"></a>        plt.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb9-582"><a href="#cb9-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-583"><a href="#cb9-583" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1B) RSI</span></span>
<span id="cb9-584"><a href="#cb9-584" aria-hidden="true" tabindex="-1"></a>        plt.subplot(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb9-585"><a href="#cb9-585" aria-hidden="true" tabindex="-1"></a>        plt.plot(df_backtest[<span class="st">'Date'</span>], df_backtest[<span class="st">'RSI'</span>], label<span class="op">=</span><span class="st">'RSI'</span>)</span>
<span id="cb9-586"><a href="#cb9-586" aria-hidden="true" tabindex="-1"></a>        plt.axhline(<span class="dv">70</span>, color<span class="op">=</span><span class="st">'r'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, label<span class="op">=</span><span class="st">'Overbought (70)'</span>)</span>
<span id="cb9-587"><a href="#cb9-587" aria-hidden="true" tabindex="-1"></a>        plt.axhline(<span class="dv">40</span>, color<span class="op">=</span><span class="st">'g'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, label<span class="op">=</span><span class="st">'Oversold (40)'</span>)</span>
<span id="cb9-588"><a href="#cb9-588" aria-hidden="true" tabindex="-1"></a>        plt.fill_between(df_backtest[<span class="st">'Date'</span>], <span class="dv">0</span>, <span class="dv">40</span>, color<span class="op">=</span><span class="st">'g'</span>, alpha<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb9-589"><a href="#cb9-589" aria-hidden="true" tabindex="-1"></a>        plt.fill_between(df_backtest[<span class="st">'Date'</span>], <span class="dv">70</span>, <span class="dv">100</span>, color<span class="op">=</span><span class="st">'r'</span>, alpha<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb9-590"><a href="#cb9-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-591"><a href="#cb9-591" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> buy_signals.empty:</span>
<span id="cb9-592"><a href="#cb9-592" aria-hidden="true" tabindex="-1"></a>            plt.scatter(buy_signals[<span class="st">'Date'</span>], buy_signals[<span class="st">'RSI'</span>], marker<span class="op">=</span><span class="st">'^'</span>, color<span class="op">=</span><span class="st">'g'</span>, s<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb9-593"><a href="#cb9-593" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> exit_signals.empty:</span>
<span id="cb9-594"><a href="#cb9-594" aria-hidden="true" tabindex="-1"></a>            plt.scatter(exit_signals[<span class="st">'Date'</span>], exit_signals[<span class="st">'RSI'</span>], marker<span class="op">=</span><span class="st">'v'</span>, color<span class="op">=</span><span class="st">'r'</span>, s<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb9-595"><a href="#cb9-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-596"><a href="#cb9-596" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="st">'RSI and Signals'</span>)</span>
<span id="cb9-597"><a href="#cb9-597" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'Date'</span>)</span>
<span id="cb9-598"><a href="#cb9-598" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'RSI'</span>)</span>
<span id="cb9-599"><a href="#cb9-599" aria-hidden="true" tabindex="-1"></a>        plt.legend(loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb9-600"><a href="#cb9-600" aria-hidden="true" tabindex="-1"></a>        plt.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb9-601"><a href="#cb9-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-602"><a href="#cb9-602" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb9-603"><a href="#cb9-603" aria-hidden="true" tabindex="-1"></a>        chart1_filename <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>symbol<span class="sc">}</span><span class="ss">_trading_signals.png'</span></span>
<span id="cb9-604"><a href="#cb9-604" aria-hidden="true" tabindex="-1"></a>        plt.savefig(chart1_filename, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb9-605"><a href="#cb9-605" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb9-606"><a href="#cb9-606" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Chart 1 generated (Price &amp; RSI with signals) and saved to </span><span class="sc">{</span>chart1_filename<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-607"><a href="#cb9-607" aria-hidden="true" tabindex="-1"></a>        plt.close()</span>
<span id="cb9-608"><a href="#cb9-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-609"><a href="#cb9-609" aria-hidden="true" tabindex="-1"></a>        <span class="co"># --- Chart 2: Portfolio Value &amp; Drawdown &amp; Monthly Returns</span></span>
<span id="cb9-610"><a href="#cb9-610" aria-hidden="true" tabindex="-1"></a>        plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">10</span>))</span>
<span id="cb9-611"><a href="#cb9-611" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 2A) Portfolio</span></span>
<span id="cb9-612"><a href="#cb9-612" aria-hidden="true" tabindex="-1"></a>        plt.subplot(<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb9-613"><a href="#cb9-613" aria-hidden="true" tabindex="-1"></a>        plt.plot(df_backtest[<span class="st">'Date'</span>], df_backtest[<span class="st">'Portfolio_Value'</span>], label<span class="op">=</span><span class="st">'Portfolio Value'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb9-614"><a href="#cb9-614" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> trade <span class="kw">in</span> trades:</span>
<span id="cb9-615"><a href="#cb9-615" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Mark entry</span></span>
<span id="cb9-616"><a href="#cb9-616" aria-hidden="true" tabindex="-1"></a>            plt.scatter(trade[<span class="st">'Entry_Date'</span>],</span>
<span id="cb9-617"><a href="#cb9-617" aria-hidden="true" tabindex="-1"></a>                        df_backtest[df_backtest[<span class="st">'Date'</span>] <span class="op">==</span> trade[<span class="st">'Entry_Date'</span>]][<span class="st">'Portfolio_Value'</span>].values[<span class="dv">0</span>],</span>
<span id="cb9-618"><a href="#cb9-618" aria-hidden="true" tabindex="-1"></a>                        marker<span class="op">=</span><span class="st">'^'</span>, color<span class="op">=</span><span class="st">'g'</span>, s<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb9-619"><a href="#cb9-619" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Mark exit</span></span>
<span id="cb9-620"><a href="#cb9-620" aria-hidden="true" tabindex="-1"></a>            marker_color <span class="op">=</span> <span class="st">'g'</span> <span class="cf">if</span> trade[<span class="st">'Profit'</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'r'</span></span>
<span id="cb9-621"><a href="#cb9-621" aria-hidden="true" tabindex="-1"></a>            plt.scatter(trade[<span class="st">'Exit_Date'</span>],</span>
<span id="cb9-622"><a href="#cb9-622" aria-hidden="true" tabindex="-1"></a>                        df_backtest[df_backtest[<span class="st">'Date'</span>] <span class="op">==</span> trade[<span class="st">'Exit_Date'</span>]][<span class="st">'Portfolio_Value'</span>].values[<span class="dv">0</span>],</span>
<span id="cb9-623"><a href="#cb9-623" aria-hidden="true" tabindex="-1"></a>                        marker<span class="op">=</span><span class="st">'v'</span>, color<span class="op">=</span>marker_color, s<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb9-624"><a href="#cb9-624" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="ss">f'</span><span class="sc">{</span>symbol<span class="sc">}</span><span class="ss"> - Portfolio Value'</span>)</span>
<span id="cb9-625"><a href="#cb9-625" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'Value ($)'</span>)</span>
<span id="cb9-626"><a href="#cb9-626" aria-hidden="true" tabindex="-1"></a>        plt.legend()</span>
<span id="cb9-627"><a href="#cb9-627" aria-hidden="true" tabindex="-1"></a>        plt.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb9-628"><a href="#cb9-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-629"><a href="#cb9-629" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 2B) Drawdown</span></span>
<span id="cb9-630"><a href="#cb9-630" aria-hidden="true" tabindex="-1"></a>        plt.subplot(<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb9-631"><a href="#cb9-631" aria-hidden="true" tabindex="-1"></a>        df_backtest[<span class="st">'Peak'</span>] <span class="op">=</span> df_backtest[<span class="st">'Portfolio_Value'</span>].cummax()</span>
<span id="cb9-632"><a href="#cb9-632" aria-hidden="true" tabindex="-1"></a>        df_backtest[<span class="st">'Drawdown'</span>] <span class="op">=</span> (df_backtest[<span class="st">'Portfolio_Value'</span>] <span class="op">/</span> df_backtest[<span class="st">'Peak'</span>] <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb9-633"><a href="#cb9-633" aria-hidden="true" tabindex="-1"></a>        plt.fill_between(df_backtest[<span class="st">'Date'</span>], <span class="dv">0</span>, df_backtest[<span class="st">'Drawdown'</span>], color<span class="op">=</span><span class="st">'r'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb9-634"><a href="#cb9-634" aria-hidden="true" tabindex="-1"></a>        plt.plot(df_backtest[<span class="st">'Date'</span>], df_backtest[<span class="st">'Drawdown'</span>], <span class="st">'r'</span>, label<span class="op">=</span><span class="st">'Drawdown (%)'</span>)</span>
<span id="cb9-635"><a href="#cb9-635" aria-hidden="true" tabindex="-1"></a>        max_dd_idx <span class="op">=</span> df_backtest[<span class="st">'Drawdown'</span>].idxmin()</span>
<span id="cb9-636"><a href="#cb9-636" aria-hidden="true" tabindex="-1"></a>        max_dd <span class="op">=</span> df_backtest.iloc[max_dd_idx][<span class="st">'Drawdown'</span>]</span>
<span id="cb9-637"><a href="#cb9-637" aria-hidden="true" tabindex="-1"></a>        max_dd_date <span class="op">=</span> df_backtest.iloc[max_dd_idx][<span class="st">'Date'</span>]</span>
<span id="cb9-638"><a href="#cb9-638" aria-hidden="true" tabindex="-1"></a>        plt.scatter([max_dd_date], [max_dd], color<span class="op">=</span><span class="st">'r'</span>, s<span class="op">=</span><span class="dv">100</span>, marker<span class="op">=</span><span class="st">'*'</span>)</span>
<span id="cb9-639"><a href="#cb9-639" aria-hidden="true" tabindex="-1"></a>        plt.annotate(<span class="ss">f'Max Drawdown: </span><span class="sc">{</span>max_dd<span class="sc">:.2f}</span><span class="ss">%'</span>, xy<span class="op">=</span>(max_dd_date, max_dd), xytext<span class="op">=</span>(<span class="dv">30</span>, <span class="op">-</span><span class="dv">30</span>),</span>
<span id="cb9-640"><a href="#cb9-640" aria-hidden="true" tabindex="-1"></a>                    textcoords<span class="op">=</span><span class="st">'offset points'</span>, arrowprops<span class="op">=</span><span class="bu">dict</span>(arrowstyle<span class="op">=</span><span class="st">'-&gt;'</span>, color<span class="op">=</span><span class="st">'black'</span>))</span>
<span id="cb9-641"><a href="#cb9-641" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="st">'Drawdown Analysis'</span>)</span>
<span id="cb9-642"><a href="#cb9-642" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'Drawdown (%)'</span>)</span>
<span id="cb9-643"><a href="#cb9-643" aria-hidden="true" tabindex="-1"></a>        plt.legend()</span>
<span id="cb9-644"><a href="#cb9-644" aria-hidden="true" tabindex="-1"></a>        plt.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb9-645"><a href="#cb9-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-646"><a href="#cb9-646" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 2C) Monthly Returns Heatmap</span></span>
<span id="cb9-647"><a href="#cb9-647" aria-hidden="true" tabindex="-1"></a>        plt.subplot(<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">3</span>)</span>
<span id="cb9-648"><a href="#cb9-648" aria-hidden="true" tabindex="-1"></a>        df_backtest[<span class="st">'Daily_Return'</span>] <span class="op">=</span> df_backtest[<span class="st">'Portfolio_Value'</span>].pct_change()</span>
<span id="cb9-649"><a href="#cb9-649" aria-hidden="true" tabindex="-1"></a>        df_backtest[<span class="st">'Year'</span>] <span class="op">=</span> df_backtest[<span class="st">'Date'</span>].dt.year</span>
<span id="cb9-650"><a href="#cb9-650" aria-hidden="true" tabindex="-1"></a>        df_backtest[<span class="st">'Month'</span>] <span class="op">=</span> df_backtest[<span class="st">'Date'</span>].dt.month</span>
<span id="cb9-651"><a href="#cb9-651" aria-hidden="true" tabindex="-1"></a>        monthly_returns <span class="op">=</span> df_backtest.groupby([<span class="st">'Year'</span>, <span class="st">'Month'</span>])[<span class="st">'Daily_Return'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: (<span class="dv">1</span> <span class="op">+</span> x).prod() <span class="op">-</span> <span class="dv">1</span>).reset_index()</span>
<span id="cb9-652"><a href="#cb9-652" aria-hidden="true" tabindex="-1"></a>        monthly_returns[<span class="st">'Monthly_Return_%'</span>] <span class="op">=</span> monthly_returns[<span class="st">'Daily_Return'</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb9-653"><a href="#cb9-653" aria-hidden="true" tabindex="-1"></a>        pivot_mr <span class="op">=</span> monthly_returns.pivot(index<span class="op">=</span><span class="st">'Year'</span>, columns<span class="op">=</span><span class="st">'Month'</span>, values<span class="op">=</span><span class="st">'Monthly_Return_%'</span>)</span>
<span id="cb9-654"><a href="#cb9-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-655"><a href="#cb9-655" aria-hidden="true" tabindex="-1"></a>        im <span class="op">=</span> plt.imshow(pivot_mr, cmap<span class="op">=</span><span class="st">'RdYlGn'</span>, aspect<span class="op">=</span><span class="st">'auto'</span>)</span>
<span id="cb9-656"><a href="#cb9-656" aria-hidden="true" tabindex="-1"></a>        plt.colorbar(im, label<span class="op">=</span><span class="st">'Monthly Return (%)'</span>)</span>
<span id="cb9-657"><a href="#cb9-657" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="st">'Monthly Return Heatmap'</span>)</span>
<span id="cb9-658"><a href="#cb9-658" aria-hidden="true" tabindex="-1"></a>        plt.xlabel(<span class="st">'Month'</span>)</span>
<span id="cb9-659"><a href="#cb9-659" aria-hidden="true" tabindex="-1"></a>        plt.ylabel(<span class="st">'Year'</span>)</span>
<span id="cb9-660"><a href="#cb9-660" aria-hidden="true" tabindex="-1"></a>        plt.xticks(<span class="bu">range</span>(<span class="dv">12</span>), [<span class="st">'Jan'</span>,<span class="st">'Feb'</span>,<span class="st">'Mar'</span>,<span class="st">'Apr'</span>,<span class="st">'May'</span>,<span class="st">'Jun'</span>,<span class="st">'Jul'</span>,<span class="st">'Aug'</span>,<span class="st">'Sep'</span>,<span class="st">'Oct'</span>,<span class="st">'Nov'</span>,<span class="st">'Dec'</span>])</span>
<span id="cb9-661"><a href="#cb9-661" aria-hidden="true" tabindex="-1"></a>        plt.yticks(<span class="bu">range</span>(<span class="bu">len</span>(pivot_mr.index)), pivot_mr.index)</span>
<span id="cb9-662"><a href="#cb9-662" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(pivot_mr.shape[<span class="dv">0</span>]):</span>
<span id="cb9-663"><a href="#cb9-663" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(pivot_mr.shape[<span class="dv">1</span>]):</span>
<span id="cb9-664"><a href="#cb9-664" aria-hidden="true" tabindex="-1"></a>                val <span class="op">=</span> pivot_mr.iloc[i, j]</span>
<span id="cb9-665"><a href="#cb9-665" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> np.isnan(val):</span>
<span id="cb9-666"><a href="#cb9-666" aria-hidden="true" tabindex="-1"></a>                    plt.text(j, i, <span class="ss">f'</span><span class="sc">{</span>val<span class="sc">:.1f}</span><span class="ss">%'</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb9-667"><a href="#cb9-667" aria-hidden="true" tabindex="-1"></a>                            color<span class="op">=</span><span class="st">'black'</span> <span class="cf">if</span> <span class="bu">abs</span>(val) <span class="op">&lt;</span> <span class="dv">8</span> <span class="cf">else</span> <span class="st">'white'</span>)</span>
<span id="cb9-668"><a href="#cb9-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-669"><a href="#cb9-669" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb9-670"><a href="#cb9-670" aria-hidden="true" tabindex="-1"></a>        chart2_filename <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>symbol<span class="sc">}</span><span class="ss">_portfolio_performance.png'</span></span>
<span id="cb9-671"><a href="#cb9-671" aria-hidden="true" tabindex="-1"></a>        plt.savefig(chart2_filename, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb9-672"><a href="#cb9-672" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb9-673"><a href="#cb9-673" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Chart 2 generated (Portfolio value, Drawdown, Monthly returns) and saved to </span><span class="sc">{</span>chart2_filename<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-674"><a href="#cb9-674" aria-hidden="true" tabindex="-1"></a>        plt.close()</span>
<span id="cb9-675"><a href="#cb9-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-676"><a href="#cb9-676" aria-hidden="true" tabindex="-1"></a>        <span class="co"># --- Chart 3: Trade-level distribution analysis</span></span>
<span id="cb9-677"><a href="#cb9-677" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> trades_df.empty:</span>
<span id="cb9-678"><a href="#cb9-678" aria-hidden="true" tabindex="-1"></a>            plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">10</span>))</span>
<span id="cb9-679"><a href="#cb9-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-680"><a href="#cb9-680" aria-hidden="true" tabindex="-1"></a>            plt.subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb9-681"><a href="#cb9-681" aria-hidden="true" tabindex="-1"></a>            plt.hist(trades_df[<span class="st">'Profit'</span>], bins<span class="op">=</span><span class="dv">10</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'skyblue'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb9-682"><a href="#cb9-682" aria-hidden="true" tabindex="-1"></a>            plt.axvline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'r'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb9-683"><a href="#cb9-683" aria-hidden="true" tabindex="-1"></a>            plt.title(<span class="st">'Trade Profit Distribution'</span>)</span>
<span id="cb9-684"><a href="#cb9-684" aria-hidden="true" tabindex="-1"></a>            plt.xlabel(<span class="st">'Profit ($)'</span>)</span>
<span id="cb9-685"><a href="#cb9-685" aria-hidden="true" tabindex="-1"></a>            plt.ylabel(<span class="st">'Number of Trades'</span>)</span>
<span id="cb9-686"><a href="#cb9-686" aria-hidden="true" tabindex="-1"></a>            plt.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb9-687"><a href="#cb9-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-688"><a href="#cb9-688" aria-hidden="true" tabindex="-1"></a>            plt.subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb9-689"><a href="#cb9-689" aria-hidden="true" tabindex="-1"></a>            plt.hist(trades_df[<span class="st">'Return'</span>] <span class="op">*</span> <span class="dv">100</span>, bins<span class="op">=</span><span class="dv">10</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'lightgreen'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb9-690"><a href="#cb9-690" aria-hidden="true" tabindex="-1"></a>            plt.axvline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'r'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb9-691"><a href="#cb9-691" aria-hidden="true" tabindex="-1"></a>            plt.title(<span class="st">'Trade Return Distribution'</span>)</span>
<span id="cb9-692"><a href="#cb9-692" aria-hidden="true" tabindex="-1"></a>            plt.xlabel(<span class="st">'Return (%)'</span>)</span>
<span id="cb9-693"><a href="#cb9-693" aria-hidden="true" tabindex="-1"></a>            plt.ylabel(<span class="st">'Number of Trades'</span>)</span>
<span id="cb9-694"><a href="#cb9-694" aria-hidden="true" tabindex="-1"></a>            plt.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb9-695"><a href="#cb9-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-696"><a href="#cb9-696" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Duration-based stats</span></span>
<span id="cb9-697"><a href="#cb9-697" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'Entry_Date'</span> <span class="kw">in</span> trades_df.columns <span class="kw">and</span> <span class="st">'Exit_Date'</span> <span class="kw">in</span> trades_df.columns:</span>
<span id="cb9-698"><a href="#cb9-698" aria-hidden="true" tabindex="-1"></a>                trades_df[<span class="st">'Duration'</span>] <span class="op">=</span> (trades_df[<span class="st">'Exit_Date'</span>] <span class="op">-</span> trades_df[<span class="st">'Entry_Date'</span>]).dt.days</span>
<span id="cb9-699"><a href="#cb9-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-700"><a href="#cb9-700" aria-hidden="true" tabindex="-1"></a>                plt.subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb9-701"><a href="#cb9-701" aria-hidden="true" tabindex="-1"></a>                plt.hist(trades_df[<span class="st">'Duration'</span>], bins<span class="op">=</span><span class="dv">10</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'salmon'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb9-702"><a href="#cb9-702" aria-hidden="true" tabindex="-1"></a>                plt.title(<span class="st">'Trade Duration Distribution'</span>)</span>
<span id="cb9-703"><a href="#cb9-703" aria-hidden="true" tabindex="-1"></a>                plt.xlabel(<span class="st">'Duration (days)'</span>)</span>
<span id="cb9-704"><a href="#cb9-704" aria-hidden="true" tabindex="-1"></a>                plt.ylabel(<span class="st">'Number of Trades'</span>)</span>
<span id="cb9-705"><a href="#cb9-705" aria-hidden="true" tabindex="-1"></a>                plt.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb9-706"><a href="#cb9-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-707"><a href="#cb9-707" aria-hidden="true" tabindex="-1"></a>                plt.subplot(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">4</span>)</span>
<span id="cb9-708"><a href="#cb9-708" aria-hidden="true" tabindex="-1"></a>                scatter <span class="op">=</span> plt.scatter(trades_df[<span class="st">'Duration'</span>], trades_df[<span class="st">'Return'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb9-709"><a href="#cb9-709" aria-hidden="true" tabindex="-1"></a>                                    c<span class="op">=</span>trades_df[<span class="st">'Profit'</span>], cmap<span class="op">=</span><span class="st">'coolwarm'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, s<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb9-710"><a href="#cb9-710" aria-hidden="true" tabindex="-1"></a>                plt.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'k'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb9-711"><a href="#cb9-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-712"><a href="#cb9-712" aria-hidden="true" tabindex="-1"></a>                plt.title(<span class="st">'Trade Duration vs. Return'</span>)</span>
<span id="cb9-713"><a href="#cb9-713" aria-hidden="true" tabindex="-1"></a>                plt.xlabel(<span class="st">'Duration (days)'</span>)</span>
<span id="cb9-714"><a href="#cb9-714" aria-hidden="true" tabindex="-1"></a>                plt.ylabel(<span class="st">'Return (%)'</span>)</span>
<span id="cb9-715"><a href="#cb9-715" aria-hidden="true" tabindex="-1"></a>                plt.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb9-716"><a href="#cb9-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-717"><a href="#cb9-717" aria-hidden="true" tabindex="-1"></a>            plt.tight_layout()</span>
<span id="cb9-718"><a href="#cb9-718" aria-hidden="true" tabindex="-1"></a>            chart3_filename <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>symbol<span class="sc">}</span><span class="ss">_trade_analysis.png'</span></span>
<span id="cb9-719"><a href="#cb9-719" aria-hidden="true" tabindex="-1"></a>            plt.savefig(chart3_filename, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb9-720"><a href="#cb9-720" aria-hidden="true" tabindex="-1"></a>            plt.show()</span>
<span id="cb9-721"><a href="#cb9-721" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Chart 3 generated (Trade distribution) and saved to </span><span class="sc">{</span>chart3_filename<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-722"><a href="#cb9-722" aria-hidden="true" tabindex="-1"></a>            plt.close()</span>
<span id="cb9-723"><a href="#cb9-723" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb9-724"><a href="#cb9-724" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"No trade data for detailed trade analysis."</span>)</span>
<span id="cb9-725"><a href="#cb9-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-726"><a href="#cb9-726" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb9-727"><a href="#cb9-727" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error in visualization: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-728"><a href="#cb9-728" aria-hidden="true" tabindex="-1"></a>        plt.close(<span class="st">'all'</span>)  <span class="co"># Ensure all plots are closed on error</span></span>
<span id="cb9-729"><a href="#cb9-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-730"><a href="#cb9-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-731"><a href="#cb9-731" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-732"><a href="#cb9-732" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Advanced Metrics Visualization</span></span>
<span id="cb9-733"><a href="#cb9-733" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-734"><a href="#cb9-734" aria-hidden="true" tabindex="-1"></a><span class="at">@safe</span></span>
<span id="cb9-735"><a href="#cb9-735" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_advanced_metrics(df_backtest, window<span class="op">=</span><span class="dv">30</span>):</span>
<span id="cb9-736"><a href="#cb9-736" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-737"><a href="#cb9-737" aria-hidden="true" tabindex="-1"></a><span class="co">    Visualize:</span></span>
<span id="cb9-738"><a href="#cb9-738" aria-hidden="true" tabindex="-1"></a><span class="co">      - Daily returns distribution</span></span>
<span id="cb9-739"><a href="#cb9-739" aria-hidden="true" tabindex="-1"></a><span class="co">      - Drawdown distribution</span></span>
<span id="cb9-740"><a href="#cb9-740" aria-hidden="true" tabindex="-1"></a><span class="co">      - Rolling annualized return &amp; rolling annualized volatility</span></span>
<span id="cb9-741"><a href="#cb9-741" aria-hidden="true" tabindex="-1"></a><span class="co">      - Rolling Sharpe ratio</span></span>
<span id="cb9-742"><a href="#cb9-742" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-743"><a href="#cb9-743" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'Portfolio_Value'</span> <span class="kw">not</span> <span class="kw">in</span> df_backtest.columns <span class="kw">or</span> df_backtest.empty:</span>
<span id="cb9-744"><a href="#cb9-744" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"No portfolio data available for advanced metrics."</span>)</span>
<span id="cb9-745"><a href="#cb9-745" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb9-746"><a href="#cb9-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-747"><a href="#cb9-747" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Advanced metrics visualization disabled."</span>)</span>
<span id="cb9-748"><a href="#cb9-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-749"><a href="#cb9-749" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate and print summary statistics instead</span></span>
<span id="cb9-750"><a href="#cb9-750" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'Daily_Return'</span> <span class="kw">not</span> <span class="kw">in</span> df_backtest.columns:</span>
<span id="cb9-751"><a href="#cb9-751" aria-hidden="true" tabindex="-1"></a>        df_backtest[<span class="st">'Daily_Return'</span>] <span class="op">=</span> df_backtest[<span class="st">'Portfolio_Value'</span>].pct_change()</span>
<span id="cb9-752"><a href="#cb9-752" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'Drawdown'</span> <span class="kw">not</span> <span class="kw">in</span> df_backtest.columns:</span>
<span id="cb9-753"><a href="#cb9-753" aria-hidden="true" tabindex="-1"></a>        df_backtest[<span class="st">'Peak'</span>] <span class="op">=</span> df_backtest[<span class="st">'Portfolio_Value'</span>].cummax()</span>
<span id="cb9-754"><a href="#cb9-754" aria-hidden="true" tabindex="-1"></a>        df_backtest[<span class="st">'Drawdown'</span>] <span class="op">=</span> (df_backtest[<span class="st">'Portfolio_Value'</span>] <span class="op">/</span> df_backtest[<span class="st">'Peak'</span>] <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb9-755"><a href="#cb9-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-756"><a href="#cb9-756" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print some basic statistics</span></span>
<span id="cb9-757"><a href="#cb9-757" aria-hidden="true" tabindex="-1"></a>    daily_returns <span class="op">=</span> df_backtest[<span class="st">'Daily_Return'</span>].dropna()</span>
<span id="cb9-758"><a href="#cb9-758" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Daily Returns - Mean: </span><span class="sc">{</span>daily_returns<span class="sc">.</span>mean()<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%, Std Dev: </span><span class="sc">{</span>daily_returns<span class="sc">.</span>std()<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb9-759"><a href="#cb9-759" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Max Drawdown: </span><span class="sc">{</span>df_backtest[<span class="st">'Drawdown'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb9-760"><a href="#cb9-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-761"><a href="#cb9-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-762"><a href="#cb9-762" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-763"><a href="#cb9-763" aria-hidden="true" tabindex="-1"></a><span class="co"># 8.1 Trade Blotter and Ledger</span></span>
<span id="cb9-764"><a href="#cb9-764" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-765"><a href="#cb9-765" aria-hidden="true" tabindex="-1"></a><span class="at">@safe</span></span>
<span id="cb9-766"><a href="#cb9-766" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_blotter(trades, detailed<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb9-767"><a href="#cb9-767" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-768"><a href="#cb9-768" aria-hidden="true" tabindex="-1"></a><span class="co">    Print trade record book showing detailed information for all trades.</span></span>
<span id="cb9-769"><a href="#cb9-769" aria-hidden="true" tabindex="-1"></a><span class="co">    Includes: entry date, exit date, holding days, prices, shares, profit/loss, and return rate.</span></span>
<span id="cb9-770"><a href="#cb9-770" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-771"><a href="#cb9-771" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> trades:</span>
<span id="cb9-772"><a href="#cb9-772" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"No trades to display in blotter."</span>)</span>
<span id="cb9-773"><a href="#cb9-773" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb9-774"><a href="#cb9-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-775"><a href="#cb9-775" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to DataFrame for analysis</span></span>
<span id="cb9-776"><a href="#cb9-776" aria-hidden="true" tabindex="-1"></a>    trades_df <span class="op">=</span> pd.DataFrame(trades)</span>
<span id="cb9-777"><a href="#cb9-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-778"><a href="#cb9-778" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate key statistics</span></span>
<span id="cb9-779"><a href="#cb9-779" aria-hidden="true" tabindex="-1"></a>    total_trades <span class="op">=</span> <span class="bu">len</span>(trades_df)</span>
<span id="cb9-780"><a href="#cb9-780" aria-hidden="true" tabindex="-1"></a>    win_trades <span class="op">=</span> <span class="bu">len</span>(trades_df[trades_df[<span class="st">'Profit'</span>] <span class="op">&gt;</span> <span class="dv">0</span>])</span>
<span id="cb9-781"><a href="#cb9-781" aria-hidden="true" tabindex="-1"></a>    loss_trades <span class="op">=</span> total_trades <span class="op">-</span> win_trades</span>
<span id="cb9-782"><a href="#cb9-782" aria-hidden="true" tabindex="-1"></a>    win_rate <span class="op">=</span> (win_trades <span class="op">/</span> total_trades <span class="op">*</span> <span class="dv">100</span>) <span class="cf">if</span> total_trades <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-783"><a href="#cb9-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-784"><a href="#cb9-784" aria-hidden="true" tabindex="-1"></a>    total_profit <span class="op">=</span> trades_df[<span class="st">'Profit'</span>].<span class="bu">sum</span>()</span>
<span id="cb9-785"><a href="#cb9-785" aria-hidden="true" tabindex="-1"></a>    avg_profit <span class="op">=</span> trades_df[<span class="st">'Profit'</span>].mean()</span>
<span id="cb9-786"><a href="#cb9-786" aria-hidden="true" tabindex="-1"></a>    avg_profit_win <span class="op">=</span> trades_df[trades_df[<span class="st">'Profit'</span>] <span class="op">&gt;</span> <span class="dv">0</span>][<span class="st">'Profit'</span>].mean() <span class="cf">if</span> win_trades <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-787"><a href="#cb9-787" aria-hidden="true" tabindex="-1"></a>    avg_loss <span class="op">=</span> trades_df[trades_df[<span class="st">'Profit'</span>] <span class="op">&lt;=</span> <span class="dv">0</span>][<span class="st">'Profit'</span>].mean() <span class="cf">if</span> loss_trades <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-788"><a href="#cb9-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-789"><a href="#cb9-789" aria-hidden="true" tabindex="-1"></a>    max_profit <span class="op">=</span> trades_df[<span class="st">'Profit'</span>].<span class="bu">max</span>() <span class="cf">if</span> <span class="kw">not</span> trades_df.empty <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-790"><a href="#cb9-790" aria-hidden="true" tabindex="-1"></a>    max_loss <span class="op">=</span> trades_df[<span class="st">'Profit'</span>].<span class="bu">min</span>() <span class="cf">if</span> <span class="kw">not</span> trades_df.empty <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-791"><a href="#cb9-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-792"><a href="#cb9-792" aria-hidden="true" tabindex="-1"></a>    avg_hold_days <span class="op">=</span> trades_df[<span class="st">'Duration'</span>].mean() <span class="cf">if</span> <span class="st">'Duration'</span> <span class="kw">in</span> trades_df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb9-793"><a href="#cb9-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-794"><a href="#cb9-794" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate profit-loss ratio</span></span>
<span id="cb9-795"><a href="#cb9-795" aria-hidden="true" tabindex="-1"></a>    profit_loss_ratio <span class="op">=</span> <span class="bu">abs</span>(avg_profit_win <span class="op">/</span> avg_loss) <span class="cf">if</span> avg_loss <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> <span class="bu">float</span>(<span class="st">'inf'</span>)</span>
<span id="cb9-796"><a href="#cb9-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-797"><a href="#cb9-797" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate ROI</span></span>
<span id="cb9-798"><a href="#cb9-798" aria-hidden="true" tabindex="-1"></a>    initial_capital <span class="op">=</span> <span class="dv">100000</span>  <span class="co"># Assumed $100,000 initial capital</span></span>
<span id="cb9-799"><a href="#cb9-799" aria-hidden="true" tabindex="-1"></a>    roi <span class="op">=</span> (total_profit <span class="op">/</span> initial_capital) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb9-800"><a href="#cb9-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-801"><a href="#cb9-801" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print trade blotter</span></span>
<span id="cb9-802"><a href="#cb9-802" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb9-803"><a href="#cb9-803" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"                  BLOTTER (TRADE RECORD)                 "</span>)</span>
<span id="cb9-804"><a href="#cb9-804" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb9-805"><a href="#cb9-805" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="sc">{:&lt;12}</span><span class="st"> </span><span class="sc">{:&lt;12}</span><span class="st"> </span><span class="sc">{:&lt;8}</span><span class="st"> </span><span class="sc">{:&lt;10}</span><span class="st"> </span><span class="sc">{:&lt;10}</span><span class="st"> </span><span class="sc">{:&lt;10}</span><span class="st"> </span><span class="sc">{:&lt;12}</span><span class="st"> </span><span class="sc">{:&lt;10}</span><span class="st"> </span><span class="sc">{:&lt;15}</span><span class="st">"</span>.<span class="bu">format</span>(</span>
<span id="cb9-806"><a href="#cb9-806" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Entry Date"</span>, <span class="st">"Exit Date"</span>, <span class="st">"Days"</span>, <span class="st">"Entry"</span>, <span class="st">"Exit"</span>, <span class="st">"Shares"</span>, <span class="st">"Profit/Loss"</span>, <span class="st">"Return"</span>, <span class="st">"Exit Reason"</span></span>
<span id="cb9-807"><a href="#cb9-807" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb9-808"><a href="#cb9-808" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">110</span>)</span>
<span id="cb9-809"><a href="#cb9-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-810"><a href="#cb9-810" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by entry date</span></span>
<span id="cb9-811"><a href="#cb9-811" aria-hidden="true" tabindex="-1"></a>    trades_df <span class="op">=</span> trades_df.sort_values(<span class="st">'Entry_Date'</span>)</span>
<span id="cb9-812"><a href="#cb9-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-813"><a href="#cb9-813" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, trade <span class="kw">in</span> trades_df.iterrows():</span>
<span id="cb9-814"><a href="#cb9-814" aria-hidden="true" tabindex="-1"></a>        entry_date <span class="op">=</span> trade[<span class="st">'Entry_Date'</span>].strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)</span>
<span id="cb9-815"><a href="#cb9-815" aria-hidden="true" tabindex="-1"></a>        exit_date <span class="op">=</span> trade[<span class="st">'Exit_Date'</span>].strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>) <span class="cf">if</span> pd.notna(trade[<span class="st">'Exit_Date'</span>]) <span class="cf">else</span> <span class="st">'Open'</span></span>
<span id="cb9-816"><a href="#cb9-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-817"><a href="#cb9-817" aria-hidden="true" tabindex="-1"></a>        hold_days <span class="op">=</span> trade[<span class="st">'Duration'</span>] <span class="cf">if</span> <span class="st">'Duration'</span> <span class="kw">in</span> trade <span class="cf">else</span> (</span>
<span id="cb9-818"><a href="#cb9-818" aria-hidden="true" tabindex="-1"></a>            (trade[<span class="st">'Exit_Date'</span>] <span class="op">-</span> trade[<span class="st">'Entry_Date'</span>]).days <span class="cf">if</span> pd.notna(trade[<span class="st">'Exit_Date'</span>]) <span class="cf">else</span> <span class="st">'N/A'</span></span>
<span id="cb9-819"><a href="#cb9-819" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-820"><a href="#cb9-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-821"><a href="#cb9-821" aria-hidden="true" tabindex="-1"></a>        entry_price <span class="op">=</span> <span class="ss">f"$</span><span class="sc">{</span>trade[<span class="st">'Entry_Price'</span>]<span class="sc">:.2f}</span><span class="ss">"</span></span>
<span id="cb9-822"><a href="#cb9-822" aria-hidden="true" tabindex="-1"></a>        exit_price <span class="op">=</span> <span class="ss">f"$</span><span class="sc">{</span>trade[<span class="st">'Exit_Price'</span>]<span class="sc">:.2f}</span><span class="ss">"</span> <span class="cf">if</span> pd.notna(trade[<span class="st">'Exit_Price'</span>]) <span class="cf">else</span> <span class="st">'N/A'</span></span>
<span id="cb9-823"><a href="#cb9-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-824"><a href="#cb9-824" aria-hidden="true" tabindex="-1"></a>        shares <span class="op">=</span> <span class="bu">int</span>(trade[<span class="st">'Shares'</span>])</span>
<span id="cb9-825"><a href="#cb9-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-826"><a href="#cb9-826" aria-hidden="true" tabindex="-1"></a>        profit_loss <span class="op">=</span> trade[<span class="st">'Profit'</span>]</span>
<span id="cb9-827"><a href="#cb9-827" aria-hidden="true" tabindex="-1"></a>        profit_loss_str <span class="op">=</span> <span class="ss">f"$</span><span class="sc">{</span>profit_loss<span class="sc">:.2f}</span><span class="ss">"</span></span>
<span id="cb9-828"><a href="#cb9-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-829"><a href="#cb9-829" aria-hidden="true" tabindex="-1"></a>        return_pct <span class="op">=</span> trade[<span class="st">'Return'</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb9-830"><a href="#cb9-830" aria-hidden="true" tabindex="-1"></a>        return_str <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>return_pct<span class="sc">:.2f}</span><span class="ss">%"</span></span>
<span id="cb9-831"><a href="#cb9-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-832"><a href="#cb9-832" aria-hidden="true" tabindex="-1"></a>        exit_reason <span class="op">=</span> trade.get(<span class="st">'Exit_Reason'</span>, <span class="st">'N/A'</span>)</span>
<span id="cb9-833"><a href="#cb9-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-834"><a href="#cb9-834" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="sc">{:&lt;12}</span><span class="st"> </span><span class="sc">{:&lt;12}</span><span class="st"> </span><span class="sc">{:&lt;8}</span><span class="st"> </span><span class="sc">{:&lt;10}</span><span class="st"> </span><span class="sc">{:&lt;10}</span><span class="st"> </span><span class="sc">{:&lt;10}</span><span class="st"> </span><span class="sc">{:&lt;12}</span><span class="st"> </span><span class="sc">{:&lt;10}</span><span class="st"> </span><span class="sc">{:&lt;15}</span><span class="st">"</span>.<span class="bu">format</span>(</span>
<span id="cb9-835"><a href="#cb9-835" aria-hidden="true" tabindex="-1"></a>            entry_date, exit_date, hold_days, entry_price, exit_price, shares,</span>
<span id="cb9-836"><a href="#cb9-836" aria-hidden="true" tabindex="-1"></a>            profit_loss_str, return_str, exit_reason</span>
<span id="cb9-837"><a href="#cb9-837" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb9-838"><a href="#cb9-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-839"><a href="#cb9-839" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">110</span>)</span>
<span id="cb9-840"><a href="#cb9-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-841"><a href="#cb9-841" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Analyze exit reasons</span></span>
<span id="cb9-842"><a href="#cb9-842" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'Exit_Reason'</span> <span class="kw">in</span> trades_df.columns <span class="kw">and</span> <span class="kw">not</span> trades_df.empty:</span>
<span id="cb9-843"><a href="#cb9-843" aria-hidden="true" tabindex="-1"></a>        reason_stats <span class="op">=</span> trades_df.groupby(<span class="st">'Exit_Reason'</span>).agg({</span>
<span id="cb9-844"><a href="#cb9-844" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Profit'</span>: [<span class="st">'count'</span>, <span class="st">'mean'</span>, <span class="st">'sum'</span>],</span>
<span id="cb9-845"><a href="#cb9-845" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Return'</span>: <span class="st">'mean'</span>,</span>
<span id="cb9-846"><a href="#cb9-846" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Duration'</span>: <span class="st">'mean'</span></span>
<span id="cb9-847"><a href="#cb9-847" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb9-848"><a href="#cb9-848" aria-hidden="true" tabindex="-1"></a>        reason_stats.columns <span class="op">=</span> [<span class="st">'Count'</span>, <span class="st">'Avg Profit'</span>, <span class="st">'Total Profit'</span>, <span class="st">'Avg Return'</span>, <span class="st">'Avg Duration'</span>]</span>
<span id="cb9-849"><a href="#cb9-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-850"><a href="#cb9-850" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">===== EXIT REASON ANALYSIS ====="</span>)</span>
<span id="cb9-851"><a href="#cb9-851" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> reason, row <span class="kw">in</span> reason_stats.iterrows():</span>
<span id="cb9-852"><a href="#cb9-852" aria-hidden="true" tabindex="-1"></a>            win_count <span class="op">=</span> <span class="bu">len</span>(trades_df[(trades_df[<span class="st">'Exit_Reason'</span>] <span class="op">==</span> reason) <span class="op">&amp;</span> (trades_df[<span class="st">'Profit'</span>] <span class="op">&gt;</span> <span class="dv">0</span>)])</span>
<span id="cb9-853"><a href="#cb9-853" aria-hidden="true" tabindex="-1"></a>            win_rate_reason <span class="op">=</span> (win_count <span class="op">/</span> row[<span class="st">'Count'</span>]) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb9-854"><a href="#cb9-854" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>reason<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>row[<span class="st">'Count'</span>]<span class="sc">}</span><span class="ss"> trades, Win Rate: </span><span class="sc">{</span>win_rate_reason<span class="sc">:.1f}</span><span class="ss">%, "</span></span>
<span id="cb9-855"><a href="#cb9-855" aria-hidden="true" tabindex="-1"></a>                  <span class="ss">f"Avg Profit: $</span><span class="sc">{</span>row[<span class="st">'Avg Profit'</span>]<span class="sc">:.2f}</span><span class="ss">, Total: $</span><span class="sc">{</span>row[<span class="st">'Total Profit'</span>]<span class="sc">:.2f}</span><span class="ss">, "</span></span>
<span id="cb9-856"><a href="#cb9-856" aria-hidden="true" tabindex="-1"></a>                  <span class="ss">f"Avg Duration: </span><span class="sc">{</span>row[<span class="st">'Avg Duration'</span>]<span class="sc">:.1f}</span><span class="ss"> days"</span>)</span>
<span id="cb9-857"><a href="#cb9-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-858"><a href="#cb9-858" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print summary statistics</span></span>
<span id="cb9-859"><a href="#cb9-859" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">===== TRADE STATISTICS ====="</span>)</span>
<span id="cb9-860"><a href="#cb9-860" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total Trades: </span><span class="sc">{</span>total_trades<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-861"><a href="#cb9-861" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Winning Trades: </span><span class="sc">{</span>win_trades<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>win_rate<span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb9-862"><a href="#cb9-862" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Losing Trades: </span><span class="sc">{</span>loss_trades<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="dv">100</span><span class="op">-</span>win_rate<span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb9-863"><a href="#cb9-863" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total Profit/Loss: $</span><span class="sc">{</span>total_profit<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-864"><a href="#cb9-864" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Average Profit/Loss: $</span><span class="sc">{</span>avg_profit<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-865"><a href="#cb9-865" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Average Win: $</span><span class="sc">{</span>avg_profit_win<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-866"><a href="#cb9-866" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Average Loss: $</span><span class="sc">{</span>avg_loss<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-867"><a href="#cb9-867" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Profit/Loss Ratio: </span><span class="sc">{</span>profit_loss_ratio<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-868"><a href="#cb9-868" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Largest Win: $</span><span class="sc">{</span>max_profit<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-869"><a href="#cb9-869" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Largest Loss: $</span><span class="sc">{</span>max_loss<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-870"><a href="#cb9-870" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> avg_hold_days <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb9-871"><a href="#cb9-871" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Average Holding Period: </span><span class="sc">{</span>avg_hold_days<span class="sc">:.1f}</span><span class="ss"> days"</span>)</span>
<span id="cb9-872"><a href="#cb9-872" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Return on Investment (ROI): </span><span class="sc">{</span>roi<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb9-873"><a href="#cb9-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-874"><a href="#cb9-874" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate best and worst trades</span></span>
<span id="cb9-875"><a href="#cb9-875" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> trades_df.empty:</span>
<span id="cb9-876"><a href="#cb9-876" aria-hidden="true" tabindex="-1"></a>        best_trade <span class="op">=</span> trades_df.loc[trades_df[<span class="st">'Profit'</span>].idxmax()]</span>
<span id="cb9-877"><a href="#cb9-877" aria-hidden="true" tabindex="-1"></a>        worst_trade <span class="op">=</span> trades_df.loc[trades_df[<span class="st">'Profit'</span>].idxmin()]</span>
<span id="cb9-878"><a href="#cb9-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-879"><a href="#cb9-879" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">===== BEST TRADE ====="</span>)</span>
<span id="cb9-880"><a href="#cb9-880" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Date: </span><span class="sc">{</span>best_trade[<span class="st">'Entry_Date'</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>best_trade[<span class="st">'Exit_Date'</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-881"><a href="#cb9-881" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Holding Days: </span><span class="sc">{</span>best_trade<span class="sc">.</span>get(<span class="st">'Duration'</span>, <span class="st">'N/A'</span>)<span class="sc">}</span><span class="ss"> days"</span>)</span>
<span id="cb9-882"><a href="#cb9-882" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Entry Price: $</span><span class="sc">{</span>best_trade[<span class="st">'Entry_Price'</span>]<span class="sc">:.2f}</span><span class="ss">, Exit Price: $</span><span class="sc">{</span>best_trade[<span class="st">'Exit_Price'</span>]<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-883"><a href="#cb9-883" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Shares: </span><span class="sc">{</span><span class="bu">int</span>(best_trade[<span class="st">'Shares'</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-884"><a href="#cb9-884" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Profit: $</span><span class="sc">{</span>best_trade[<span class="st">'Profit'</span>]<span class="sc">:.2f}</span><span class="ss"> (</span><span class="sc">{</span>best_trade[<span class="st">'Return'</span>]<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb9-885"><a href="#cb9-885" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Exit Reason: </span><span class="sc">{</span>best_trade<span class="sc">.</span>get(<span class="st">'Exit_Reason'</span>, <span class="st">'N/A'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-886"><a href="#cb9-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-887"><a href="#cb9-887" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">===== WORST TRADE ====="</span>)</span>
<span id="cb9-888"><a href="#cb9-888" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Date: </span><span class="sc">{</span>worst_trade[<span class="st">'Entry_Date'</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>worst_trade[<span class="st">'Exit_Date'</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-889"><a href="#cb9-889" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Holding Days: </span><span class="sc">{</span>worst_trade<span class="sc">.</span>get(<span class="st">'Duration'</span>, <span class="st">'N/A'</span>)<span class="sc">}</span><span class="ss"> days"</span>)</span>
<span id="cb9-890"><a href="#cb9-890" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Entry Price: $</span><span class="sc">{</span>worst_trade[<span class="st">'Entry_Price'</span>]<span class="sc">:.2f}</span><span class="ss">, Exit Price: $</span><span class="sc">{</span>worst_trade[<span class="st">'Exit_Price'</span>]<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-891"><a href="#cb9-891" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Shares: </span><span class="sc">{</span><span class="bu">int</span>(worst_trade[<span class="st">'Shares'</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-892"><a href="#cb9-892" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Loss: $</span><span class="sc">{</span>worst_trade[<span class="st">'Profit'</span>]<span class="sc">:.2f}</span><span class="ss"> (</span><span class="sc">{</span>worst_trade[<span class="st">'Return'</span>]<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb9-893"><a href="#cb9-893" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Exit Reason: </span><span class="sc">{</span>worst_trade<span class="sc">.</span>get(<span class="st">'Exit_Reason'</span>, <span class="st">'N/A'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-894"><a href="#cb9-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-895"><a href="#cb9-895" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If detailed flag is true, add more detailed analysis</span></span>
<span id="cb9-896"><a href="#cb9-896" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> detailed <span class="kw">and</span> total_trades <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-897"><a href="#cb9-897" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">===== DETAILED ANALYSIS ====="</span>)</span>
<span id="cb9-898"><a href="#cb9-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-899"><a href="#cb9-899" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Group by month/week</span></span>
<span id="cb9-900"><a href="#cb9-900" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'Entry_Date'</span> <span class="kw">in</span> trades_df.columns:</span>
<span id="cb9-901"><a href="#cb9-901" aria-hidden="true" tabindex="-1"></a>            trades_df[<span class="st">'Month'</span>] <span class="op">=</span> trades_df[<span class="st">'Entry_Date'</span>].dt.strftime(<span class="st">'%Y-%m'</span>)</span>
<span id="cb9-902"><a href="#cb9-902" aria-hidden="true" tabindex="-1"></a>            monthly_profit <span class="op">=</span> trades_df.groupby(<span class="st">'Month'</span>)[<span class="st">'Profit'</span>].<span class="bu">sum</span>()</span>
<span id="cb9-903"><a href="#cb9-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-904"><a href="#cb9-904" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Monthly Profit/Loss:"</span>)</span>
<span id="cb9-905"><a href="#cb9-905" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> month, profit <span class="kw">in</span> monthly_profit.items():</span>
<span id="cb9-906"><a href="#cb9-906" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>month<span class="sc">}</span><span class="ss">: $</span><span class="sc">{</span>profit<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-907"><a href="#cb9-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-908"><a href="#cb9-908" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Analyze consecutive wins/losses</span></span>
<span id="cb9-909"><a href="#cb9-909" aria-hidden="true" tabindex="-1"></a>        trade_results <span class="op">=</span> [<span class="dv">1</span> <span class="cf">if</span> p <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span> <span class="cf">for</span> p <span class="kw">in</span> trades_df[<span class="st">'Profit'</span>]]</span>
<span id="cb9-910"><a href="#cb9-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-911"><a href="#cb9-911" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate max consecutive wins (inline function)</span></span>
<span id="cb9-912"><a href="#cb9-912" aria-hidden="true" tabindex="-1"></a>        max_consecutive_wins <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-913"><a href="#cb9-913" aria-hidden="true" tabindex="-1"></a>        current_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-914"><a href="#cb9-914" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> v <span class="kw">in</span> trade_results:</span>
<span id="cb9-915"><a href="#cb9-915" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> v <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb9-916"><a href="#cb9-916" aria-hidden="true" tabindex="-1"></a>                current_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb9-917"><a href="#cb9-917" aria-hidden="true" tabindex="-1"></a>                max_consecutive_wins <span class="op">=</span> <span class="bu">max</span>(max_consecutive_wins, current_count)</span>
<span id="cb9-918"><a href="#cb9-918" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb9-919"><a href="#cb9-919" aria-hidden="true" tabindex="-1"></a>                current_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-920"><a href="#cb9-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-921"><a href="#cb9-921" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate max consecutive losses (inline function)</span></span>
<span id="cb9-922"><a href="#cb9-922" aria-hidden="true" tabindex="-1"></a>        max_consecutive_losses <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-923"><a href="#cb9-923" aria-hidden="true" tabindex="-1"></a>        current_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-924"><a href="#cb9-924" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> v <span class="kw">in</span> trade_results:</span>
<span id="cb9-925"><a href="#cb9-925" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> v <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb9-926"><a href="#cb9-926" aria-hidden="true" tabindex="-1"></a>                current_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb9-927"><a href="#cb9-927" aria-hidden="true" tabindex="-1"></a>                max_consecutive_losses <span class="op">=</span> <span class="bu">max</span>(max_consecutive_losses, current_count)</span>
<span id="cb9-928"><a href="#cb9-928" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb9-929"><a href="#cb9-929" aria-hidden="true" tabindex="-1"></a>                current_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-930"><a href="#cb9-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-931"><a href="#cb9-931" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Max Consecutive Wins: </span><span class="sc">{</span>max_consecutive_wins<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-932"><a href="#cb9-932" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Max Consecutive Losses: </span><span class="sc">{</span>max_consecutive_losses<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-933"><a href="#cb9-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-934"><a href="#cb9-934" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Show holding days distribution</span></span>
<span id="cb9-935"><a href="#cb9-935" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'Duration'</span> <span class="kw">in</span> trades_df.columns:</span>
<span id="cb9-936"><a href="#cb9-936" aria-hidden="true" tabindex="-1"></a>            duration_counts <span class="op">=</span> trades_df[<span class="st">'Duration'</span>].value_counts().sort_index()</span>
<span id="cb9-937"><a href="#cb9-937" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Holding Period Distribution:"</span>)</span>
<span id="cb9-938"><a href="#cb9-938" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> days, count <span class="kw">in</span> duration_counts.items():</span>
<span id="cb9-939"><a href="#cb9-939" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>days<span class="sc">}</span><span class="ss"> days: </span><span class="sc">{</span>count<span class="sc">}</span><span class="ss"> trades (</span><span class="sc">{</span>count<span class="op">/</span>total_trades<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb9-940"><a href="#cb9-940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-941"><a href="#cb9-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-942"><a href="#cb9-942" aria-hidden="true" tabindex="-1"></a><span class="at">@safe</span></span>
<span id="cb9-943"><a href="#cb9-943" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_ledger(portfolio, interval<span class="op">=</span><span class="st">'D'</span>):</span>
<span id="cb9-944"><a href="#cb9-944" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-945"><a href="#cb9-945" aria-hidden="true" tabindex="-1"></a><span class="co">    Print account status and performance ledger, aggregated by specified time interval</span></span>
<span id="cb9-946"><a href="#cb9-946" aria-hidden="true" tabindex="-1"></a><span class="co">    ('D' for daily, 'W' for weekly, 'M' for monthly).</span></span>
<span id="cb9-947"><a href="#cb9-947" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-948"><a href="#cb9-948" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> portfolio.empty:</span>
<span id="cb9-949"><a href="#cb9-949" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Portfolio data is empty, cannot generate ledger"</span>)</span>
<span id="cb9-950"><a href="#cb9-950" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb9-951"><a href="#cb9-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-952"><a href="#cb9-952" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if required columns exist</span></span>
<span id="cb9-953"><a href="#cb9-953" aria-hidden="true" tabindex="-1"></a>    required_cols <span class="op">=</span> [<span class="st">'Date'</span>, <span class="st">'Account_Value'</span>, <span class="st">'Cash'</span>, <span class="st">'Equity'</span>]</span>
<span id="cb9-954"><a href="#cb9-954" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">all</span>(col <span class="kw">in</span> portfolio.columns <span class="cf">for</span> col <span class="kw">in</span> required_cols):</span>
<span id="cb9-955"><a href="#cb9-955" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Missing necessary columns to generate ledger"</span>)</span>
<span id="cb9-956"><a href="#cb9-956" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Available columns: </span><span class="sc">{</span>portfolio<span class="sc">.</span>columns<span class="sc">.</span>tolist()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-957"><a href="#cb9-957" aria-hidden="true" tabindex="-1"></a>        missing <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> required_cols <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> portfolio.columns]</span>
<span id="cb9-958"><a href="#cb9-958" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Missing columns: </span><span class="sc">{</span>missing<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-959"><a href="#cb9-959" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb9-960"><a href="#cb9-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-961"><a href="#cb9-961" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb9-962"><a href="#cb9-962" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure date format is correct</span></span>
<span id="cb9-963"><a href="#cb9-963" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> pd.api.types.is_datetime64_any_dtype(portfolio[<span class="st">'Date'</span>]):</span>
<span id="cb9-964"><a href="#cb9-964" aria-hidden="true" tabindex="-1"></a>            portfolio[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(portfolio[<span class="st">'Date'</span>])</span>
<span id="cb9-965"><a href="#cb9-965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-966"><a href="#cb9-966" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set date as index for resampling</span></span>
<span id="cb9-967"><a href="#cb9-967" aria-hidden="true" tabindex="-1"></a>        portfolio_resampled <span class="op">=</span> portfolio.copy()</span>
<span id="cb9-968"><a href="#cb9-968" aria-hidden="true" tabindex="-1"></a>        portfolio_resampled.set_index(<span class="st">'Date'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-969"><a href="#cb9-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-970"><a href="#cb9-970" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Resample by specified interval</span></span>
<span id="cb9-971"><a href="#cb9-971" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> interval <span class="kw">in</span> [<span class="st">'W'</span>, <span class="st">'M'</span>]:</span>
<span id="cb9-972"><a href="#cb9-972" aria-hidden="true" tabindex="-1"></a>            portfolio_resampled <span class="op">=</span> portfolio_resampled.resample(interval).last()</span>
<span id="cb9-973"><a href="#cb9-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-974"><a href="#cb9-974" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reset index for output</span></span>
<span id="cb9-975"><a href="#cb9-975" aria-hidden="true" tabindex="-1"></a>        portfolio_resampled.reset_index(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-976"><a href="#cb9-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-977"><a href="#cb9-977" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate cumulative return</span></span>
<span id="cb9-978"><a href="#cb9-978" aria-hidden="true" tabindex="-1"></a>        starting_value <span class="op">=</span> portfolio_resampled[<span class="st">'Account_Value'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb9-979"><a href="#cb9-979" aria-hidden="true" tabindex="-1"></a>        portfolio_resampled[<span class="st">'Cumulative_Return'</span>] <span class="op">=</span> ((portfolio_resampled[<span class="st">'Account_Value'</span>] <span class="op">/</span> starting_value) <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb9-980"><a href="#cb9-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-981"><a href="#cb9-981" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate drawdown</span></span>
<span id="cb9-982"><a href="#cb9-982" aria-hidden="true" tabindex="-1"></a>        portfolio_resampled[<span class="st">'High_Value'</span>] <span class="op">=</span> portfolio_resampled[<span class="st">'Account_Value'</span>].cummax()</span>
<span id="cb9-983"><a href="#cb9-983" aria-hidden="true" tabindex="-1"></a>        portfolio_resampled[<span class="st">'Drawdown'</span>] <span class="op">=</span> (portfolio_resampled[<span class="st">'Account_Value'</span>] <span class="op">/</span> portfolio_resampled[<span class="st">'High_Value'</span>] <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb9-984"><a href="#cb9-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-985"><a href="#cb9-985" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print account ledger</span></span>
<span id="cb9-986"><a href="#cb9-986" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb9-987"><a href="#cb9-987" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"                 LEDGER (ACCOUNT BOOK)                "</span>)</span>
<span id="cb9-988"><a href="#cb9-988" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb9-989"><a href="#cb9-989" aria-hidden="true" tabindex="-1"></a>        period_label <span class="op">=</span> <span class="st">"Daily"</span> <span class="cf">if</span> interval <span class="op">==</span> <span class="st">'D'</span> <span class="cf">else</span> (<span class="st">"Weekly"</span> <span class="cf">if</span> interval <span class="op">==</span> <span class="st">'W'</span> <span class="cf">else</span> <span class="st">"Monthly"</span>)</span>
<span id="cb9-990"><a href="#cb9-990" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Period: </span><span class="sc">{</span>period_label<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-991"><a href="#cb9-991" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="sc">{:&lt;12}</span><span class="st"> </span><span class="sc">{:&lt;15}</span><span class="st"> </span><span class="sc">{:&lt;15}</span><span class="st"> </span><span class="sc">{:&lt;15}</span><span class="st"> </span><span class="sc">{:&lt;15}</span><span class="st"> </span><span class="sc">{:&lt;15}</span><span class="st">"</span>.<span class="bu">format</span>(</span>
<span id="cb9-992"><a href="#cb9-992" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Date"</span>, <span class="st">"Account($)"</span>, <span class="st">"Cash($)"</span>, <span class="st">"Equity($)"</span>, <span class="st">"Drawdown(%)"</span>, <span class="st">"Return(%)"</span></span>
<span id="cb9-993"><a href="#cb9-993" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb9-994"><a href="#cb9-994" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">90</span>)</span>
<span id="cb9-995"><a href="#cb9-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-996"><a href="#cb9-996" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Output each row</span></span>
<span id="cb9-997"><a href="#cb9-997" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, row <span class="kw">in</span> portfolio_resampled.iterrows():</span>
<span id="cb9-998"><a href="#cb9-998" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"</span><span class="sc">{:&lt;12}</span><span class="st"> </span><span class="sc">{:&lt;15.2f}</span><span class="st"> </span><span class="sc">{:&lt;15.2f}</span><span class="st"> </span><span class="sc">{:&lt;15.2f}</span><span class="st"> </span><span class="sc">{:&lt;15.2f}</span><span class="st"> </span><span class="sc">{:&lt;15.2f}</span><span class="st">"</span>.<span class="bu">format</span>(</span>
<span id="cb9-999"><a href="#cb9-999" aria-hidden="true" tabindex="-1"></a>                row[<span class="st">'Date'</span>].strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>),</span>
<span id="cb9-1000"><a href="#cb9-1000" aria-hidden="true" tabindex="-1"></a>                row[<span class="st">'Account_Value'</span>],</span>
<span id="cb9-1001"><a href="#cb9-1001" aria-hidden="true" tabindex="-1"></a>                row[<span class="st">'Cash'</span>],</span>
<span id="cb9-1002"><a href="#cb9-1002" aria-hidden="true" tabindex="-1"></a>                row[<span class="st">'Equity'</span>],</span>
<span id="cb9-1003"><a href="#cb9-1003" aria-hidden="true" tabindex="-1"></a>                row[<span class="st">'Drawdown'</span>],</span>
<span id="cb9-1004"><a href="#cb9-1004" aria-hidden="true" tabindex="-1"></a>                row[<span class="st">'Cumulative_Return'</span>]</span>
<span id="cb9-1005"><a href="#cb9-1005" aria-hidden="true" tabindex="-1"></a>            ))</span>
<span id="cb9-1006"><a href="#cb9-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1007"><a href="#cb9-1007" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">90</span>)</span>
<span id="cb9-1008"><a href="#cb9-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1009"><a href="#cb9-1009" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print summary statistics</span></span>
<span id="cb9-1010"><a href="#cb9-1010" aria-hidden="true" tabindex="-1"></a>        max_drawdown <span class="op">=</span> portfolio_resampled[<span class="st">'Drawdown'</span>].<span class="bu">min</span>()</span>
<span id="cb9-1011"><a href="#cb9-1011" aria-hidden="true" tabindex="-1"></a>        final_return <span class="op">=</span> portfolio_resampled[<span class="st">'Cumulative_Return'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb9-1012"><a href="#cb9-1012" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Initial Account Value: $</span><span class="sc">{</span>starting_value<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-1013"><a href="#cb9-1013" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Final Account Value: $</span><span class="sc">{</span>portfolio_resampled[<span class="st">'Account_Value'</span>]<span class="sc">.</span>iloc[<span class="op">-</span><span class="dv">1</span>]<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-1014"><a href="#cb9-1014" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Total Return: </span><span class="sc">{</span>final_return<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb9-1015"><a href="#cb9-1015" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Maximum Drawdown: </span><span class="sc">{</span>max_drawdown<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb9-1016"><a href="#cb9-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1017"><a href="#cb9-1017" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb9-1018"><a href="#cb9-1018" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error generating ledger: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-1019"><a href="#cb9-1019" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb9-1020"><a href="#cb9-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1021"><a href="#cb9-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1022"><a href="#cb9-1022" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-1023"><a href="#cb9-1023" aria-hidden="true" tabindex="-1"></a><span class="co"># 8.3 Trading Signals Table</span></span>
<span id="cb9-1024"><a href="#cb9-1024" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-1025"><a href="#cb9-1025" aria-hidden="true" tabindex="-1"></a><span class="at">@safe</span></span>
<span id="cb9-1026"><a href="#cb9-1026" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_trading_signals(df_signals, trades):</span>
<span id="cb9-1027"><a href="#cb9-1027" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-1028"><a href="#cb9-1028" aria-hidden="true" tabindex="-1"></a><span class="co">    Print formatted trading signals table showing all trades' entry reasons and results.</span></span>
<span id="cb9-1029"><a href="#cb9-1029" aria-hidden="true" tabindex="-1"></a><span class="co">    Includes: date, action, price, reason, result, profit/loss, and return rate.</span></span>
<span id="cb9-1030"><a href="#cb9-1030" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-1031"><a href="#cb9-1031" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> trades:</span>
<span id="cb9-1032"><a href="#cb9-1032" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"No trade records to display in trading signals table."</span>)</span>
<span id="cb9-1033"><a href="#cb9-1033" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb9-1034"><a href="#cb9-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1035"><a href="#cb9-1035" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">===== TRADING SIGNALS TABLE ====="</span>)</span>
<span id="cb9-1036"><a href="#cb9-1036" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="sc">{:&lt;12}</span><span class="st"> </span><span class="sc">{:&lt;6}</span><span class="st"> </span><span class="sc">{:&lt;10}</span><span class="st"> </span><span class="sc">{:&lt;10}</span><span class="st"> </span><span class="sc">{:&lt;15}</span><span class="st"> </span><span class="sc">{:&lt;15}</span><span class="st"> </span><span class="sc">{:&lt;12}</span><span class="st"> </span><span class="sc">{:&lt;10}</span><span class="st"> </span><span class="sc">{:&lt;10}</span><span class="st">"</span>.<span class="bu">format</span>(</span>
<span id="cb9-1037"><a href="#cb9-1037" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Date"</span>, <span class="st">"Action"</span>, <span class="st">"Price"</span>, <span class="st">"RSI"</span>, <span class="st">"BB Status"</span>, <span class="st">"Exit Reason"</span>, <span class="st">"Profit/Loss"</span>, <span class="st">"Return"</span>, <span class="st">"Duration"</span></span>
<span id="cb9-1038"><a href="#cb9-1038" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb9-1039"><a href="#cb9-1039" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">110</span>)</span>
<span id="cb9-1040"><a href="#cb9-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1041"><a href="#cb9-1041" aria-hidden="true" tabindex="-1"></a>    trades_df <span class="op">=</span> pd.DataFrame(trades)</span>
<span id="cb9-1042"><a href="#cb9-1042" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by entry date</span></span>
<span id="cb9-1043"><a href="#cb9-1043" aria-hidden="true" tabindex="-1"></a>    trades_df <span class="op">=</span> trades_df.sort_values(<span class="st">'Entry_Date'</span>)</span>
<span id="cb9-1044"><a href="#cb9-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1045"><a href="#cb9-1045" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, trade <span class="kw">in</span> trades_df.iterrows():</span>
<span id="cb9-1046"><a href="#cb9-1046" aria-hidden="true" tabindex="-1"></a>        entry_date <span class="op">=</span> trade[<span class="st">'Entry_Date'</span>].strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)</span>
<span id="cb9-1047"><a href="#cb9-1047" aria-hidden="true" tabindex="-1"></a>        entry_price <span class="op">=</span> <span class="ss">f"$</span><span class="sc">{</span>trade[<span class="st">'Entry_Price'</span>]<span class="sc">:.2f}</span><span class="ss">"</span></span>
<span id="cb9-1048"><a href="#cb9-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1049"><a href="#cb9-1049" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get RSI value and BB status on the trade date</span></span>
<span id="cb9-1050"><a href="#cb9-1050" aria-hidden="true" tabindex="-1"></a>        entry_date_obj <span class="op">=</span> trade[<span class="st">'Entry_Date'</span>]</span>
<span id="cb9-1051"><a href="#cb9-1051" aria-hidden="true" tabindex="-1"></a>        entry_row <span class="op">=</span> df_signals[df_signals[<span class="st">'Date'</span>] <span class="op">==</span> entry_date_obj]</span>
<span id="cb9-1052"><a href="#cb9-1052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1053"><a href="#cb9-1053" aria-hidden="true" tabindex="-1"></a>        rsi_value <span class="op">=</span> <span class="st">"N/A"</span></span>
<span id="cb9-1054"><a href="#cb9-1054" aria-hidden="true" tabindex="-1"></a>        bb_status <span class="op">=</span> <span class="st">"N/A"</span></span>
<span id="cb9-1055"><a href="#cb9-1055" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1056"><a href="#cb9-1056" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> entry_row.empty:</span>
<span id="cb9-1057"><a href="#cb9-1057" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'RSI'</span> <span class="kw">in</span> entry_row.columns:</span>
<span id="cb9-1058"><a href="#cb9-1058" aria-hidden="true" tabindex="-1"></a>                rsi_value <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>entry_row[<span class="st">'RSI'</span>]<span class="sc">.</span>values[<span class="dv">0</span>]<span class="sc">:.1f}</span><span class="ss">"</span></span>
<span id="cb9-1059"><a href="#cb9-1059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1060"><a href="#cb9-1060" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'Close'</span> <span class="kw">in</span> entry_row.columns <span class="kw">and</span> <span class="st">'BB_Lower'</span> <span class="kw">in</span> entry_row.columns:</span>
<span id="cb9-1061"><a href="#cb9-1061" aria-hidden="true" tabindex="-1"></a>                close_price <span class="op">=</span> entry_row[<span class="st">'Close'</span>].values[<span class="dv">0</span>]</span>
<span id="cb9-1062"><a href="#cb9-1062" aria-hidden="true" tabindex="-1"></a>                bb_lower <span class="op">=</span> entry_row[<span class="st">'BB_Lower'</span>].values[<span class="dv">0</span>]</span>
<span id="cb9-1063"><a href="#cb9-1063" aria-hidden="true" tabindex="-1"></a>                price_to_bb <span class="op">=</span> (close_price <span class="op">/</span> bb_lower <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb9-1064"><a href="#cb9-1064" aria-hidden="true" tabindex="-1"></a>                bb_status <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>price_to_bb<span class="sc">:.1f}</span><span class="ss">% from BB Lower"</span></span>
<span id="cb9-1065"><a href="#cb9-1065" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1066"><a href="#cb9-1066" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Exit reason</span></span>
<span id="cb9-1067"><a href="#cb9-1067" aria-hidden="true" tabindex="-1"></a>        exit_reason <span class="op">=</span> trade.get(<span class="st">'Exit_Reason'</span>, <span class="st">'Unknown'</span>)</span>
<span id="cb9-1068"><a href="#cb9-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1069"><a href="#cb9-1069" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set profit/loss and return rate</span></span>
<span id="cb9-1070"><a href="#cb9-1070" aria-hidden="true" tabindex="-1"></a>        profit_loss <span class="op">=</span> trade[<span class="st">'Profit'</span>]</span>
<span id="cb9-1071"><a href="#cb9-1071" aria-hidden="true" tabindex="-1"></a>        profit_loss_str <span class="op">=</span> <span class="ss">f"$</span><span class="sc">{</span>profit_loss<span class="sc">:.2f}</span><span class="ss">"</span></span>
<span id="cb9-1072"><a href="#cb9-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1073"><a href="#cb9-1073" aria-hidden="true" tabindex="-1"></a>        return_pct <span class="op">=</span> trade[<span class="st">'Return'</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb9-1074"><a href="#cb9-1074" aria-hidden="true" tabindex="-1"></a>        return_str <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>return_pct<span class="sc">:.2f}</span><span class="ss">%"</span></span>
<span id="cb9-1075"><a href="#cb9-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1076"><a href="#cb9-1076" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Duration</span></span>
<span id="cb9-1077"><a href="#cb9-1077" aria-hidden="true" tabindex="-1"></a>        duration <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>trade<span class="sc">.</span>get(<span class="st">'Duration'</span>, <span class="st">'N/A'</span>)<span class="sc">}</span><span class="ss"> days"</span></span>
<span id="cb9-1078"><a href="#cb9-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1079"><a href="#cb9-1079" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="sc">{:&lt;12}</span><span class="st"> </span><span class="sc">{:&lt;6}</span><span class="st"> </span><span class="sc">{:&lt;10}</span><span class="st"> </span><span class="sc">{:&lt;10}</span><span class="st"> </span><span class="sc">{:&lt;15}</span><span class="st"> </span><span class="sc">{:&lt;15}</span><span class="st"> </span><span class="sc">{:&lt;12}</span><span class="st"> </span><span class="sc">{:&lt;10}</span><span class="st"> </span><span class="sc">{:&lt;10}</span><span class="st">"</span>.<span class="bu">format</span>(</span>
<span id="cb9-1080"><a href="#cb9-1080" aria-hidden="true" tabindex="-1"></a>            entry_date, <span class="st">"Buy"</span>, entry_price, rsi_value, bb_status, exit_reason,</span>
<span id="cb9-1081"><a href="#cb9-1081" aria-hidden="true" tabindex="-1"></a>            profit_loss_str, return_str, duration</span>
<span id="cb9-1082"><a href="#cb9-1082" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb9-1083"><a href="#cb9-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1084"><a href="#cb9-1084" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">110</span>)</span>
<span id="cb9-1085"><a href="#cb9-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1086"><a href="#cb9-1086" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add more detailed trade statistics</span></span>
<span id="cb9-1087"><a href="#cb9-1087" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(trades_df) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-1088"><a href="#cb9-1088" aria-hidden="true" tabindex="-1"></a>        win_trades <span class="op">=</span> <span class="bu">len</span>(trades_df[trades_df[<span class="st">'Profit'</span>] <span class="op">&gt;</span> <span class="dv">0</span>])</span>
<span id="cb9-1089"><a href="#cb9-1089" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Total Trades: </span><span class="sc">{</span><span class="bu">len</span>(trades_df)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-1090"><a href="#cb9-1090" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Win Rate: </span><span class="sc">{</span>win_trades<span class="op">/</span><span class="bu">len</span>(trades_df)<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%"</span>)</span>
<span id="cb9-1091"><a href="#cb9-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1092"><a href="#cb9-1092" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Analyze by exit reason</span></span>
<span id="cb9-1093"><a href="#cb9-1093" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'Exit_Reason'</span> <span class="kw">in</span> trades_df.columns:</span>
<span id="cb9-1094"><a href="#cb9-1094" aria-hidden="true" tabindex="-1"></a>            reason_stats <span class="op">=</span> trades_df.groupby(<span class="st">'Exit_Reason'</span>).agg({</span>
<span id="cb9-1095"><a href="#cb9-1095" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Profit'</span>: [<span class="st">'count'</span>, <span class="st">'mean'</span>, <span class="st">'sum'</span>],</span>
<span id="cb9-1096"><a href="#cb9-1096" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Return'</span>: <span class="st">'mean'</span>,</span>
<span id="cb9-1097"><a href="#cb9-1097" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Duration'</span>: <span class="st">'mean'</span></span>
<span id="cb9-1098"><a href="#cb9-1098" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb9-1099"><a href="#cb9-1099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1100"><a href="#cb9-1100" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> reason_stats.empty:</span>
<span id="cb9-1101"><a href="#cb9-1101" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Exit Reason Analysis:"</span>)</span>
<span id="cb9-1102"><a href="#cb9-1102" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> reason, stats <span class="kw">in</span> reason_stats.iterrows():</span>
<span id="cb9-1103"><a href="#cb9-1103" aria-hidden="true" tabindex="-1"></a>                    count <span class="op">=</span> stats[(<span class="st">'Profit'</span>, <span class="st">'count'</span>)]</span>
<span id="cb9-1104"><a href="#cb9-1104" aria-hidden="true" tabindex="-1"></a>                    avg_profit <span class="op">=</span> stats[(<span class="st">'Profit'</span>, <span class="st">'mean'</span>)]</span>
<span id="cb9-1105"><a href="#cb9-1105" aria-hidden="true" tabindex="-1"></a>                    total_profit <span class="op">=</span> stats[(<span class="st">'Profit'</span>, <span class="st">'sum'</span>)]</span>
<span id="cb9-1106"><a href="#cb9-1106" aria-hidden="true" tabindex="-1"></a>                    avg_return <span class="op">=</span> stats[(<span class="st">'Return'</span>, <span class="st">'mean'</span>)] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb9-1107"><a href="#cb9-1107" aria-hidden="true" tabindex="-1"></a>                    avg_duration <span class="op">=</span> stats[(<span class="st">'Duration'</span>, <span class="st">'mean'</span>)]</span>
<span id="cb9-1108"><a href="#cb9-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1109"><a href="#cb9-1109" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>reason<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>count<span class="sc">}</span><span class="ss"> trades, Average Profit: $</span><span class="sc">{</span>avg_profit<span class="sc">:.2f}</span><span class="ss">, "</span></span>
<span id="cb9-1110"><a href="#cb9-1110" aria-hidden="true" tabindex="-1"></a>                          <span class="ss">f"Total Profit: $</span><span class="sc">{</span>total_profit<span class="sc">:.2f}</span><span class="ss">, Average Return: </span><span class="sc">{</span>avg_return<span class="sc">:.1f}</span><span class="ss">%, "</span></span>
<span id="cb9-1111"><a href="#cb9-1111" aria-hidden="true" tabindex="-1"></a>                          <span class="ss">f"Average Duration: </span><span class="sc">{</span>avg_duration<span class="sc">:.1f}</span><span class="ss"> days"</span>)</span>
<span id="cb9-1112"><a href="#cb9-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1113"><a href="#cb9-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1114"><a href="#cb9-1114" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-1115"><a href="#cb9-1115" aria-hidden="true" tabindex="-1"></a><span class="co"># 8.4 Performance Statistics</span></span>
<span id="cb9-1116"><a href="#cb9-1116" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-1117"><a href="#cb9-1117" aria-hidden="true" tabindex="-1"></a><span class="at">@safe</span></span>
<span id="cb9-1118"><a href="#cb9-1118" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_performance_statistics(df_backtest, trades, benchmark_returns<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb9-1119"><a href="#cb9-1119" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-1120"><a href="#cb9-1120" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate and print comprehensive performance statistics per assignment requirements:</span></span>
<span id="cb9-1121"><a href="#cb9-1121" aria-hidden="true" tabindex="-1"></a><span class="co">    - Alpha &amp; Beta (relative to benchmark)</span></span>
<span id="cb9-1122"><a href="#cb9-1122" aria-hidden="true" tabindex="-1"></a><span class="co">    - Volatility</span></span>
<span id="cb9-1123"><a href="#cb9-1123" aria-hidden="true" tabindex="-1"></a><span class="co">    - Geometric Mean Rate of Return</span></span>
<span id="cb9-1124"><a href="#cb9-1124" aria-hidden="true" tabindex="-1"></a><span class="co">    - Sharpe Ratio</span></span>
<span id="cb9-1125"><a href="#cb9-1125" aria-hidden="true" tabindex="-1"></a><span class="co">    - Average Return per Trade</span></span>
<span id="cb9-1126"><a href="#cb9-1126" aria-hidden="true" tabindex="-1"></a><span class="co">    - Average Number of Trades per Year</span></span>
<span id="cb9-1127"><a href="#cb9-1127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1128"><a href="#cb9-1128" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb9-1129"><a href="#cb9-1129" aria-hidden="true" tabindex="-1"></a><span class="co">    df_backtest : DataFrame - Portfolio backtest results</span></span>
<span id="cb9-1130"><a href="#cb9-1130" aria-hidden="true" tabindex="-1"></a><span class="co">    trades : list - List of trade dictionaries</span></span>
<span id="cb9-1131"><a href="#cb9-1131" aria-hidden="true" tabindex="-1"></a><span class="co">    benchmark_returns : DataFrame or Series - Benchmark returns (optional)</span></span>
<span id="cb9-1132"><a href="#cb9-1132" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-1133"><a href="#cb9-1133" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb9-1134"><a href="#cb9-1134" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"              PERFORMANCE STATISTICS              "</span>)</span>
<span id="cb9-1135"><a href="#cb9-1135" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb9-1136"><a href="#cb9-1136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1137"><a href="#cb9-1137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Time Period Analysis ---</span></span>
<span id="cb9-1138"><a href="#cb9-1138" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> df_backtest.empty <span class="kw">or</span> <span class="st">'Date'</span> <span class="kw">not</span> <span class="kw">in</span> df_backtest.columns:</span>
<span id="cb9-1139"><a href="#cb9-1139" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"ERROR: No valid backtest data available."</span>)</span>
<span id="cb9-1140"><a href="#cb9-1140" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb9-1141"><a href="#cb9-1141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1142"><a href="#cb9-1142" aria-hidden="true" tabindex="-1"></a>    start_date <span class="op">=</span> df_backtest[<span class="st">'Date'</span>].<span class="bu">min</span>()</span>
<span id="cb9-1143"><a href="#cb9-1143" aria-hidden="true" tabindex="-1"></a>    end_date <span class="op">=</span> df_backtest[<span class="st">'Date'</span>].<span class="bu">max</span>()</span>
<span id="cb9-1144"><a href="#cb9-1144" aria-hidden="true" tabindex="-1"></a>    total_days <span class="op">=</span> (end_date <span class="op">-</span> start_date).days</span>
<span id="cb9-1145"><a href="#cb9-1145" aria-hidden="true" tabindex="-1"></a>    years <span class="op">=</span> total_days <span class="op">/</span> <span class="fl">365.25</span></span>
<span id="cb9-1146"><a href="#cb9-1146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1147"><a href="#cb9-1147" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Backtest Period: </span><span class="sc">{</span>start_date<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>end_date<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-1148"><a href="#cb9-1148" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total Days: </span><span class="sc">{</span>total_days<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>years<span class="sc">:.2f}</span><span class="ss"> years)"</span>)</span>
<span id="cb9-1149"><a href="#cb9-1149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1150"><a href="#cb9-1150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Portfolio Returns ---</span></span>
<span id="cb9-1151"><a href="#cb9-1151" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'Portfolio_Value'</span> <span class="kw">not</span> <span class="kw">in</span> df_backtest.columns:</span>
<span id="cb9-1152"><a href="#cb9-1152" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"ERROR: Portfolio value data missing."</span>)</span>
<span id="cb9-1153"><a href="#cb9-1153" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb9-1154"><a href="#cb9-1154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1155"><a href="#cb9-1155" aria-hidden="true" tabindex="-1"></a>    initial_value <span class="op">=</span> df_backtest[<span class="st">'Portfolio_Value'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb9-1156"><a href="#cb9-1156" aria-hidden="true" tabindex="-1"></a>    final_value <span class="op">=</span> df_backtest[<span class="st">'Portfolio_Value'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb9-1157"><a href="#cb9-1157" aria-hidden="true" tabindex="-1"></a>    total_return <span class="op">=</span> (final_value <span class="op">/</span> initial_value <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb9-1158"><a href="#cb9-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1159"><a href="#cb9-1159" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate daily returns</span></span>
<span id="cb9-1160"><a href="#cb9-1160" aria-hidden="true" tabindex="-1"></a>    df_backtest[<span class="st">'Daily_Return'</span>] <span class="op">=</span> df_backtest[<span class="st">'Portfolio_Value'</span>].pct_change()</span>
<span id="cb9-1161"><a href="#cb9-1161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1162"><a href="#cb9-1162" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Volatility ---</span></span>
<span id="cb9-1163"><a href="#cb9-1163" aria-hidden="true" tabindex="-1"></a>    daily_vol <span class="op">=</span> df_backtest[<span class="st">'Daily_Return'</span>].std()</span>
<span id="cb9-1164"><a href="#cb9-1164" aria-hidden="true" tabindex="-1"></a>    annualized_vol <span class="op">=</span> daily_vol <span class="op">*</span> np.sqrt(<span class="dv">252</span>)</span>
<span id="cb9-1165"><a href="#cb9-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1166"><a href="#cb9-1166" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Sharpe Ratio ---</span></span>
<span id="cb9-1167"><a href="#cb9-1167" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assuming risk-free rate of 0.02 (2%)</span></span>
<span id="cb9-1168"><a href="#cb9-1168" aria-hidden="true" tabindex="-1"></a>    risk_free_rate <span class="op">=</span> <span class="fl">0.02</span></span>
<span id="cb9-1169"><a href="#cb9-1169" aria-hidden="true" tabindex="-1"></a>    daily_excess_return <span class="op">=</span> df_backtest[<span class="st">'Daily_Return'</span>] <span class="op">-</span> risk_free_rate<span class="op">/</span><span class="dv">252</span></span>
<span id="cb9-1170"><a href="#cb9-1170" aria-hidden="true" tabindex="-1"></a>    avg_daily_excess <span class="op">=</span> daily_excess_return.mean()</span>
<span id="cb9-1171"><a href="#cb9-1171" aria-hidden="true" tabindex="-1"></a>    sharpe_ratio <span class="op">=</span> (avg_daily_excess <span class="op">/</span> daily_vol) <span class="op">*</span> np.sqrt(<span class="dv">252</span>) <span class="cf">if</span> daily_vol <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-1172"><a href="#cb9-1172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1173"><a href="#cb9-1173" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Downside Risk &amp; Sortino Ratio ---</span></span>
<span id="cb9-1174"><a href="#cb9-1174" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate downside returns (only negative returns)</span></span>
<span id="cb9-1175"><a href="#cb9-1175" aria-hidden="true" tabindex="-1"></a>    downside_returns <span class="op">=</span> df_backtest[<span class="st">'Daily_Return'</span>].copy()</span>
<span id="cb9-1176"><a href="#cb9-1176" aria-hidden="true" tabindex="-1"></a>    downside_returns[downside_returns <span class="op">&gt;</span> <span class="dv">0</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-1177"><a href="#cb9-1177" aria-hidden="true" tabindex="-1"></a>    downside_risk <span class="op">=</span> downside_returns.std() <span class="op">*</span> np.sqrt(<span class="dv">252</span>)  <span class="co"># Annualized</span></span>
<span id="cb9-1178"><a href="#cb9-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1179"><a href="#cb9-1179" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sortino ratio uses downside risk instead of total volatility</span></span>
<span id="cb9-1180"><a href="#cb9-1180" aria-hidden="true" tabindex="-1"></a>    sortino_ratio <span class="op">=</span> (avg_daily_excess <span class="op">*</span> <span class="dv">252</span>) <span class="op">/</span> downside_risk <span class="cf">if</span> downside_risk <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-1181"><a href="#cb9-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1182"><a href="#cb9-1182" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Geometric Mean Rate of Return ---</span></span>
<span id="cb9-1183"><a href="#cb9-1183" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculating from compounded daily returns</span></span>
<span id="cb9-1184"><a href="#cb9-1184" aria-hidden="true" tabindex="-1"></a>    geo_mean_daily <span class="op">=</span> (final_value <span class="op">/</span> initial_value) <span class="op">**</span> (<span class="dv">1</span> <span class="op">/</span> total_days) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb9-1185"><a href="#cb9-1185" aria-hidden="true" tabindex="-1"></a>    geo_mean_annual <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> geo_mean_daily) <span class="op">**</span> <span class="dv">252</span> <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb9-1186"><a href="#cb9-1186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1187"><a href="#cb9-1187" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Alpha and Beta ---</span></span>
<span id="cb9-1188"><a href="#cb9-1188" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> benchmark_returns <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb9-1189"><a href="#cb9-1189" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If benchmark data is provided</span></span>
<span id="cb9-1190"><a href="#cb9-1190" aria-hidden="true" tabindex="-1"></a>        common_dates <span class="op">=</span> <span class="bu">set</span>(df_backtest[<span class="st">'Date'</span>]).intersection(<span class="bu">set</span>(benchmark_returns.index))</span>
<span id="cb9-1191"><a href="#cb9-1191" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(common_dates) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-1192"><a href="#cb9-1192" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Convert set to sorted list for indexing</span></span>
<span id="cb9-1193"><a href="#cb9-1193" aria-hidden="true" tabindex="-1"></a>            common_dates <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">list</span>(common_dates))</span>
<span id="cb9-1194"><a href="#cb9-1194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1195"><a href="#cb9-1195" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Filter data for common dates</span></span>
<span id="cb9-1196"><a href="#cb9-1196" aria-hidden="true" tabindex="-1"></a>            portfolio_returns <span class="op">=</span> df_backtest.set_index(<span class="st">'Date'</span>).loc[common_dates][<span class="st">'Daily_Return'</span>]</span>
<span id="cb9-1197"><a href="#cb9-1197" aria-hidden="true" tabindex="-1"></a>            bench_returns <span class="op">=</span> benchmark_returns.loc[common_dates]</span>
<span id="cb9-1198"><a href="#cb9-1198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1199"><a href="#cb9-1199" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate beta (covariance / benchmark variance)</span></span>
<span id="cb9-1200"><a href="#cb9-1200" aria-hidden="true" tabindex="-1"></a>            covariance <span class="op">=</span> portfolio_returns.cov(bench_returns)</span>
<span id="cb9-1201"><a href="#cb9-1201" aria-hidden="true" tabindex="-1"></a>            benchmark_variance <span class="op">=</span> bench_returns.var()</span>
<span id="cb9-1202"><a href="#cb9-1202" aria-hidden="true" tabindex="-1"></a>            beta <span class="op">=</span> covariance <span class="op">/</span> benchmark_variance <span class="cf">if</span> benchmark_variance <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-1203"><a href="#cb9-1203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1204"><a href="#cb9-1204" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate alpha (annualized)</span></span>
<span id="cb9-1205"><a href="#cb9-1205" aria-hidden="true" tabindex="-1"></a>            portfolio_return_annual <span class="op">=</span> portfolio_returns.mean() <span class="op">*</span> <span class="dv">252</span></span>
<span id="cb9-1206"><a href="#cb9-1206" aria-hidden="true" tabindex="-1"></a>            benchmark_return_annual <span class="op">=</span> bench_returns.mean() <span class="op">*</span> <span class="dv">252</span></span>
<span id="cb9-1207"><a href="#cb9-1207" aria-hidden="true" tabindex="-1"></a>            alpha <span class="op">=</span> portfolio_return_annual <span class="op">-</span> (risk_free_rate <span class="op">+</span> beta <span class="op">*</span> (benchmark_return_annual <span class="op">-</span> risk_free_rate))</span>
<span id="cb9-1208"><a href="#cb9-1208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1209"><a href="#cb9-1209" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Benchmark Annual Return: </span><span class="sc">{</span>benchmark_return_annual<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb9-1210"><a href="#cb9-1210" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Strategy Annual Return: </span><span class="sc">{</span>portfolio_return_annual<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb9-1211"><a href="#cb9-1211" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Alpha (annualized): </span><span class="sc">{</span>alpha<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb9-1212"><a href="#cb9-1212" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Beta: </span><span class="sc">{</span>beta<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-1213"><a href="#cb9-1213" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb9-1214"><a href="#cb9-1214" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Alpha &amp; Beta: Not available (no overlapping dates with benchmark)"</span>)</span>
<span id="cb9-1215"><a href="#cb9-1215" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb9-1216"><a href="#cb9-1216" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Alpha &amp; Beta: Not available (no benchmark data provided)"</span>)</span>
<span id="cb9-1217"><a href="#cb9-1217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1218"><a href="#cb9-1218" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Trade Statistics ---</span></span>
<span id="cb9-1219"><a href="#cb9-1219" aria-hidden="true" tabindex="-1"></a>    total_trades <span class="op">=</span> <span class="bu">len</span>(trades)</span>
<span id="cb9-1220"><a href="#cb9-1220" aria-hidden="true" tabindex="-1"></a>    trades_per_year <span class="op">=</span> total_trades <span class="op">/</span> years <span class="cf">if</span> years <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-1221"><a href="#cb9-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1222"><a href="#cb9-1222" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate average return per trade</span></span>
<span id="cb9-1223"><a href="#cb9-1223" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> total_trades <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-1224"><a href="#cb9-1224" aria-hidden="true" tabindex="-1"></a>        avg_return_per_trade <span class="op">=</span> <span class="bu">sum</span>(trade[<span class="st">'Return'</span>] <span class="cf">for</span> trade <span class="kw">in</span> trades) <span class="op">/</span> total_trades</span>
<span id="cb9-1225"><a href="#cb9-1225" aria-hidden="true" tabindex="-1"></a>        avg_profit_per_trade <span class="op">=</span> <span class="bu">sum</span>(trade[<span class="st">'Profit'</span>] <span class="cf">for</span> trade <span class="kw">in</span> trades) <span class="op">/</span> total_trades</span>
<span id="cb9-1226"><a href="#cb9-1226" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb9-1227"><a href="#cb9-1227" aria-hidden="true" tabindex="-1"></a>        avg_return_per_trade <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-1228"><a href="#cb9-1228" aria-hidden="true" tabindex="-1"></a>        avg_profit_per_trade <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-1229"><a href="#cb9-1229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1230"><a href="#cb9-1230" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Print Statistics ---</span></span>
<span id="cb9-1231"><a href="#cb9-1231" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Total Return: </span><span class="sc">{</span>total_return<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb9-1232"><a href="#cb9-1232" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Annualized Return: </span><span class="sc">{</span>((<span class="dv">1</span> <span class="op">+</span> total_return<span class="op">/</span><span class="dv">100</span>) <span class="op">**</span> (<span class="dv">1</span><span class="op">/</span>years) <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">% (arithmetic)"</span>)</span>
<span id="cb9-1233"><a href="#cb9-1233" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Geometric Mean Annual Return: </span><span class="sc">{</span>geo_mean_annual<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb9-1234"><a href="#cb9-1234" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Volatility (annualized): </span><span class="sc">{</span>annualized_vol<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb9-1235"><a href="#cb9-1235" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Downside Risk (annualized): </span><span class="sc">{</span>downside_risk<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb9-1236"><a href="#cb9-1236" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Sharpe Ratio: </span><span class="sc">{</span>sharpe_ratio<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-1237"><a href="#cb9-1237" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Sortino Ratio: </span><span class="sc">{</span>sortino_ratio<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-1238"><a href="#cb9-1238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1239"><a href="#cb9-1239" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Total Trades: </span><span class="sc">{</span>total_trades<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-1240"><a href="#cb9-1240" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Average Trades per Year: </span><span class="sc">{</span>trades_per_year<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-1241"><a href="#cb9-1241" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Average Return per Trade: </span><span class="sc">{</span>avg_return_per_trade<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb9-1242"><a href="#cb9-1242" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Average Profit per Trade: $</span><span class="sc">{</span>avg_profit_per_trade<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-1243"><a href="#cb9-1243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1244"><a href="#cb9-1244" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Maximum Drawdown ---</span></span>
<span id="cb9-1245"><a href="#cb9-1245" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'Drawdown'</span> <span class="kw">not</span> <span class="kw">in</span> df_backtest.columns:</span>
<span id="cb9-1246"><a href="#cb9-1246" aria-hidden="true" tabindex="-1"></a>        df_backtest[<span class="st">'Peak'</span>] <span class="op">=</span> df_backtest[<span class="st">'Portfolio_Value'</span>].cummax()</span>
<span id="cb9-1247"><a href="#cb9-1247" aria-hidden="true" tabindex="-1"></a>        df_backtest[<span class="st">'Drawdown'</span>] <span class="op">=</span> (df_backtest[<span class="st">'Portfolio_Value'</span>] <span class="op">/</span> df_backtest[<span class="st">'Peak'</span>] <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb9-1248"><a href="#cb9-1248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1249"><a href="#cb9-1249" aria-hidden="true" tabindex="-1"></a>    max_dd <span class="op">=</span> df_backtest[<span class="st">'Drawdown'</span>].<span class="bu">min</span>()</span>
<span id="cb9-1250"><a href="#cb9-1250" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Maximum Drawdown: </span><span class="sc">{</span>max_dd<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb9-1251"><a href="#cb9-1251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1252"><a href="#cb9-1252" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Calmar Ratio ---</span></span>
<span id="cb9-1253"><a href="#cb9-1253" aria-hidden="true" tabindex="-1"></a>    ann_return <span class="op">=</span> ((<span class="dv">1</span> <span class="op">+</span> total_return<span class="op">/</span><span class="dv">100</span>) <span class="op">**</span> (<span class="dv">1</span><span class="op">/</span>years) <span class="op">-</span> <span class="dv">1</span>) <span class="cf">if</span> years <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-1254"><a href="#cb9-1254" aria-hidden="true" tabindex="-1"></a>    calmar_ratio <span class="op">=</span> <span class="bu">abs</span>(ann_return <span class="op">/</span> (max_dd<span class="op">/</span><span class="dv">100</span>)) <span class="cf">if</span> max_dd <span class="op">&lt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-1255"><a href="#cb9-1255" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Calmar Ratio: </span><span class="sc">{</span>calmar_ratio<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-1256"><a href="#cb9-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1257"><a href="#cb9-1257" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Note: Alpha &amp; Beta calculations require benchmark data. Call this function with a benchmark returns series for complete metrics."</span>)</span>
<span id="cb9-1258"><a href="#cb9-1258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1259"><a href="#cb9-1259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1260"><a href="#cb9-1260" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-1261"><a href="#cb9-1261" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Main Function</span></span>
<span id="cb9-1262"><a href="#cb9-1262" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb9-1263"><a href="#cb9-1263" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb9-1264"><a href="#cb9-1264" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"===== Buy Low / Sell High Strategy System =====</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb9-1265"><a href="#cb9-1265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1266"><a href="#cb9-1266" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Example symbol</span></span>
<span id="cb9-1267"><a href="#cb9-1267" aria-hidden="true" tabindex="-1"></a>    selected_symbol <span class="op">=</span> <span class="st">"AAPL"</span></span>
<span id="cb9-1268"><a href="#cb9-1268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1269"><a href="#cb9-1269" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Fetch data</span></span>
<span id="cb9-1270"><a href="#cb9-1270" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> fetch_asset_data(selected_symbol, duration<span class="op">=</span><span class="st">"2 Y"</span>)</span>
<span id="cb9-1271"><a href="#cb9-1271" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> df.empty:</span>
<span id="cb9-1272"><a href="#cb9-1272" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"No data for </span><span class="sc">{</span>selected_symbol<span class="sc">}</span><span class="ss">. Exiting."</span>)</span>
<span id="cb9-1273"><a href="#cb9-1273" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb9-1274"><a href="#cb9-1274" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Fetched </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss"> data points for </span><span class="sc">{</span>selected_symbol<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-1275"><a href="#cb9-1275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1276"><a href="#cb9-1276" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Also fetch benchmark data for comparison</span></span>
<span id="cb9-1277"><a href="#cb9-1277" aria-hidden="true" tabindex="-1"></a>    benchmark_data <span class="op">=</span> fetch_benchmark_data(<span class="st">"SPY"</span>, duration<span class="op">=</span><span class="st">"2 Y"</span>)</span>
<span id="cb9-1278"><a href="#cb9-1278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1279"><a href="#cb9-1279" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 2: Add indicators</span></span>
<span id="cb9-1280"><a href="#cb9-1280" aria-hidden="true" tabindex="-1"></a>    df_ind <span class="op">=</span> add_indicators(df)</span>
<span id="cb9-1281"><a href="#cb9-1281" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> df_ind.empty:</span>
<span id="cb9-1282"><a href="#cb9-1282" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"No indicator data. Exiting."</span>)</span>
<span id="cb9-1283"><a href="#cb9-1283" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb9-1284"><a href="#cb9-1284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1285"><a href="#cb9-1285" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 3: Parameter optimization</span></span>
<span id="cb9-1286"><a href="#cb9-1286" aria-hidden="true" tabindex="-1"></a>    run_optimization <span class="op">=</span> <span class="va">True</span></span>
<span id="cb9-1287"><a href="#cb9-1287" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> run_optimization:</span>
<span id="cb9-1288"><a href="#cb9-1288" aria-hidden="true" tabindex="-1"></a>        param_grid <span class="op">=</span> {</span>
<span id="cb9-1289"><a href="#cb9-1289" aria-hidden="true" tabindex="-1"></a>            <span class="st">'rsi_threshold'</span>: [<span class="dv">35</span>, <span class="dv">40</span>, <span class="dv">45</span>, <span class="dv">50</span>, <span class="dv">55</span>],  <span class="co"># Extended RSI threshold range</span></span>
<span id="cb9-1290"><a href="#cb9-1290" aria-hidden="true" tabindex="-1"></a>            <span class="st">'atr_stop_multiplier'</span>: [<span class="fl">1.5</span>, <span class="fl">2.0</span>, <span class="fl">2.5</span>],</span>
<span id="cb9-1291"><a href="#cb9-1291" aria-hidden="true" tabindex="-1"></a>            <span class="st">'atr_take_multiplier'</span>: [<span class="fl">3.0</span>, <span class="fl">4.0</span>, <span class="fl">5.0</span>]</span>
<span id="cb9-1292"><a href="#cb9-1292" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-1293"><a href="#cb9-1293" aria-hidden="true" tabindex="-1"></a>        best_params, results_df <span class="op">=</span> optimize_strategy(df_ind, param_grid)</span>
<span id="cb9-1294"><a href="#cb9-1294" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> best_params:</span>
<span id="cb9-1295"><a href="#cb9-1295" aria-hidden="true" tabindex="-1"></a>            rsi_thresh, atr_stop, atr_take <span class="op">=</span> best_params</span>
<span id="cb9-1296"><a href="#cb9-1296" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb9-1297"><a href="#cb9-1297" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"No optimal parameters found. Using defaults."</span>)</span>
<span id="cb9-1298"><a href="#cb9-1298" aria-hidden="true" tabindex="-1"></a>            rsi_thresh, atr_stop, atr_take <span class="op">=</span> <span class="dv">45</span>, <span class="fl">2.0</span>, <span class="fl">4.0</span>  <span class="co"># Default value set to 45</span></span>
<span id="cb9-1299"><a href="#cb9-1299" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb9-1300"><a href="#cb9-1300" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use default</span></span>
<span id="cb9-1301"><a href="#cb9-1301" aria-hidden="true" tabindex="-1"></a>        rsi_thresh, atr_stop, atr_take <span class="op">=</span> <span class="dv">45</span>, <span class="fl">2.0</span>, <span class="fl">4.0</span>  <span class="co"># Default value set to 45</span></span>
<span id="cb9-1302"><a href="#cb9-1302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1303"><a href="#cb9-1303" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Using parameters for final backtest: RSI=</span><span class="sc">{</span>rsi_thresh<span class="sc">}</span><span class="ss">, ATR Stop=</span><span class="sc">{</span>atr_stop<span class="sc">}</span><span class="ss">, ATR Take=</span><span class="sc">{</span>atr_take<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-1304"><a href="#cb9-1304" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Note: Final performance metrics may differ from optimization due to different calculation methods."</span>)</span>
<span id="cb9-1305"><a href="#cb9-1305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1306"><a href="#cb9-1306" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 4: Generate signals &amp; backtest</span></span>
<span id="cb9-1307"><a href="#cb9-1307" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Running Final Backtest with Optimal Parameters ==="</span>)</span>
<span id="cb9-1308"><a href="#cb9-1308" aria-hidden="true" tabindex="-1"></a>    df_signals <span class="op">=</span> generate_signals(df_ind, rsi_thresh, atr_stop, atr_take)</span>
<span id="cb9-1309"><a href="#cb9-1309" aria-hidden="true" tabindex="-1"></a>    df_backtest, trades <span class="op">=</span> backtest_strategy(df_signals, verbose<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-1310"><a href="#cb9-1310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1311"><a href="#cb9-1311" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 5: Detailed analysis</span></span>
<span id="cb9-1312"><a href="#cb9-1312" aria-hidden="true" tabindex="-1"></a>    analyze_trades(trades, verbose<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-1313"><a href="#cb9-1313" aria-hidden="true" tabindex="-1"></a>    print_blotter(trades)</span>
<span id="cb9-1314"><a href="#cb9-1314" aria-hidden="true" tabindex="-1"></a>    print_ledger(df_backtest, interval<span class="op">=</span><span class="st">'W'</span>)</span>
<span id="cb9-1315"><a href="#cb9-1315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1316"><a href="#cb9-1316" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 6: Visualization</span></span>
<span id="cb9-1317"><a href="#cb9-1317" aria-hidden="true" tabindex="-1"></a>    visualize_results(df_ind, df_backtest, trades, selected_symbol)</span>
<span id="cb9-1318"><a href="#cb9-1318" aria-hidden="true" tabindex="-1"></a>    visualize_advanced_metrics(df_backtest, window<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb9-1319"><a href="#cb9-1319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1320"><a href="#cb9-1320" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 7: Print trading signals</span></span>
<span id="cb9-1321"><a href="#cb9-1321" aria-hidden="true" tabindex="-1"></a>    print_trading_signals(df_signals, trades)</span>
<span id="cb9-1322"><a href="#cb9-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1323"><a href="#cb9-1323" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 8: Print comprehensive performance statistics</span></span>
<span id="cb9-1324"><a href="#cb9-1324" aria-hidden="true" tabindex="-1"></a>    print_performance_statistics(df_backtest, trades, benchmark_data)</span>
<span id="cb9-1325"><a href="#cb9-1325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1326"><a href="#cb9-1326" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Strategy analysis completed!"</span>)</span>
<span id="cb9-1327"><a href="#cb9-1327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1328"><a href="#cb9-1328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1329"><a href="#cb9-1329" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb9-1330"><a href="#cb9-1330" aria-hidden="true" tabindex="-1"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Current date/time: 2025-04-20 15:55:04.576855
===== Buy Low / Sell High Strategy System =====

Fetching data for AAPL...
Fetched 502 data points for AAPL
Fetching benchmark data for SPY...
Fetching data for SPY...
Adding technical indicators...
Starting enhanced parameter optimization...

Enhanced Best Parameters: RSI=35, ATR Stop=2.0, ATR Take=5.0, Score=1.40
Parameter optimization results available but visualization disabled.
Best parameters from optimization process (Note: optimization Sharpe differs from final backtest): RSI=35.0, ATR Stop=2.0, ATR Take=5.0, Optimization Sharpe=1.42

Using parameters for final backtest: RSI=35, ATR Stop=2.0, ATR Take=5.0
Note: Final performance metrics may differ from optimization due to different calculation methods.

=== Running Final Backtest with Optimal Parameters ===
Backtesting strategy...

Backtest Summary: 222 trades completed with 55.41% win rate

=== Detailed Trade Analysis ===
Total Trades: 222
Win Rate: 55.41%  (Wins=123, Losses=99)
Avg Trade Profit: 58.04
Avg Win: 284.53,  Avg Loss: -223.36
Profit Factor: 1.58
Avg Holding Duration: 1.5 days  (Max=4d, Min=1d)
Max Consecutive Wins: 7
Max Consecutive Losses: 6

Recent 10 Trades (most recent first):
  2025-04-16 -&gt; 2025-04-17 (1 days): $197.02 -&gt; $196.98, Loss $5.73, Return=-0.02%
  2025-04-14 -&gt; 2025-04-15 (1 days): $201.76 -&gt; $202.14, Profit $53.13, Return=0.19%
  2025-04-10 -&gt; 2025-04-11 (1 days): $186.10 -&gt; $198.15, Profit $1797.46, Return=6.48%
  2025-04-08 -&gt; 2025-04-09 (1 days): $172.06 -&gt; $198.85, Profit $4160.32, Return=15.57%
  2025-04-04 -&gt; 2025-04-07 (3 days): $177.21 -&gt; $181.46, Profit $637.00, Return=2.40%
  2025-04-02 -&gt; 2025-04-03 (1 days): $205.53 -&gt; $203.19, Loss $303.26, Return=-1.14%
  2025-03-31 -&gt; 2025-04-01 (1 days): $219.87 -&gt; $223.19, Profit $400.69, Return=1.51%
  2025-03-27 -&gt; 2025-03-28 (1 days): $221.73 -&gt; $217.90, Loss $460.36, Return=-1.73%
  2025-03-25 -&gt; 2025-03-26 (1 days): $223.51 -&gt; $221.53, Loss $236.62, Return=-0.89%
  2025-03-21 -&gt; 2025-03-24 (3 days): $221.00 -&gt; $220.73, Loss $32.64, Return=-0.12%

==================================================
                  BLOTTER (TRADE RECORD)                 
==================================================
Entry Date   Exit Date    Days     Entry      Exit       Shares     Profit/Loss  Return     Exit Reason    
--------------------------------------------------------------------------------------------------------------
2023-05-16   2023-05-17   1        $171.71    $172.69    145        $142.68      0.57%      Unknown        
2023-05-18   2023-05-19   1        $176.11    $175.16    142        $-135.05     -0.54%     Unknown        
2023-05-22   2023-05-23   1        $173.13    $171.56    144        $-226.73     -0.91%     Unknown        
2023-05-24   2023-05-25   1        $172.50    $172.99    144        $70.86       0.28%      Unknown        
2023-05-26   2023-05-30   4        $176.99    $177.30    141        $43.72       0.18%      Unknown        
2023-05-31   2023-06-01   1        $177.70    $180.09    140        $335.89      1.34%      RSI_Overbought 
2023-06-02   2023-06-05   3        $182.63    $179.58    137        $-418.48     -1.67%     Unknown        
2023-06-06   2023-06-07   1        $178.44    $177.82    139        $-86.70      -0.35%     Unknown        
2023-06-08   2023-06-09   1        $181.52    $180.96    137        $-76.92      -0.31%     Unknown        
2023-06-12   2023-06-13   1        $182.79    $183.31    136        $70.87       0.28%      RSI_Overbought 
2023-06-14   2023-06-15   1        $183.98    $186.01    135        $275.07      1.10%      RSI_Overbought 
2023-06-16   2023-06-20   4        $184.41    $185.01    135        $81.34       0.33%      RSI_Overbought 
2023-06-21   2023-06-22   1        $183.74    $187.00    136        $443.90      1.77%      RSI_Overbought 
2023-06-23   2023-06-26   3        $186.80    $185.27    134        $-205.83     -0.82%     Unknown        
2023-06-27   2023-06-28   1        $187.97    $189.25    133        $170.78      0.68%      RSI_Overbought 
2023-06-29   2023-06-30   1        $191.63    $193.97    131        $306.76      1.22%      RSI_Overbought 
2023-07-03   2023-07-05   2        $191.57    $191.33    131        $-31.57      -0.13%     Unknown        
2023-07-06   2023-07-07   1        $191.40    $190.68    131        $-94.76      -0.38%     Unknown        
2023-07-10   2023-07-11   1        $189.16    $188.08    133        $-143.69     -0.57%     Unknown        
2023-07-12   2023-07-13   1        $190.50    $190.54    131        $5.28        0.02%      Unknown        
2023-07-14   2023-07-17   3        $191.90    $193.99    130        $273.71      1.09%      Unknown        
2023-07-18   2023-07-19   1        $193.10    $195.10    130        $261.01      1.04%      RSI_Overbought 
2023-07-20   2023-07-21   1        $194.10    $191.94    130        $-281.16     -1.11%     Unknown        
2023-07-24   2023-07-25   1        $193.39    $193.62    130        $29.96       0.12%      Unknown        
2023-07-26   2023-07-27   1        $196.05    $193.22    128        $-363.80     -1.44%     Unknown        
2023-07-28   2023-07-31   3        $196.09    $196.45    128        $46.10       0.18%      Unknown        
2023-08-01   2023-08-02   1        $195.04    $192.58    128        $-316.88     -1.26%     Unknown        
2023-08-03   2023-08-04   1        $185.52    $181.99    134        $-476.53     -1.90%     SMA_Breakdown  
2023-08-07   2023-08-08   1        $179.70    $179.80    138        $13.87       0.06%      SMA_Breakdown  
2023-08-09   2023-08-10   1        $179.47    $177.97    138        $-208.35     -0.84%     SMA_Breakdown  
2023-08-11   2023-08-14   3        $177.92    $179.46    139        $215.32      0.87%      SMA_Breakdown  
2023-08-15   2023-08-16   1        $177.13    $176.57    140        $-78.82      -0.32%     SMA_Breakdown  
2023-08-17   2023-08-18   1        $172.30    $174.49    144        $316.62      1.27%      SMA_Breakdown  
2023-08-21   2023-08-22   1        $177.06    $177.23    141        $23.99       0.10%      SMA_Breakdown  
2023-08-23   2023-08-24   1        $180.73    $176.38    138        $-601.62     -2.41%     SMA_Breakdown  
2023-08-25   2023-08-28   3        $180.09    $180.19    137        $13.80       0.06%      SMA_Breakdown  
2023-08-29   2023-08-30   1        $184.81    $187.65    134        $381.85      1.54%      Unknown        
2023-08-31   2023-09-01   1        $189.57    $189.46    131        $-14.47      -0.06%     Unknown        
2023-09-06   2023-09-07   1        $175.19    $177.56    142        $337.40      1.35%      SMA_Breakdown  
2023-09-08   2023-09-11   3        $180.08    $179.36    138        $-100.05     -0.40%     SMA_Breakdown  
2023-09-12   2023-09-13   1        $176.50    $174.21    141        $-324.36     -1.30%     SMA_Breakdown  
2023-09-14   2023-09-15   1        $176.41    $175.01    141        $-197.76     -0.79%     SMA_Breakdown  
2023-09-18   2023-09-19   1        $177.52    $179.07    140        $217.14      0.87%      SMA_Breakdown  
2023-09-20   2023-09-21   1        $174.55    $173.93    142        $-88.53      -0.36%     SMA_Breakdown  
2023-09-22   2023-09-25   3        $174.20    $176.08    142        $268.74      1.08%      SMA_Breakdown  
2023-09-26   2023-09-27   1        $172.62    $170.43    144        $-316.77     -1.27%     SMA_Breakdown  
2023-09-28   2023-09-29   1        $172.02    $171.21    144        $-117.20     -0.47%     SMA_Breakdown  
2023-10-02   2023-10-03   1        $172.29    $172.40    144        $15.87       0.06%      SMA_Breakdown  
2023-10-04   2023-10-05   1        $173.74    $174.91    143        $167.44      0.67%      SMA_Breakdown  
2023-10-06   2023-10-09   3        $176.80    $178.99    140        $308.51      1.24%      SMA_Breakdown  
2023-10-10   2023-10-11   1        $178.25    $179.80    140        $217.24      0.87%      Unknown        
2023-10-12   2023-10-13   1        $181.39    $178.85    138        $-350.60     -1.40%     Unknown        
2023-10-16   2023-10-17   1        $176.67    $177.15    141        $67.79       0.27%      SMA_Breakdown  
2023-10-18   2023-10-19   1        $176.00    $175.46    141        $-76.60      -0.31%     SMA_Breakdown  
2023-10-20   2023-10-23   3        $170.91    $173.00    145        $305.08      1.22%      SMA_Breakdown  
2023-10-24   2023-10-25   1        $171.88    $171.10    145        $-113.56     -0.45%     SMA_Breakdown  
2023-10-26   2023-10-27   1        $166.91    $168.22    149        $196.18      0.78%      SMA_Breakdown  
2023-10-30   2023-10-31   1        $169.27    $170.77    147        $221.93      0.89%      SMA_Breakdown  
2023-11-01   2023-11-02   1        $175.52    $177.57    143        $293.16      1.17%      Unknown        
2023-11-03   2023-11-06   3        $176.36    $179.23    142        $409.66      1.63%      Unknown        
2023-11-07   2023-11-08   1        $182.41    $182.89    138        $66.51       0.26%      Unknown        
2023-11-09   2023-11-10   1        $183.97    $186.40    137        $334.08      1.32%      Unknown        
2023-11-13   2023-11-14   1        $187.69    $187.44    135        $-33.80      -0.13%     Unknown        
2023-11-24   2023-11-27   3        $189.91    $189.79    133        $-16.03      -0.06%     Unknown        
2023-11-28   2023-11-29   1        $190.91    $189.37    132        $-204.60     -0.81%     Unknown        
2023-11-30   2023-12-01   1        $190.33    $191.24    132        $121.02      0.48%      Unknown        
2023-12-04   2023-12-05   1        $190.21    $193.42    133        $427.68      1.69%      Unknown        
2023-12-06   2023-12-07   1        $193.63    $194.27    131        $84.12       0.33%      Unknown        
2023-12-08   2023-12-11   3        $193.22    $193.18    131        $-5.27       -0.02%     Unknown        
2023-12-12   2023-12-13   1        $195.08    $197.96    130        $376.00      1.48%      Unknown        
2023-12-14   2023-12-15   1        $197.53    $197.57    129        $5.18        0.02%      Unknown        
2023-12-18   2023-12-19   1        $196.15    $196.94    130        $102.96      0.40%      Unknown        
2023-12-20   2023-12-21   1        $196.13    $194.68    130        $-189.19     -0.74%     Unknown        
2023-12-22   2023-12-26   4        $193.61    $193.05    131        $-73.88      -0.29%     Unknown        
2023-12-27   2023-12-28   1        $194.09    $193.58    131        $-67.07      -0.26%     Unknown        
2023-12-29   2024-01-02   4        $187.17    $185.64    136        $-208.51     -0.82%     SMA_Breakdown  
2024-01-03   2024-01-04   1        $182.17    $181.91    139        $-36.33      -0.14%     SMA_Breakdown  
2024-01-05   2024-01-08   3        $182.15    $185.56    139        $476.38      1.87%      SMA_Breakdown  
2024-01-09   2024-01-10   1        $184.31    $186.19    138        $260.77      1.02%      SMA_Breakdown  
2024-01-11   2024-01-12   1        $186.05    $185.92    137        $-17.91      -0.07%     SMA_Breakdown  
2024-01-16   2024-01-17   1        $181.33    $182.68    141        $190.79      0.74%      SMA_Breakdown  
2024-01-18   2024-01-19   1        $189.40    $191.56    135        $292.80      1.14%      Unknown        
2024-01-22   2024-01-23   1        $195.01    $195.18    132        $22.45       0.09%      Unknown        
2024-01-24   2024-01-25   1        $195.22    $194.17    131        $-138.51     -0.54%     Unknown        
2024-01-26   2024-01-29   3        $192.01    $191.73    133        $-37.50      -0.15%     Unknown        
2024-01-30   2024-01-31   1        $187.13    $184.40    137        $-375.06     -1.46%     SMA_Breakdown  
2024-02-01   2024-02-02   1        $179.87    $185.85    142        $851.60      3.32%      SMA_Breakdown  
2024-02-05   2024-02-06   1        $186.90    $189.30    138        $331.66      1.28%      SMA_Breakdown  
2024-02-07   2024-02-08   1        $189.35    $188.32    136        $-140.95     -0.54%     SMA_Breakdown  
2024-02-09   2024-02-12   3        $188.44    $187.15    137        $-177.14     -0.68%     SMA_Breakdown  
2024-02-13   2024-02-14   1        $185.32    $184.15    139        $-163.08     -0.63%     SMA_Breakdown  
2024-02-15   2024-02-16   1        $183.42    $182.31    140        $-156.08     -0.61%     SMA_Breakdown  
2024-02-20   2024-02-21   1        $181.94    $182.32    141        $53.78       0.21%      SMA_Breakdown  
2024-02-22   2024-02-23   1        $185.01    $182.52    139        $-346.76     -1.35%     SMA_Breakdown  
2024-02-26   2024-02-27   1        $181.09    $182.63    141        $218.37      0.85%      SMA_Breakdown  
2024-02-28   2024-02-29   1        $181.26    $180.75    141        $-72.40      -0.28%     SMA_Breakdown  
2024-03-01   2024-03-04   3        $176.14    $175.10    145        $-151.83     -0.59%     SMA_Breakdown  
2024-03-05   2024-03-06   1        $171.11    $169.12    150        $-298.62     -1.16%     SMA_Breakdown  
2024-03-07   2024-03-08   1        $168.98    $170.73    151        $265.14      1.04%      SMA_Breakdown  
2024-03-11   2024-03-12   1        $173.19    $173.23    148        $5.93        0.02%      SMA_Breakdown  
2024-03-13   2024-03-14   1        $172.91    $173.00    148        $13.36       0.05%      SMA_Breakdown  
2024-03-15   2024-03-18   3        $175.57    $173.72    146        $-270.52     -1.05%     SMA_Breakdown  
2024-03-19   2024-03-20   1        $175.72    $178.67    145        $429.87      1.68%      SMA_Breakdown  
2024-03-21   2024-03-22   1        $171.69    $172.28    149        $88.36       0.34%      SMA_Breakdown  
2024-03-25   2024-03-26   1        $170.02    $169.71    151        $-46.92      -0.18%     SMA_Breakdown  
2024-03-27   2024-03-28   1        $171.71    $171.48    149        $-34.46      -0.13%     SMA_Breakdown  
2024-04-01   2024-04-02   1        $169.08    $168.84    152        $-36.50      -0.14%     SMA_Breakdown  
2024-04-03   2024-04-04   1        $170.33    $168.82    150        $-227.88     -0.89%     SMA_Breakdown  
2024-04-05   2024-04-08   3        $169.03    $168.45    151        $-88.01      -0.34%     SMA_Breakdown  
2024-04-09   2024-04-10   1        $168.80    $167.78    151        $-154.85     -0.60%     SMA_Breakdown  
2024-04-11   2024-04-12   1        $174.26    $176.55    146        $336.26      1.31%      SMA_Breakdown  
2024-04-15   2024-04-16   1        $171.75    $169.38    149        $-354.25     -1.38%     SMA_Breakdown  
2024-04-17   2024-04-18   1        $168.07    $167.04    152        $-156.79     -0.61%     SMA_Breakdown  
2024-04-19   2024-04-22   3        $165.57    $165.84    154        $41.66       0.16%      SMA_Breakdown  
2024-04-23   2024-04-24   1        $166.54    $169.02    153        $380.54      1.49%      SMA_Breakdown  
2024-04-25   2024-04-26   1        $169.83    $169.30    151        $-80.05      -0.31%     SMA_Breakdown  
2024-04-29   2024-04-30   1        $173.20    $170.33    147        $-424.70     -1.66%     SMA_Breakdown  
2024-05-01   2024-05-02   1        $172.43    $173.03    148        $88.81       0.35%      Unknown        
2024-05-22   2024-05-23   1        $190.98    $186.88    133        $-548.42     -2.15%     Unknown        
2024-05-24   2024-05-28   4        $191.51    $189.99    132        $-201.67     -0.79%     Unknown        
2024-05-29   2024-05-30   1        $190.78    $191.29    132        $67.79       0.27%      Unknown        
2024-05-31   2024-06-03   3        $193.01    $194.03    131        $134.10      0.53%      Unknown        
2024-06-04   2024-06-05   1        $195.44    $195.87    130        $55.90       0.22%      RSI_Overbought 
2024-06-06   2024-06-07   1        $194.65    $196.89    130        $292.56      1.15%      RSI_Overbought 
2024-06-10   2024-06-11   1        $193.69    $207.15    131        $1771.77     6.95%      RSI_Overbought 
2024-06-21   2024-06-24   3        $207.67    $208.14    124        $58.70       0.23%      Unknown        
2024-06-25   2024-06-26   1        $211.50    $213.25    122        $214.75      0.83%      Unknown        
2024-06-27   2024-06-28   1        $215.79    $210.62    120        $-623.09     -2.40%     Unknown        
2024-07-01   2024-07-02   1        $216.15    $220.27    119        $492.75      1.91%      RSI_Overbought 
2024-07-11   2024-07-12   1        $228.92    $230.54    113        $183.81      0.71%      RSI_Overbought 
2024-07-17   2024-07-18   1        $230.14    $224.18    113        $-673.86     -2.59%     Unknown        
2024-07-19   2024-07-22   3        $226.99    $223.96    113        $-345.09     -1.33%     Unknown        
2024-07-23   2024-07-24   1        $224.06    $218.54    114        $-634.77     -2.46%     Unknown        
2024-07-25   2024-07-26   1        $218.69    $217.96    117        $-85.48      -0.33%     Unknown        
2024-07-29   2024-07-30   1        $219.20    $218.80    116        $-46.69      -0.18%     Unknown        
2024-07-31   2024-08-01   1        $224.37    $218.36    113        $-685.03     -2.68%     Unknown        
2024-08-02   2024-08-05   3        $199.09    $209.27    127        $1298.92     5.11%      SMA_Breakdown  
2024-08-06   2024-08-07   1        $206.94    $209.82    124        $358.05      1.39%      SMA_Breakdown  
2024-08-08   2024-08-09   1        $212.10    $216.24    121        $503.93      1.95%      Unknown        
2024-08-12   2024-08-13   1        $219.06    $221.27    118        $261.73      1.01%      Unknown        
2024-08-14   2024-08-15   1        $224.49    $224.72    115        $26.65       0.10%      Unknown        
2024-08-16   2024-08-19   3        $225.67    $225.89    115        $25.36       0.10%      Unknown        
2024-08-20   2024-08-21   1        $226.51    $226.40    114        $-12.64      -0.05%     Unknown        
2024-08-22   2024-08-23   1        $225.79    $226.84    115        $120.99      0.47%      Unknown        
2024-08-26   2024-08-27   1        $226.00    $228.03    115        $233.98      0.90%      Unknown        
2024-08-28   2024-08-29   1        $230.10    $229.79    113        $-35.17      -0.13%     Unknown        
2024-08-30   2024-09-03   4        $228.55    $222.77    114        $-660.02     -2.53%     Unknown        
2024-09-04   2024-09-05   1        $221.73    $222.38    116        $76.02       0.29%      SMA_Breakdown  
2024-09-06   2024-09-09   3        $220.83    $220.91    117        $9.40        0.04%      SMA_Breakdown  
2024-09-10   2024-09-11   1        $221.49    $222.66    117        $137.10      0.53%      SMA_Breakdown  
2024-09-12   2024-09-13   1        $223.61    $222.50    116        $-129.01     -0.50%     SMA_Breakdown  
2024-09-16   2024-09-17   1        $215.75    $216.79    120        $125.12      0.48%      SMA_Breakdown  
2024-09-18   2024-09-19   1        $225.00    $228.87    115        $446.99      1.72%      Unknown        
2024-09-20   2024-09-23   3        $227.34    $226.47    114        $-99.88      -0.38%     Unknown        
2024-09-24   2024-09-25   1        $225.01    $226.37    115        $157.60      0.60%      Unknown        
2024-09-26   2024-09-27   1        $228.48    $227.79    114        $-78.86      -0.30%     Unknown        
2024-09-30   2024-10-01   1        $229.52    $226.21    113        $-376.32     -1.44%     Unknown        
2024-10-02   2024-10-03   1        $225.14    $225.67    115        $61.21       0.24%      Unknown        
2024-10-04   2024-10-07   3        $224.49    $221.69    115        $-324.49     -1.25%     SMA_Breakdown  
2024-10-08   2024-10-09   1        $225.31    $229.54    115        $486.90      1.88%      Unknown        
2024-10-10   2024-10-11   1        $229.49    $227.55    113        $-220.27     -0.85%     Unknown        
2024-10-14   2024-10-15   1        $233.60    $233.85    111        $27.83       0.11%      Unknown        
2024-10-16   2024-10-17   1        $233.43    $232.15    111        $-142.61     -0.55%     Unknown        
2024-10-18   2024-10-21   3        $234.50    $236.48    110        $219.30      0.84%      Unknown        
2024-10-22   2024-10-23   1        $234.13    $230.76    111        $-374.63     -1.44%     Unknown        
2024-10-24   2024-10-25   1        $229.74    $231.41    112        $188.51      0.73%      Unknown        
2024-10-28   2024-10-29   1        $233.26    $233.67    111        $45.67       0.18%      Unknown        
2024-10-30   2024-10-31   1        $229.51    $225.91    113        $-407.70     -1.57%     SMA_Breakdown  
2024-11-01   2024-11-04   3        $220.93    $222.01    117        $126.56      0.49%      SMA_Breakdown  
2024-11-05   2024-11-06   1        $222.58    $222.72    116        $16.30       0.06%      SMA_Breakdown  
2024-11-07   2024-11-08   1        $227.17    $226.96    114        $-23.97      -0.09%     Unknown        
2024-11-11   2024-11-12   1        $224.43    $224.23    115        $-23.10      -0.09%     SMA_Breakdown  
2024-11-13   2024-11-14   1        $225.11    $228.22    115        $358.02      1.38%      Unknown        
2024-11-15   2024-11-18   3        $225.22    $228.02    115        $323.29      1.24%      Unknown        
2024-11-19   2024-11-20   1        $228.06    $229.00    114        $107.51      0.41%      Unknown        
2024-11-21   2024-11-22   1        $228.21    $229.87    114        $189.93      0.73%      Unknown        
2024-11-25   2024-11-26   1        $233.35    $235.06    112        $191.69      0.73%      Unknown        
2024-11-27   2024-11-29   2        $234.84    $237.33    111        $277.87      1.06%      Unknown        
2024-12-02   2024-12-03   1        $239.82    $242.65    109        $310.07      1.18%      RSI_Overbought 
2024-12-05   2024-12-06   1        $242.91    $242.84    108        $-7.59       -0.03%     RSI_Overbought 
2024-12-11   2024-12-12   1        $246.89    $247.96    106        $114.21      0.43%      RSI_Overbought 
2024-12-13   2024-12-16   3        $247.99    $251.04    106        $324.45      1.23%      RSI_Overbought 
2024-12-18   2024-12-19   1        $247.50    $249.79    106        $244.84      0.93%      Unknown        
2024-12-20   2024-12-23   3        $254.77    $255.27    104        $52.05       0.20%      RSI_Overbought 
2024-12-24   2024-12-26   2        $258.19    $259.02    102        $85.30       0.32%      RSI_Overbought 
2024-12-27   2024-12-30   3        $252.22    $252.20    105        $-2.11       -0.01%     Unknown        
2024-12-31   2025-01-02   2        $248.93    $243.85    106        $-541.95     -2.04%     Unknown        
2025-01-03   2025-01-06   3        $244.36    $245.00    108        $69.20       0.26%      Unknown        
2025-01-07   2025-01-08   1        $241.92    $242.70    109        $85.24       0.32%      Unknown        
2025-01-10   2025-01-13   3        $233.65    $234.40    113        $84.93       0.32%      SMA_Breakdown  
2025-01-14   2025-01-15   1        $234.73    $237.87    112        $354.24      1.34%      SMA_Breakdown  
2025-01-16   2025-01-17   1        $232.12    $229.98    114        $-244.95     -0.92%     SMA_Breakdown  
2025-01-21   2025-01-22   1        $219.75    $223.83    120        $492.17      1.86%      SMA_Breakdown  
2025-01-23   2025-01-24   1        $224.78    $222.78    118        $-236.95     -0.89%     SMA_Breakdown  
2025-01-27   2025-01-28   1        $230.84    $238.26    115        $854.12      3.21%      SMA_Breakdown  
2025-01-29   2025-01-30   1        $238.67    $237.59    112        $-121.21     -0.45%     SMA_Breakdown  
2025-01-31   2025-02-03   3        $229.99    $228.01    116        $-230.34     -0.86%     SMA_Breakdown  
2025-02-04   2025-02-05   1        $228.53    $232.47    116        $460.29      1.72%      SMA_Breakdown  
2025-02-06   2025-02-07   1        $232.54    $227.63    115        $-566.14     -2.11%     SMA_Breakdown  
2025-02-10   2025-02-11   1        $228.20    $232.62    116        $516.59      1.94%      SMA_Breakdown  
2025-02-12   2025-02-13   1        $236.91    $241.53    113        $522.64      1.95%      Unknown        
2025-02-19   2025-02-20   1        $244.94    $245.83    109        $97.86       0.36%      Unknown        
2025-02-21   2025-02-24   3        $245.00    $247.10    110        $231.05      0.86%      Unknown        
2025-02-25   2025-02-26   1        $244.38    $240.36    110        $-444.36     -1.64%     SMA_Breakdown  
2025-02-27   2025-02-28   1        $236.98    $241.84    113        $551.71      2.05%      Unknown        
2025-03-03   2025-03-04   1        $237.71    $235.93    113        $-202.48     -0.75%     SMA_Breakdown  
2025-03-05   2025-03-06   1        $234.44    $235.33    115        $102.46      0.38%      SMA_Breakdown  
2025-03-07   2025-03-10   3        $235.54    $227.48    114        $-924.44     -3.42%     SMA_Breakdown  
2025-03-11   2025-03-12   1        $220.14    $216.98    121        $-384.47     -1.44%     SMA_Breakdown  
2025-03-13   2025-03-14   1        $211.25    $213.49    126        $282.99      1.06%      SMA_Breakdown  
2025-03-17   2025-03-18   1        $214.15    $212.69    124        $-182.43     -0.68%     SMA_Breakdown  
2025-03-19   2025-03-20   1        $213.92    $214.10    124        $22.48       0.08%      SMA_Breakdown  
2025-03-21   2025-03-24   3        $221.00    $220.73    120        $-32.64      -0.12%     SMA_Breakdown  
2025-03-25   2025-03-26   1        $223.51    $221.53    119        $-236.62     -0.89%     SMA_Breakdown  
2025-03-27   2025-03-28   1        $221.73    $217.90    120        $-460.36     -1.73%     SMA_Breakdown  
2025-03-31   2025-04-01   1        $219.87    $223.19    120        $400.69      1.51%      SMA_Breakdown  
2025-04-02   2025-04-03   1        $205.53    $203.19    129        $-303.26     -1.14%     SMA_Breakdown  
2025-04-04   2025-04-07   3        $177.21    $181.46    149        $637.00      2.40%      SMA_Breakdown  
2025-04-08   2025-04-09   1        $172.06    $198.85    155        $4160.32     15.57%     SMA_Breakdown  
2025-04-10   2025-04-11   1        $186.10    $198.15    149        $1797.46     6.48%      SMA_Breakdown  
2025-04-14   2025-04-15   1        $201.76    $202.14    139        $53.13       0.19%      SMA_Breakdown  
2025-04-16   2025-04-17   1        $197.02    $196.98    143        $-5.73       -0.02%     SMA_Breakdown  
--------------------------------------------------------------------------------------------------------------

===== EXIT REASON ANALYSIS =====
RSI_Overbought: 19.0 trades, Win Rate: 94.7%, Avg Profit: $295.84, Total: $5620.91, Avg Duration: 1.4 days
SMA_Breakdown: 106.0 trades, Win Rate: 49.1%, Avg Profit: $64.34, Total: $6820.07, Avg Duration: 1.4 days
Unknown: 97.0 trades, Win Rate: 54.6%, Avg Profit: $4.57, Total: $443.65, Avg Duration: 1.5 days

===== TRADE STATISTICS =====
Total Trades: 222
Winning Trades: 123 (55.4%)
Losing Trades: 99 (44.6%)
Total Profit/Loss: $12884.63
Average Profit/Loss: $58.04
Average Win: $284.53
Average Loss: $-223.36
Profit/Loss Ratio: 1.27
Largest Win: $4160.32
Largest Loss: $-924.44
Average Holding Period: 1.5 days
Return on Investment (ROI): 12.88%

===== BEST TRADE =====
Date: 2025-04-08 to 2025-04-09
Holding Days: 1 days
Entry Price: $172.06, Exit Price: $198.85
Shares: 155
Profit: $4160.32 (15.57%)
Exit Reason: SMA_Breakdown

===== WORST TRADE =====
Date: 2025-03-07 to 2025-03-10
Holding Days: 3 days
Entry Price: $235.54, Exit Price: $227.48
Shares: 114
Loss: $-924.44 (-3.42%)
Exit Reason: SMA_Breakdown

==================================================
                 LEDGER (ACCOUNT BOOK)                
==================================================
Period: Weekly
Date         Account($)      Cash($)         Equity($)       Drawdown(%)     Return(%)      
------------------------------------------------------------------------------------------
2023-04-23   100000.00       100000.00       0.00            0.00            0.00           
2023-04-30   100000.00       100000.00       0.00            0.00            0.00           
2023-05-07   100000.00       100000.00       0.00            0.00            0.00           
2023-05-14   100000.00       100000.00       0.00            0.00            0.00           
2023-05-21   100007.63       100007.63       0.00            0.00            0.01           
2023-05-28   99851.76        74888.82        24962.94        -0.16           -0.15          
2023-06-04   100231.38       75173.53        25057.84        0.00            0.23           
2023-06-11   99649.28        99649.28        0.00            -0.58           -0.35          
2023-06-18   99995.23        74996.42        24998.81        -0.24           -0.00          
2023-06-25   100520.46       75390.35        25130.12        0.00            0.52           
2023-07-02   100792.17       100792.17       0.00            0.00            0.79           
2023-07-09   100665.84       100665.84       0.00            -0.13           0.67           
2023-07-16   100527.43       75395.57        25131.86        -0.26           0.53           
2023-07-23   100780.99       100780.99       0.00            -0.01           0.78           
2023-07-30   100447.15       75335.36        25111.79        -0.34           0.45           
2023-08-06   99699.85        99699.85        0.00            -1.08           -0.30          
2023-08-13   99505.37        74629.03        24876.34        -1.28           -0.49          
2023-08-20   99958.49        99958.49        0.00            -0.83           -0.04          
2023-08-27   99380.86        74535.65        24845.22        -1.40           -0.62          
2023-09-03   99762.04        99762.04        0.00            -1.02           -0.24          
2023-09-10   100099.44       75074.58        25024.86        -0.69           0.10           
2023-09-17   99477.27        99477.27        0.00            -1.30           -0.52          
2023-09-24   99605.88        74704.41        24901.47        -1.18           -0.39          
2023-10-01   99440.65        99440.65        0.00            -1.34           -0.56          
2023-10-08   99623.96        74717.97        24905.99        -1.16           -0.38          
2023-10-15   99799.12        99799.12        0.00            -0.99           -0.20          
2023-10-22   99790.30        74842.73        24947.58        -0.99           -0.21          
2023-10-29   100178.00       100178.00       0.00            -0.61           0.18           
2023-11-05   100693.09       75519.82        25173.27        -0.10           0.69           
2023-11-12   101503.33       101503.33       0.00            0.00            1.50           
2023-11-19   101469.53       101469.53       0.00            -0.03           1.47           
2023-11-26   101469.53       76102.15        25367.38        -0.03           1.47           
2023-12-03   101369.93       101369.93       0.00            -0.13           1.37           
2023-12-10   101881.73       76411.30        25470.43        0.00            1.88           
2023-12-17   102257.64       102257.64       0.00            0.00            2.26           
2023-12-24   102171.41       76628.56        25542.85        -0.08           2.17           
2023-12-31   102030.46       76522.85        25507.62        -0.22           2.03           
2024-01-07   101785.62       76339.22        25446.41        -0.46           1.79           
2024-01-14   102504.86       102504.86       0.00            0.00            2.50           
2024-01-21   102988.45       102988.45       0.00            0.00            2.99           
2024-01-28   102872.38       77154.28        25718.09        -0.11           2.87           
2024-02-04   103311.42       103311.42       0.00            0.00            3.31           
2024-02-11   103502.13       77626.60        25875.53        0.00            3.50           
2024-02-18   103005.83       103005.83       0.00            -0.48           3.01           
2024-02-25   102712.86       102712.86       0.00            -0.76           2.71           
2024-03-03   102858.82       77144.12        25714.71        -0.62           2.86           
2024-03-10   102673.51       102673.51       0.00            -0.80           2.67           
2024-03-17   102692.80       77019.60        25673.20        -0.78           2.69           
2024-03-24   102940.51       102940.51       0.00            -0.54           2.94           
2024-03-31   102859.13       102859.13       0.00            -0.62           2.86           
2024-04-07   102594.75       76946.06        25648.69        -0.88           2.59           
2024-04-14   102688.14       102688.14       0.00            -0.79           2.69           
2024-04-21   102177.11       76632.83        25544.28        -1.28           2.18           
2024-04-28   102519.26       102519.26       0.00            -0.95           2.52           
2024-05-05   102183.38       102183.38       0.00            -1.27           2.18           
2024-05-12   102183.38       102183.38       0.00            -1.27           2.18           
2024-05-19   102183.38       102183.38       0.00            -1.27           2.18           
2024-05-26   101634.95       76226.21        25408.74        -1.80           1.63           
2024-06-02   101501.07       76125.80        25375.27        -1.93           1.50           
2024-06-09   101983.64       101983.64       0.00            -1.47           1.98           
2024-06-16   103755.41       103755.41       0.00            0.00            3.76           
2024-06-23   103755.41       77816.56        25938.85        0.00            3.76           
2024-06-30   103405.77       103405.77       0.00            -0.34           3.41           
2024-07-07   103898.52       103898.52       0.00            0.00            3.90           
2024-07-14   104082.33       104082.33       0.00            0.00            4.08           
2024-07-21   103408.47       77556.35        25852.12        -0.65           3.41           
2024-07-28   102343.13       102343.13       0.00            -1.67           2.34           
2024-08-04   101611.41       76208.56        25402.85        -2.37           1.61           
2024-08-11   103772.30       103772.30       0.00            -0.30           3.77           
2024-08-18   104060.68       78045.51        26015.17        -0.02           4.06           
2024-08-25   104194.40       104194.40       0.00            0.00            4.19           
2024-09-01   104393.20       78294.90        26098.30        0.00            4.39           
2024-09-08   103809.20       77856.90        25952.30        -0.56           3.81           
2024-09-15   103826.70       103826.70       0.00            -0.54           3.83           
2024-09-22   104398.81       78299.11        26099.70        0.00            4.40           
2024-09-29   104377.67       104377.67       0.00            -0.02           4.38           
2024-10-06   104062.56       78046.92        26015.64        -0.32           4.06           
2024-10-13   104004.70       104004.70       0.00            -0.38           4.00           
2024-10-20   103889.92       77917.44        25972.48        -0.49           3.89           
2024-10-27   103923.10       103923.10       0.00            -0.46           3.92           
2024-11-03   103561.06       77670.80        25890.27        -0.80           3.56           
2024-11-10   103679.96       103679.96       0.00            -0.69           3.68           
2024-11-17   104014.88       78011.16        26003.72        -0.37           4.01           
2024-11-24   104635.62       104635.62       0.00            0.00            4.64           
2024-12-01   105105.18       105105.18       0.00            0.00            5.11           
2024-12-08   105407.66       105407.66       0.00            0.00            5.41           
2024-12-15   105521.87       79141.40        26380.47        0.00            5.52           
2024-12-22   106091.15       79568.36        26522.79        0.00            6.09           
2024-12-29   106228.51       79671.38        26557.13        0.00            6.23           
2025-01-05   105684.45       79263.34        26421.11        -0.51           5.68           
2025-01-12   105838.90       79379.17        26459.72        -0.37           5.84           
2025-01-19   106033.11       106033.11       0.00            -0.18           6.03           
2025-01-26   106288.33       106288.33       0.00            0.00            6.29           
2025-02-02   107021.24       80265.93        26755.31        0.00            7.02           
2025-02-09   106685.04       106685.04       0.00            -0.31           6.69           
2025-02-16   107724.27       107724.27       0.00            0.00            7.72           
2025-02-23   107822.13       80866.60        26955.53        0.00            7.82           
2025-03-02   108160.53       108160.53       0.00            0.00            8.16           
2025-03-09   108060.51       81045.38        27015.13        -0.09           8.06           
2025-03-16   107034.58       107034.58       0.00            -1.04           7.03           
2025-03-23   106874.63       80155.97        26718.66        -1.19           6.87           
2025-03-30   106145.01       106145.01       0.00            -1.86           6.15           
2025-04-06   106242.44       79681.83        26560.61        -1.77           6.24           
2025-04-13   112837.23       112837.23       0.00            0.00            12.84          
2025-04-20   112884.63       112884.63       0.00            0.00            12.88          
------------------------------------------------------------------------------------------
Initial Account Value: $100000.00
Final Account Value: $112884.63
Total Return: 12.88%
Maximum Drawdown: -2.37%
Generating comprehensive strategy visualizations...</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="lbx_files/figure-html/cell-10-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chart 1 generated (Price &amp; RSI with signals) and saved to AAPL_trading_signals.png</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="lbx_files/figure-html/cell-10-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chart 2 generated (Portfolio value, Drawdown, Monthly returns) and saved to AAPL_portfolio_performance.png</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="lbx_files/figure-html/cell-10-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chart 3 generated (Trade distribution) and saved to AAPL_trade_analysis.png
Advanced metrics visualization disabled.
Daily Returns - Mean: 0.02%, Std Dev: 0.28%
Max Drawdown: -2.37%

===== TRADING SIGNALS TABLE =====
Date         Action Price      RSI        BB Status       Exit Reason     Profit/Loss  Return     Duration  
--------------------------------------------------------------------------------------------------------------
2023-05-16   Buy    $171.71    58.7       5.9% from BB Lower Unknown         $142.68      0.57%      1 days    
2023-05-18   Buy    $176.11    66.6       7.6% from BB Lower Unknown         $-135.05     -0.54%     1 days    
2023-05-22   Buy    $173.13    62.4       6.3% from BB Lower Unknown         $-226.73     -0.91%     1 days    
2023-05-24   Buy    $172.50    53.0       3.2% from BB Lower Unknown         $70.86       0.28%      1 days    
2023-05-26   Buy    $176.99    62.9       4.9% from BB Lower Unknown         $43.72       0.18%      4 days    
2023-05-31   Buy    $177.70    66.7       5.7% from BB Lower RSI_Overbought  $335.89      1.34%      1 days    
2023-06-02   Buy    $182.63    73.5       7.0% from BB Lower Unknown         $-418.48     -1.67%     3 days    
2023-06-06   Buy    $178.44    66.2       6.1% from BB Lower Unknown         $-86.70      -0.35%     1 days    
2023-06-08   Buy    $181.52    66.6       6.7% from BB Lower Unknown         $-76.92      -0.31%     1 days    
2023-06-12   Buy    $182.79    72.2       8.6% from BB Lower RSI_Overbought  $70.87       0.28%      1 days    
2023-06-14   Buy    $183.98    71.4       8.2% from BB Lower RSI_Overbought  $275.07      1.10%      1 days    
2023-06-16   Buy    $184.41    70.1       8.6% from BB Lower RSI_Overbought  $81.34       0.33%      4 days    
2023-06-21   Buy    $183.74    65.9       7.5% from BB Lower RSI_Overbought  $443.90      1.77%      1 days    
2023-06-23   Buy    $186.80    70.1       7.5% from BB Lower Unknown         $-205.83     -0.82%     3 days    
2023-06-27   Buy    $187.97    69.7       6.9% from BB Lower RSI_Overbought  $170.78      0.68%      1 days    
2023-06-29   Buy    $191.63    72.1       7.1% from BB Lower RSI_Overbought  $306.76      1.22%      1 days    
2023-07-03   Buy    $191.57    72.3       8.9% from BB Lower Unknown         $-31.57      -0.13%     2 days    
2023-07-06   Buy    $191.40    69.2       7.7% from BB Lower Unknown         $-94.76      -0.38%     1 days    
2023-07-10   Buy    $189.16    58.5       4.5% from BB Lower Unknown         $-143.69     -0.57%     1 days    
2023-07-12   Buy    $190.50    60.6       4.3% from BB Lower Unknown         $5.28        0.02%      1 days    
2023-07-14   Buy    $191.90    62.5       4.1% from BB Lower Unknown         $273.71      1.09%      3 days    
2023-07-18   Buy    $193.10    67.8       5.4% from BB Lower RSI_Overbought  $261.01      1.04%      1 days    
2023-07-20   Buy    $194.10    63.0       4.3% from BB Lower Unknown         $-281.16     -1.11%     1 days    
2023-07-24   Buy    $193.39    60.9       3.5% from BB Lower Unknown         $29.96       0.12%      1 days    
2023-07-26   Buy    $196.05    64.6       3.6% from BB Lower Unknown         $-363.80     -1.44%     1 days    
2023-07-28   Buy    $196.09    65.4       4.1% from BB Lower Unknown         $46.10       0.18%      3 days    
2023-08-01   Buy    $195.04    63.5       4.1% from BB Lower Unknown         $-316.88     -1.26%     1 days    
2023-08-03   Buy    $185.52    49.8       1.7% from BB Lower SMA_Breakdown   $-476.53     -1.90%     1 days    
2023-08-07   Buy    $179.70    29.5       -2.3% from BB Lower SMA_Breakdown   $13.87       0.06%      1 days    
2023-08-09   Buy    $179.47    30.0       -0.6% from BB Lower SMA_Breakdown   $-208.35     -0.84%     1 days    
2023-08-11   Buy    $177.92    29.5       1.3% from BB Lower SMA_Breakdown   $215.32      0.87%      3 days    
2023-08-15   Buy    $177.13    31.6       2.6% from BB Lower SMA_Breakdown   $-78.82      -0.32%     1 days    
2023-08-17   Buy    $172.30    27.2       2.4% from BB Lower SMA_Breakdown   $316.62      1.27%      1 days    
2023-08-21   Buy    $177.06    33.0       4.9% from BB Lower SMA_Breakdown   $23.99       0.10%      1 days    
2023-08-23   Buy    $180.73    47.0       8.3% from BB Lower SMA_Breakdown   $-601.62     -2.41%     1 days    
2023-08-25   Buy    $180.09    43.9       6.6% from BB Lower SMA_Breakdown   $13.80       0.06%      3 days    
2023-08-29   Buy    $184.81    54.1       8.1% from BB Lower Unknown         $381.85      1.54%      1 days    
2023-08-31   Buy    $189.57    59.7       9.3% from BB Lower Unknown         $-14.47      -0.06%     1 days    
2023-09-06   Buy    $175.19    48.9       7.2% from BB Lower SMA_Breakdown   $337.40      1.35%      1 days    
2023-09-08   Buy    $180.08    42.4       4.4% from BB Lower SMA_Breakdown   $-100.05     -0.40%     3 days    
2023-09-12   Buy    $176.50    40.4       3.4% from BB Lower SMA_Breakdown   $-324.36     -1.30%     1 days    
2023-09-14   Buy    $176.41    40.8       3.4% from BB Lower SMA_Breakdown   $-197.76     -0.79%     1 days    
2023-09-18   Buy    $177.52    45.6       4.4% from BB Lower SMA_Breakdown   $217.14      0.87%      1 days    
2023-09-20   Buy    $174.55    42.1       2.8% from BB Lower SMA_Breakdown   $-88.53      -0.36%     1 days    
2023-09-22   Buy    $174.20    41.7       3.0% from BB Lower SMA_Breakdown   $268.74      1.08%      3 days    
2023-09-26   Buy    $172.62    38.4       2.1% from BB Lower SMA_Breakdown   $-316.77     -1.27%     1 days    
2023-09-28   Buy    $172.02    37.0       2.3% from BB Lower SMA_Breakdown   $-117.20     -0.47%     1 days    
2023-10-02   Buy    $172.29    44.0       3.7% from BB Lower SMA_Breakdown   $15.87       0.06%      1 days    
2023-10-04   Buy    $173.74    44.6       2.4% from BB Lower SMA_Breakdown   $167.44      0.67%      1 days    
2023-10-06   Buy    $176.80    52.6       4.6% from BB Lower SMA_Breakdown   $308.51      1.24%      3 days    
2023-10-10   Buy    $178.25    54.0       5.2% from BB Lower Unknown         $217.24      0.87%      1 days    
2023-10-12   Buy    $181.39    58.4       6.8% from BB Lower Unknown         $-350.60     -1.40%     1 days    
2023-10-16   Buy    $176.67    53.4       5.6% from BB Lower SMA_Breakdown   $67.79       0.27%      1 days    
2023-10-18   Buy    $176.00    46.6       3.9% from BB Lower SMA_Breakdown   $-76.60      -0.31%     1 days    
2023-10-20   Buy    $170.91    40.3       2.2% from BB Lower SMA_Breakdown   $305.08      1.22%      3 days    
2023-10-24   Buy    $171.88    42.0       2.5% from BB Lower SMA_Breakdown   $-113.56     -0.45%     1 days    
2023-10-26   Buy    $166.91    30.3       -0.9% from BB Lower SMA_Breakdown   $196.18      0.78%      1 days    
2023-10-30   Buy    $169.27    40.3       1.8% from BB Lower SMA_Breakdown   $221.93      0.89%      1 days    
2023-11-01   Buy    $175.52    49.5       4.1% from BB Lower Unknown         $293.16      1.17%      1 days    
2023-11-03   Buy    $176.36    54.5       5.7% from BB Lower Unknown         $409.66      1.63%      3 days    
2023-11-07   Buy    $182.41    63.2       9.0% from BB Lower Unknown         $66.51       0.26%      1 days    
2023-11-09   Buy    $183.97    63.5       9.6% from BB Lower Unknown         $334.08      1.32%      1 days    
2023-11-13   Buy    $187.69    64.8       11.8% from BB Lower Unknown         $-33.80      -0.13%     1 days    
2023-11-24   Buy    $189.91    67.0       13.2% from BB Lower Unknown         $-16.03      -0.06%     3 days    
2023-11-28   Buy    $190.91    67.5       10.4% from BB Lower Unknown         $-204.60     -0.81%     1 days    
2023-11-30   Buy    $190.33    65.0       7.2% from BB Lower Unknown         $121.02      0.48%      1 days    
2023-12-04   Buy    $190.21    60.9       4.8% from BB Lower Unknown         $427.68      1.69%      1 days    
2023-12-06   Buy    $193.63    64.6       4.9% from BB Lower Unknown         $84.12       0.33%      1 days    
2023-12-08   Buy    $193.22    70.0       5.6% from BB Lower Unknown         $-5.27       -0.02%     3 days    
2023-12-12   Buy    $195.08    64.7       4.2% from BB Lower Unknown         $376.00      1.48%      1 days    
2023-12-14   Buy    $197.53    69.7       6.1% from BB Lower Unknown         $5.18        0.02%      1 days    
2023-12-18   Buy    $196.15    62.6       4.7% from BB Lower Unknown         $102.96      0.40%      1 days    
2023-12-20   Buy    $196.13    58.2       4.0% from BB Lower Unknown         $-189.19     -0.74%     1 days    
2023-12-22   Buy    $193.61    54.6       3.0% from BB Lower Unknown         $-73.88      -0.29%     4 days    
2023-12-27   Buy    $194.09    53.3       2.3% from BB Lower Unknown         $-67.07      -0.26%     1 days    
2023-12-29   Buy    $187.17    51.1       1.4% from BB Lower SMA_Breakdown   $-208.51     -0.82%     4 days    
2024-01-03   Buy    $182.17    33.2       -1.4% from BB Lower SMA_Breakdown   $-36.33      -0.14%     1 days    
2024-01-05   Buy    $182.15    28.8       -0.8% from BB Lower SMA_Breakdown   $476.38      1.87%      3 days    
2024-01-09   Buy    $184.31    40.6       2.3% from BB Lower SMA_Breakdown   $260.77      1.02%      1 days    
2024-01-11   Buy    $186.05    42.1       3.3% from BB Lower SMA_Breakdown   $-17.91      -0.07%     1 days    
2024-01-16   Buy    $181.33    38.5       2.6% from BB Lower SMA_Breakdown   $190.79      0.74%      1 days    
2024-01-18   Buy    $189.40    51.6       5.6% from BB Lower Unknown         $292.80      1.14%      1 days    
2024-01-22   Buy    $195.01    60.7       8.2% from BB Lower Unknown         $22.45       0.09%      1 days    
2024-01-24   Buy    $195.22    60.9       8.7% from BB Lower Unknown         $-138.51     -0.54%     1 days    
2024-01-26   Buy    $192.01    55.6       7.5% from BB Lower Unknown         $-37.50      -0.15%     3 days    
2024-01-30   Buy    $187.13    45.9       5.0% from BB Lower SMA_Breakdown   $-375.06     -1.46%     1 days    
2024-02-01   Buy    $179.87    45.1       4.3% from BB Lower SMA_Breakdown   $851.60      3.32%      1 days    
2024-02-05   Buy    $186.90    47.3       3.9% from BB Lower SMA_Breakdown   $331.66      1.28%      1 days    
2024-02-07   Buy    $189.35    50.8       4.4% from BB Lower SMA_Breakdown   $-140.95     -0.54%     1 days    
2024-02-09   Buy    $188.44    49.7       3.8% from BB Lower SMA_Breakdown   $-177.14     -0.68%     3 days    
2024-02-13   Buy    $185.32    41.7       1.5% from BB Lower SMA_Breakdown   $-163.08     -0.63%     1 days    
2024-02-15   Buy    $183.42    39.5       1.0% from BB Lower SMA_Breakdown   $-156.08     -0.61%     1 days    
2024-02-20   Buy    $181.94    35.2       0.7% from BB Lower SMA_Breakdown   $53.78       0.21%      1 days    
2024-02-22   Buy    $185.01    44.1       2.4% from BB Lower SMA_Breakdown   $-346.76     -1.35%     1 days    
2024-02-26   Buy    $181.09    37.4       0.7% from BB Lower SMA_Breakdown   $218.37      0.85%      1 days    
2024-02-28   Buy    $181.26    39.4       1.1% from BB Lower SMA_Breakdown   $-72.40      -0.28%     1 days    
2024-03-01   Buy    $176.14    35.9       0.7% from BB Lower SMA_Breakdown   $-151.83     -0.59%     3 days    
2024-03-05   Buy    $171.11    23.1       -2.1% from BB Lower SMA_Breakdown   $-298.62     -1.16%     1 days    
2024-03-07   Buy    $168.98    22.0       -0.3% from BB Lower SMA_Breakdown   $265.14      1.04%      1 days    
2024-03-11   Buy    $173.19    34.0       2.9% from BB Lower SMA_Breakdown   $5.93        0.02%      1 days    
2024-03-13   Buy    $172.91    32.1       2.6% from BB Lower SMA_Breakdown   $13.36       0.05%      1 days    
2024-03-15   Buy    $175.57    37.0       3.9% from BB Lower SMA_Breakdown   $-270.52     -1.05%     3 days    
2024-03-19   Buy    $175.72    46.5       6.1% from BB Lower SMA_Breakdown   $429.87      1.68%      1 days    
2024-03-21   Buy    $171.69    39.2       3.2% from BB Lower SMA_Breakdown   $88.36       0.34%      1 days    
2024-03-25   Buy    $170.02    39.1       3.0% from BB Lower SMA_Breakdown   $-46.92      -0.18%     1 days    
2024-03-27   Buy    $171.71    45.4       4.0% from BB Lower SMA_Breakdown   $-34.46      -0.13%     1 days    
2024-04-01   Buy    $169.08    40.2       1.5% from BB Lower SMA_Breakdown   $-36.50      -0.14%     1 days    
2024-04-03   Buy    $170.33    40.3       1.5% from BB Lower SMA_Breakdown   $-227.88     -0.89%     1 days    
2024-04-05   Buy    $169.03    40.9       1.5% from BB Lower SMA_Breakdown   $-88.01      -0.34%     3 days    
2024-04-09   Buy    $168.80    42.2       1.9% from BB Lower SMA_Breakdown   $-154.85     -0.60%     1 days    
2024-04-11   Buy    $174.26    54.4       5.4% from BB Lower SMA_Breakdown   $336.26      1.31%      1 days    
2024-04-15   Buy    $171.75    49.5       4.1% from BB Lower SMA_Breakdown   $-354.25     -1.38%     1 days    
2024-04-17   Buy    $168.07    42.2       1.6% from BB Lower SMA_Breakdown   $-156.79     -0.61%     1 days    
2024-04-19   Buy    $165.57    37.9       0.1% from BB Lower SMA_Breakdown   $41.66       0.16%      3 days    
2024-04-23   Buy    $166.54    42.2       1.8% from BB Lower SMA_Breakdown   $380.54      1.49%      1 days    
2024-04-25   Buy    $169.83    48.5       3.6% from BB Lower SMA_Breakdown   $-80.05      -0.31%     1 days    
2024-04-29   Buy    $173.20    55.5       5.9% from BB Lower SMA_Breakdown   $-424.70     -1.66%     1 days    
2024-05-01   Buy    $172.43    47.4       3.3% from BB Lower Unknown         $88.81       0.35%      1 days    
2024-05-22   Buy    $190.98    69.5       14.9% from BB Lower Unknown         $-548.42     -2.15%     1 days    
2024-05-24   Buy    $191.51    63.7       11.8% from BB Lower Unknown         $-201.67     -0.79%     4 days    
2024-05-29   Buy    $190.78    64.1       9.4% from BB Lower Unknown         $67.79       0.27%      1 days    
2024-05-31   Buy    $193.01    67.0       6.4% from BB Lower Unknown         $134.10      0.53%      3 days    
2024-06-04   Buy    $195.44    70.0       6.8% from BB Lower RSI_Overbought  $55.90       0.22%      1 days    
2024-06-06   Buy    $194.65    67.5       5.9% from BB Lower RSI_Overbought  $292.56      1.15%      1 days    
2024-06-10   Buy    $193.69    60.2       4.0% from BB Lower RSI_Overbought  $1771.77     6.95%      1 days    
2024-06-21   Buy    $207.67    61.6       15.1% from BB Lower Unknown         $58.70       0.23%      3 days    
2024-06-25   Buy    $211.50    63.3       14.0% from BB Lower Unknown         $214.75      0.83%      1 days    
2024-06-27   Buy    $215.79    68.1       14.7% from BB Lower Unknown         $-623.09     -2.40%     1 days    
2024-07-01   Buy    $216.15    67.5       14.0% from BB Lower RSI_Overbought  $492.75      1.91%      1 days    
2024-07-11   Buy    $228.92    68.6       12.6% from BB Lower RSI_Overbought  $183.81      0.71%      1 days    
2024-07-17   Buy    $230.14    63.6       13.2% from BB Lower Unknown         $-673.86     -2.59%     1 days    
2024-07-19   Buy    $226.99    57.1       9.7% from BB Lower Unknown         $-345.09     -1.33%     3 days    
2024-07-23   Buy    $224.06    57.8       7.8% from BB Lower Unknown         $-634.77     -2.46%     1 days    
2024-07-25   Buy    $218.69    47.4       2.9% from BB Lower Unknown         $-85.48      -0.33%     1 days    
2024-07-29   Buy    $219.20    48.5       2.0% from BB Lower Unknown         $-46.69      -0.18%     1 days    
2024-07-31   Buy    $224.37    54.3       3.6% from BB Lower Unknown         $-685.03     -2.68%     1 days    
2024-08-02   Buy    $199.09    50.8       3.0% from BB Lower SMA_Breakdown   $1298.92     5.11%      3 days    
2024-08-06   Buy    $206.94    36.1       -0.4% from BB Lower SMA_Breakdown   $358.05      1.39%      1 days    
2024-08-08   Buy    $212.10    45.2       3.6% from BB Lower Unknown         $503.93      1.95%      1 days    
2024-08-12   Buy    $219.06    50.8       5.4% from BB Lower Unknown         $261.73      1.01%      1 days    
2024-08-14   Buy    $224.49    55.8       6.4% from BB Lower Unknown         $26.65       0.10%      1 days    
2024-08-16   Buy    $225.67    60.7       8.6% from BB Lower Unknown         $25.36       0.10%      3 days    
2024-08-20   Buy    $226.51    61.2       9.0% from BB Lower Unknown         $-12.64      -0.05%     1 days    
2024-08-22   Buy    $225.79    57.2       8.0% from BB Lower Unknown         $120.99      0.47%      1 days    
2024-08-26   Buy    $226.00    60.9       9.3% from BB Lower Unknown         $233.98      0.90%      1 days    
2024-08-28   Buy    $230.10    58.6       8.9% from BB Lower Unknown         $-35.17      -0.13%     1 days    
2024-08-30   Buy    $228.55    61.6       10.1% from BB Lower Unknown         $-660.02     -2.53%     4 days    
2024-09-04   Buy    $221.73    46.3       3.8% from BB Lower SMA_Breakdown   $76.02       0.29%      1 days    
2024-09-06   Buy    $220.83    46.4       1.7% from BB Lower SMA_Breakdown   $9.40        0.04%      3 days    
2024-09-10   Buy    $221.49    45.2       0.6% from BB Lower SMA_Breakdown   $137.10      0.53%      1 days    
2024-09-12   Buy    $223.61    50.5       1.7% from BB Lower SMA_Breakdown   $-129.01     -0.50%     1 days    
2024-09-16   Buy    $215.75    39.1       -0.5% from BB Lower SMA_Breakdown   $125.12      0.48%      1 days    
2024-09-18   Buy    $225.00    48.3       2.2% from BB Lower Unknown         $446.99      1.72%      1 days    
2024-09-20   Buy    $227.34    59.2       5.8% from BB Lower Unknown         $-99.88      -0.38%     3 days    
2024-09-24   Buy    $225.01    57.3       5.4% from BB Lower Unknown         $157.60      0.60%      1 days    
2024-09-26   Buy    $228.48    57.2       5.4% from BB Lower Unknown         $-78.86      -0.30%     1 days    
2024-09-30   Buy    $229.52    64.9       8.2% from BB Lower Unknown         $-376.32     -1.44%     1 days    
2024-10-02   Buy    $225.14    53.1       5.1% from BB Lower Unknown         $61.21       0.24%      1 days    
2024-10-04   Buy    $224.49    53.0       4.8% from BB Lower SMA_Breakdown   $-324.49     -1.25%     3 days    
2024-10-08   Buy    $225.31    51.3       4.0% from BB Lower Unknown         $486.90      1.88%      1 days    
2024-10-10   Buy    $229.49    55.5       5.3% from BB Lower Unknown         $-220.27     -0.85%     1 days    
2024-10-14   Buy    $233.60    58.1       5.3% from BB Lower Unknown         $27.83       0.11%      1 days    
2024-10-16   Buy    $233.43    57.5       4.1% from BB Lower Unknown         $-142.61     -0.55%     1 days    
2024-10-18   Buy    $234.50    61.6       5.8% from BB Lower Unknown         $219.30      0.84%      3 days    
2024-10-22   Buy    $234.13    62.1       6.4% from BB Lower Unknown         $-374.63     -1.44%     1 days    
2024-10-24   Buy    $229.74    52.3       3.7% from BB Lower Unknown         $188.51      0.73%      1 days    
2024-10-28   Buy    $233.26    56.7       4.9% from BB Lower Unknown         $45.67       0.18%      1 days    
2024-10-30   Buy    $229.51    50.2       3.1% from BB Lower SMA_Breakdown   $-407.70     -1.57%     1 days    
2024-11-01   Buy    $220.93    39.4       0.2% from BB Lower SMA_Breakdown   $126.56      0.49%      3 days    
2024-11-05   Buy    $222.58    41.3       0.6% from BB Lower SMA_Breakdown   $16.30       0.06%      1 days    
2024-11-07   Buy    $227.17    49.3       2.9% from BB Lower Unknown         $-23.97      -0.09%     1 days    
2024-11-11   Buy    $224.43    44.1       1.8% from BB Lower SMA_Breakdown   $-23.10      -0.09%     1 days    
2024-11-13   Buy    $225.11    45.9       2.6% from BB Lower Unknown         $358.02      1.38%      1 days    
2024-11-15   Buy    $225.22    46.2       2.6% from BB Lower Unknown         $323.29      1.24%      3 days    
2024-11-19   Buy    $228.06    52.0       3.6% from BB Lower Unknown         $107.51      0.41%      1 days    
2024-11-21   Buy    $228.21    52.3       3.7% from BB Lower Unknown         $189.93      0.73%      1 days    
2024-11-25   Buy    $233.35    60.0       5.6% from BB Lower Unknown         $191.69      0.73%      1 days    
2024-11-27   Buy    $234.84    62.9       6.9% from BB Lower Unknown         $277.87      1.06%      2 days    
2024-12-02   Buy    $239.82    69.4       9.4% from BB Lower RSI_Overbought  $310.07      1.18%      1 days    
2024-12-05   Buy    $242.91    73.2       10.9% from BB Lower RSI_Overbought  $-7.59       -0.03%     1 days    
2024-12-11   Buy    $246.89    73.7       11.7% from BB Lower RSI_Overbought  $114.21      0.43%      1 days    
2024-12-13   Buy    $247.99    75.5       11.6% from BB Lower RSI_Overbought  $324.45      1.23%      3 days    
2024-12-18   Buy    $247.50    64.9       9.5% from BB Lower Unknown         $244.84      0.93%      1 days    
2024-12-20   Buy    $254.77    72.3       10.5% from BB Lower RSI_Overbought  $52.05       0.20%      3 days    
2024-12-24   Buy    $258.19    75.7       10.6% from BB Lower RSI_Overbought  $85.30       0.32%      2 days    
2024-12-27   Buy    $252.22    67.6       8.0% from BB Lower Unknown         $-2.11       -0.01%     3 days    
2024-12-31   Buy    $248.93    56.7       4.4% from BB Lower Unknown         $-541.95     -2.04%     2 days    
2025-01-03   Buy    $244.36    45.3       1.3% from BB Lower Unknown         $69.20       0.26%      3 days    
2025-01-07   Buy    $241.92    44.0       0.7% from BB Lower Unknown         $85.24       0.32%      1 days    
2025-01-10   Buy    $233.65    37.3       -0.4% from BB Lower SMA_Breakdown   $84.93       0.32%      3 days    
2025-01-14   Buy    $234.73    33.5       0.0% from BB Lower SMA_Breakdown   $354.24      1.34%      1 days    
2025-01-16   Buy    $232.12    32.6       -0.3% from BB Lower SMA_Breakdown   $-244.95     -0.92%     1 days    
2025-01-21   Buy    $219.75    29.7       -0.2% from BB Lower SMA_Breakdown   $492.17      1.86%      1 days    
2025-01-23   Buy    $224.78    31.5       2.6% from BB Lower SMA_Breakdown   $-236.95     -0.89%     1 days    
2025-01-27   Buy    $230.84    42.2       6.4% from BB Lower SMA_Breakdown   $854.12      3.21%      1 days    
2025-01-29   Buy    $238.67    53.4       9.6% from BB Lower SMA_Breakdown   $-121.21     -0.45%     1 days    
2025-01-31   Buy    $229.99    49.4       7.3% from BB Lower SMA_Breakdown   $-230.34     -0.86%     3 days    
2025-02-04   Buy    $228.53    46.9       5.9% from BB Lower SMA_Breakdown   $460.29      1.72%      1 days    
2025-02-06   Buy    $232.54    47.4       5.7% from BB Lower SMA_Breakdown   $-566.14     -2.11%     1 days    
2025-02-10   Buy    $228.20    41.7       3.2% from BB Lower SMA_Breakdown   $516.59      1.94%      1 days    
2025-02-12   Buy    $236.91    53.0       7.5% from BB Lower Unknown         $522.64      1.95%      1 days    
2025-02-19   Buy    $244.94    60.7       11.2% from BB Lower Unknown         $97.86       0.36%      1 days    
2025-02-21   Buy    $245.00    61.2       10.3% from BB Lower Unknown         $231.05      0.86%      3 days    
2025-02-25   Buy    $244.38    62.8       9.8% from BB Lower SMA_Breakdown   $-444.36     -1.64%     1 days    
2025-02-27   Buy    $236.98    47.3       5.4% from BB Lower Unknown         $551.71      2.05%      1 days    
2025-03-03   Buy    $237.71    48.3       5.6% from BB Lower SMA_Breakdown   $-202.48     -0.75%     1 days    
2025-03-05   Buy    $234.44    45.5       3.9% from BB Lower SMA_Breakdown   $102.46      0.38%      1 days    
2025-03-07   Buy    $235.54    50.7       4.9% from BB Lower SMA_Breakdown   $-924.44     -3.42%     3 days    
2025-03-11   Buy    $220.14    32.5       -2.2% from BB Lower SMA_Breakdown   $-384.47     -1.44%     1 days    
2025-03-13   Buy    $211.25    25.8       -3.2% from BB Lower SMA_Breakdown   $282.99      1.06%      1 days    
2025-03-17   Buy    $214.15    31.9       2.0% from BB Lower SMA_Breakdown   $-182.43     -0.68%     1 days    
2025-03-19   Buy    $213.92    34.8       4.9% from BB Lower SMA_Breakdown   $22.48       0.08%      1 days    
2025-03-21   Buy    $221.00    40.0       7.6% from BB Lower SMA_Breakdown   $-32.64      -0.12%     3 days    
2025-03-25   Buy    $223.51    47.1       9.8% from BB Lower SMA_Breakdown   $-236.62     -0.89%     1 days    
2025-03-27   Buy    $221.73    47.7       9.7% from BB Lower SMA_Breakdown   $-460.36     -1.73%     1 days    
2025-03-31   Buy    $219.87    46.8       8.3% from BB Lower SMA_Breakdown   $400.69      1.51%      1 days    
2025-04-02   Buy    $205.53    49.0       8.5% from BB Lower SMA_Breakdown   $-303.26     -1.14%     1 days    
2025-04-04   Buy    $177.21    25.2       -5.5% from BB Lower SMA_Breakdown   $637.00      2.40%      3 days    
2025-04-08   Buy    $172.06    20.0       -5.9% from BB Lower SMA_Breakdown   $4160.32     15.57%     1 days    
2025-04-10   Buy    $186.10    38.3       6.0% from BB Lower SMA_Breakdown   $1797.46     6.48%      1 days    
2025-04-14   Buy    $201.76    45.7       13.9% from BB Lower SMA_Breakdown   $53.13       0.19%      1 days    
2025-04-16   Buy    $197.02    41.6       10.5% from BB Lower SMA_Breakdown   $-5.73       -0.02%     1 days    
--------------------------------------------------------------------------------------------------------------
Total Trades: 222
Win Rate: 55.4%

Exit Reason Analysis:
  RSI_Overbought: 19.0 trades, Average Profit: $295.84, Total Profit: $5620.91, Average Return: 1.2%, Average Duration: 1.4 days
  SMA_Breakdown: 106.0 trades, Average Profit: $64.34, Total Profit: $6820.07, Average Return: 0.2%, Average Duration: 1.4 days
  Unknown: 97.0 trades, Average Profit: $4.57, Total Profit: $443.65, Average Return: 0.0%, Average Duration: 1.5 days

==================================================
              PERFORMANCE STATISTICS              
==================================================
Backtest Period: 2023-04-19 to 2025-04-17
Total Days: 729 (2.00 years)

Benchmark Annual Return: 13.37%
Strategy Annual Return: 6.19%
Alpha (annualized): 2.73%
Beta: 0.13

Total Return: 12.88%
Annualized Return: 6.26% (arithmetic)
Geometric Mean Annual Return: 4.28%
Volatility (annualized): 4.42%
Downside Risk (annualized): 1.88%
Sharpe Ratio: 0.95
Sortino Ratio: 2.23

Total Trades: 222
Average Trades per Year: 111.23
Average Return per Trade: 0.22%
Average Profit per Trade: $58.04
Maximum Drawdown: -2.37%
Calmar Ratio: 2.64

Note: Alpha &amp; Beta calculations require benchmark data. Call this function with a benchmark returns series for complete metrics.

Strategy analysis completed!</code></pre>
</div>
</div>
<div id="c3a130a20f2373bf" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="365051fcea6c45af" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="dbe1ad1a9d5161ac" class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="dc0a40e14f63ec6e" class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="dd566b55f87f0120" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2025-04-21T00:32:11.206990Z&quot;,&quot;start_time&quot;:&quot;2025-04-21T00:32:11.203764Z&quot;}">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d24c8ed502ac8486" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2025-04-30T03:07:34.308463Z&quot;,&quot;start_time&quot;:&quot;2025-04-30T03:07:34.305936Z&quot;}">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f40e94c54771f3d5" class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="409ea82d421a3b1a" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>